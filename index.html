<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>LispCast</title>
    <meta name="description" content="A blog about the simple joys of functional programming.">
    <meta name="author" content="Eric Normand">

    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="/css/styles.css" type="text/css">

    <link rel="alternate" type="application/rss+xml" title="LispCast" href="/feed" />

<!-- start Mixpanel --><script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
mixpanel.init("ffad2bd88d2cb690edbbba6cf30b2958");</script><!-- end Mixpanel -->
  </head>

  <body>
    <header class="banner">
      <h1 class="banner-logo">
        <a href="/">
          <img class="banner-logo-img"
               src="/img/Logo@2x.png"
               alt="LispCast" />
        </a>
      </h1>

      <div class="meta-data">
        <img class="bio-img"
             src="/img/eric_bio.jpg" />
        <a class="twitter-link"
           href="http://twitter.com/ericnormand">
          <i class="fa fa-twitter"></i>
        </a>
        <a class="github-link"
           href="https://github.com/ericnormand">
          <i class="fa fa-github"></i>
        </a>
        <a class="mail-link"
           href="mailto:eric@lispcast.com">
          <i class="fa fa-envelope"></i>
        </a>
        <a class="rss-link"
           href="/feed">
          <i class="fa fa-rss-square"></i>
        </a>
        <a class="rss-link"
           href="/archive.html">
          <i class="fa fa-list"></i>
        </a>
      </div>

    </header>

    <div class="main-container">


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/mastering-client-side-routing-with-secretary-and-goog-history">
              Mastering ClojureScript Routing with Secretary and goog.History
            </a>
          </h2>

          <div class="timestamp">
            June 24, 2015
          </div>

          
<p>Summary: <em>The Google Closure Library provides a nice interface to the HTML5 History API. Coupling it with Secretary is very easy. But not all browsers support HTML5 History. In this post I'll talk about one way to make sure you have client-side routing in all browsers.</em></p>
<h3 id="background">Background</h3>
<p><em>About a year ago I was working for a company of three people. Two coders and one business person. I was developing a consumer product and the other programmer was building a related B2B product. We were as agile as could be: no planning meetings, no prioritized list of features, just a shared vision. I was working in Clojure and ClojureScript and getting paid to do it.</em></p>
<p><em>That job eventually disappeared. But the amount of code I produced and the dark corners of features I explored still surprises me. I discovered (uncovered?) a lot of gems of ClojureScript in that time. This post is about one of them.</em></p>
<h3 id="browser-history">Browser History</h3>
<p>In a project I did about a year ago, we wanted the speed of a single page application but we wanted the back button to work and we wanted the URL to reflect where the reader was in the app. We turned to the <strong>HTML5 History API</strong>.</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/History">HTML5 History API</a> is an API for manipulating the browser's history without making a request to the server and loading a new page. The idea is that <strong>your Javascript application can keep all of its state in memory, but still change the URLs and keep the back button working</strong>. You have to code it up yourself, but it gives you fine-grained control over what exactly the back button does.</p>
<p>Luckily (and not surprisingly), the Google Closure Library has a nice way to access the History API. It's in a class called <a href="https://closure-library.googlecode.com/git-history/docs/class_goog_history_Html5History.html"><code>goog.history.Html5History</code></a>. That gives you <strong>events about when the URL changes</strong>. We used that along with <a href="https://github.com/gf3/secretary">Secretary</a> to parse, interpret, and dispatch on the URL.</p>
<h3 id="the-code">The code</h3>
<p>First, we set up our <code>ns</code> declaration.</p>
<pre><code>(ns history.core
  (:require
   [secretary.core :as secretary :refer-macros [defroute]]
   [goog.events]
   [goog.history.EventType :as EventType])
  (:import
   [goog.history Html5History]))</code></pre>
<p>We need a function that will get the current path fragment to switch on. We'll just use the path and the query string.</p>
<pre><code>(defn get-token []
  (str js/window.location.pathname js/window.location.search))</code></pre>
<p>Now we define how to instatiate the history object.</p>
<pre><code>(defn make-history []
  (doto (Html5History.)
    (.setPathPrefix (str js/window.location.protocol
                         &quot;//&quot;
                         js/window.location.host))
    (.setUseFragment false)))</code></pre>
<p>Let's make a couple of simple routes. I won't go into how to make routes with Secretary in this post.</p>
<pre><code>(defroute home-page &quot;/&quot; []
  (js/console.log &quot;Homepage!&quot;))

(defroute default-route &quot;*&quot; []
  (js/console.log (str &quot;unknown route: &quot; (get-token))))</code></pre>
<p>Now a handler for what to do when the URL changes.</p>
<pre><code>(defn handle-url-change [e]
  ;; log the event object to console for inspection
  (js/console.log e)
  ;; and let&#39;s see the token
  (js/console.log (str &quot;Navigating: &quot; (get-token)))
  ;; we are checking if this event is due to user action,
  ;; such as click a link, a back button, etc.
  ;; as opposed to programmatically setting the URL with the API
  (when-not (.-isNavigation e)
    ;; in this case, we&#39;re setting it
    (js/console.log &quot;Token set programmatically&quot;)
    ;; let&#39;s scroll to the top to simulate a navigation
    (js/window.scrollTo 0 0))
  ;; dispatch on the token
  (secretary/dispatch! (get-token)))</code></pre>
<p>Now we set up our global history object. We use <code>defonce</code> so we can <strong>hot reload the code</strong>.</p>
<pre><code>(defonce history (doto (make-history)
                   (goog.events/listen EventType/NAVIGATE
                                       ;; wrap in a fn to allow live reloading
                                       #(handle-url-change %))
                   (.setEnabled true)))</code></pre>
<p>And we will want a function to programmatically change the URL (and add to the history).</p>
<pre><code>(defn nav! [token]
  (.setToken history token))</code></pre>
<h3 id="om-example-link">Om example link</h3>
<p>Incidentally, my links look like this in Om:</p>
<pre><code>(dom/a
  #js {:href &quot;/some/page&quot;
       :onClick #(do
                   (.preventDefault %)
                   (nav! &quot;/some/page&quot;))}
  &quot;some page&quot;)</code></pre>
<p>That is, I try to follow the principle of graceful fallback. If Javascript fails for some reason, the <code>href</code> is still valid. It will make a request to the server and fetch the page. But if Javascript is working, we override it.</p>
<p>On the server side, I make sure that the same routes exist and that they return valid pages that include this script. When the page loads, the <code>EventType/NAVIGATE</code> event will fire, and so Secretary will route it. This usually means a repaint, but it's very quick and acceptable.</p>
<p>Add the requires:</p>
<pre><code>   [om.core :as om]
   [om.dom :as dom]</code></pre>
<p>And the Om code to render and get it started:</p>
<pre><code>(defonce state (atom {}))

(defn cmp-link [cursor owner]
  (reify
    om/IRender
    (render [_]
      (dom/a
       #js {:href &quot;/some/link&quot;
            :onClick #(do
                        (.preventDefault %)
                        (nav! &quot;/some/link&quot;))}
       &quot;some link&quot;))))

(om/root cmp-link state
         {:target (. js/document (getElementById &quot;app&quot;))})</code></pre>
<p>When you click the link, you should see a message in the console saying it's navigating to <code>/some/link</code>.</p>
<h3 id="a-hitch">A hitch</h3>
<p>I was using this for a while when I got a message about it not working for someone. After a little investigation, it turned out they were using an older version of IE. :( <strong>IE &lt;= 9 does not support HTML5 History.</strong> In fact, according to caniuse.com, <a href="http://caniuse.com/#feat=history">only 88.2% of users have a browser with HTML5 support</a>. That means that 12 out of every 100 visitors can't use what we just wrote.</p>
<p>What a lot of people would do at this point is just to use the hash-based history wrangling that <a href="http://caniuse.com/#search=hash">93% of the internet supports</a>. But I wanted to do better without punishing people who upgrade their browsers.</p>
<p>Here's what I did: the server still serves content at URLs as normal. The routes on the client stay the same. <em>But</em> I used feature detection to <strong>determine if the browser supports HTML5 History</strong>. If it does support it, it runs the code above. If it doesn't, it uses the hash API. Lucky for me, Google Closure has a class called <a href="https://closure-library.googlecode.com/git-history/docs/class_goog_History.html"><code>goog.History</code></a> that is interface-compatible with <code>goog.history.Html5History</code>. So 90% of the work was done.</p>
<p>First, we need to add this import:</p>
<pre><code>  [goog History]</code></pre>
<p><code>goog.history.Html5History</code> required a tiny little patch to work.</p>
<pre><code>;; Replace this method:
;;  https://closure-library.googlecode.com/git-history/docs/local_closure_goog_history_html5history.js.source.html#line237
(aset js/goog.history.Html5History.prototype &quot;getUrl_&quot;
      (fn [token]
        (this-as this
          (if (.-useFragment_ this)
            (str &quot;#&quot; token)
            (str (.-pathPrefix_ this) token)))))</code></pre>
<p>I was very reluctant to do that, but it was the only solution I found to making it work consistently with the query string. Unfortunately, it was done a year ago and I don't remember the exact reason.</p>
<p>Now we need to modify <code>get-token</code> so it works in both cases. In the case HTML5 History is not supported, the token is everything after the <code>#</code> if we're on <code>/</code>.</p>
<pre><code>(defn get-token []
  (if (Html5History.isSupported)
    (str js/window.location.pathname js/window.location.search)
    (if (= js/window.location.pathname &quot;/&quot;)
      (.substring js/window.location.hash 1)
      (str js/window.location.pathname js/window.location.search))))</code></pre>
<p><code>make-history</code> is different, too. If we don't support HTML5 History, we check if we're on <code>/</code>. If not, we redirect to <code>/</code> with the token. If we are, we construct an instance of <code>goog.History</code>.</p>
<pre><code>(defn make-history []
  (if (Html5History.isSupported)
    (doto (Html5History.)
      (.setPathPrefix (str js/window.location.protocol
                           &quot;//&quot;
                           js/window.location.host))
      (.setUseFragment false))
    (if (not= &quot;/&quot; js/window.location.pathname)
      (aset js/window &quot;location&quot; (str &quot;/#&quot; (get-token)))
      (History.))))</code></pre>
<p>Everything else is the same! You can even test out what happens without the HTML5 History API by replacing the <code>(Html5History.isSupported)</code> with <code>false</code> in both places in the code above. You'll see it start to use the <code>#</code> fragment when you click the link!</p>
<h3 id="conclusions">Conclusions</h3>
<p>I figured out all of this stuff incrementally by experimentation. I wanted to share this with you because I think it's valuable. The biggest lesson to take away is that <strong>the Google Closure Library is <em>very</em> complete and well-built</strong>. We should lean on it as much as we can from ClojureScript.</p>
<p>If you're interested in learning some ClojureScript, Om, and how to make Single Page Applications, I have to recommend my LispCast Single Page Applications with ClojureScript and Om course. It's interactive with lots of animations, exercises, screencasts, and code. It's designed to get you <strong>up and running with a smooth dev process all the way through deploying code to production</strong>. It won't teach you <em>everything</em> about ClojureScript and Om, but it will get you over lots of the major hurdles we all encounter.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get free Clojure stuff and news on ClojureScript courses
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/spaom-cover.jpg">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
The LispCast Single Page Applications with ClojureScript and Om course is in development <em>right now</em>! Sign up here to get news as it's being created and learn when it will launch. Also, you'll get to download all of the free stuff for learning and using Clojure.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][64]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/core-async-browser-motivation">core.async in Browsers</a></li>
<li><a href="http://www.lispcast.com/react-another-level-of-indirection">React: Another Level of Indirection</a></li>
<li><a href="http://www.lispcast.com/pre-conj-anna-pawlicka">Pre-conj Prep: Anna Pawlicka</a></li>
<li><a href="http://www.lispcast.com/pre-conj-interview-anna-pawlicka">Pre-Conj Interview: Anna Pawlicka</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/clojure-database-test-faster">
              How I made my Clojure database tests 5x faster
            </a>
          </h2>

          <div class="timestamp">
            June 17, 2015
          </div>

          
<p>Summary: <em>Setting up and tearing down a test database can be slow. Use a rolled back transaction to quickly reset the database to a known state. You can do that in an <code>:each</code> fixture to run each test in isolation.</em></p>
<p>On one of my projects, I wrote a bunch of tests that had to hit the database. There was a <code>:once</code> fixture to create all of the tables anew and an <code>:each</code> fixture to delete everything in the tables before each test. That ensured that <strong>I was always working with a known empty database</strong>. Overall, the tests took about 10 seconds. Woah! That's a long time. But I lived with it.</p>
<pre><code>(defn clear
  &quot;Delete all rows before and after, just for good measure.
  [test]
  (cleardb db) ;; delete all rows from all tables
  (try
    (test)
    (finally
      (cleardb db))))

(defn setupdb [tests]
  (initdb db) ;; create the tables
  (try
    (tests)
    (finally
      (teardown db)))) ;; drop the tables

(use-fixtures :each clear)
(use-fixtures :once setupdb)</code></pre>
<p>Then I remembered a technique someone once mentioned where you <strong>use a transaction that you roll back</strong> instead of starting with a fresh db each time. It's supposed to be a lot faster.</p>
<p>After a little experimentation, I came up with this:</p>
<pre><code>(defn clear [test]
  (sql/with-db-transaction [db db]
    (sql/db-set-rollback-only! db)
    (binding [db db] ;; rebind dynamic var db, used in tests
      (test))))</code></pre>
<p>We open a transaction, immediately set it to rollback (which it will do when the transaction closes). Then we have to rebind our dynamic <code>db</code> var, which holds the current connection. And inside of that we run the test. Inside of the transaction, anything you write to the database will be available to read. When the test ends, <strong>the transaction closes and it rolls back all of the changes</strong>, leaving the database empty again.</p>
<p>The result? Running the tests went <strong>from 10 seconds to 2 seconds</strong>. They still start and end with a clean database, but it's done faster with a transaction.</p>
<p>The one gotcha that I ran into was that the PostgreSQL function <strong><code>now()</code> was always returning the same time within the transaction</strong>. I had made an assumption (that was true before) that different calls would happen at different times. That assumption was no longer true inside the transaction. I had to fix the code to not rely on time.</p>
<p>The other part of this technique, which I did not really have to use, was that <strong>you can set up your database with test data</strong> in the <code>:once</code> fixture. It's costly to set up the test data, but because you're rolling back transactions, once it's set up it's quick to reset it.</p>
<p>If you'd like to <strong>learn more about testing in Clojure</strong>, you might be interested in my <a href="http://www.purelyfunctional.tv/intro-to-clojure-test">LispCast Intro to clojure.test</a>. In it, we cover test namespaces, assertions, running your tests, and of course fixtures. It's an interactive course with exercises, screencasts, animations, and code. You should also check out the free cheatsheet below.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    <h3 class="subscribe-form-title">
      
Get a Free clojure.test Cheatsheet
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/clojure.test cheatsheet.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of the clojure.test cheatsheet. If you write Clojure or ClojureScript, this cheatsheet contains the most important functions in a handy format. I've spent a lot of time formatting and annotating the most used functions and macros from clojure.test so that they fit onto one page and everything is easy to understand.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][32]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/announcing-lispcast-intro-to-clojure-test">Announcing: LispCast Intro to clojure.test</a></li>
<li><a href="http://www.lispcast.com/clojure-test-cheatsheet">clojure.test cheatsheet</a></li>
<li><a href="http://www.lispcast.com/clojure-test-directory">Clojure Test Directory</a></li>
<li><a href="http://www.lispcast.com/clojure-test-launch">LispCast Intro to clojure.test</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/tdd-workflow-in-clojure-with-emacs-and-cider">
              TDD Workflow in Clojure using Emacs with CIDER
            </a>
          </h2>

          <div class="timestamp">
            June 08, 2015
          </div>

          
<p>Summary: <em>TDD is about fast feedback. CIDER tightens the feedback loop with quick commands for running tests and a powerful test reporting system.</em></p>
<h3 id="introduction">Introduction</h3>
<p>I've always been into flow. One of the key aspects of flow is a short feedback loop. Test Driven Development (TDD) is partially based on flow, too. You write a new test, then you write code to satisfy the test, then you refactor. You cycle quickly with very small steps. Great for flow!</p>
<p>Now, I'm not going to be a pedant in this post about what is and what is not TDD. Sometimes I like to adhere to a strict discipline of TDD. And sometimes I like to code fast and loose. But as a working definition, for the purposes of this article, I'll define TDD as writing code and tests incrementally, and running the tests fairly often. <strong>The last thing you want is to have to wait for those tests to run.</strong></p>
<p>Luckily, CIDER<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup> has been optimized to make the whole process smooth, fast, and feedbacky. You can learn about installing CIDER <a href="https://github.com/clojure-emacs/cider/wiki/Installation">here</a>. Or <script type="text/javascript">
<!--
h='&#108;&#x69;&#x73;&#112;&#x63;&#x61;&#x73;&#116;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#x65;&#114;&#x69;&#x63;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+'ask me any time for help'+'<\/'+'a'+'>');
// -->
</script><noscript>&#x61;&#x73;&#x6b;&#32;&#x6d;&#x65;&#32;&#x61;&#110;&#x79;&#32;&#116;&#x69;&#x6d;&#x65;&#32;&#102;&#x6f;&#114;&#32;&#104;&#x65;&#108;&#112;&#32;&#40;&#x65;&#114;&#x69;&#x63;&#32;&#x61;&#116;&#32;&#108;&#x69;&#x73;&#112;&#x63;&#x61;&#x73;&#116;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;&#x29;</noscript> if you run into trouble.</p>
<h3 id="what-you-need-to-know">What you need to know</h3>
<p>First, you'll need CIDER connected to the REPL (usually just <code>C-c M-j</code>).</p>
<p>Besides the basic commands for switching buffers (<code>C-c b</code>), I use just one command a ton while I'm TDD'ing:</p>
<ul>
<li><code>C-c ,</code> (That's Control-c comma.) While you're in a buffer, it will run the tests for that buffer. It could be that you're in production code, in which case it will try to find the <a href="http://www.lispcast.com/clojure-test-directory">corresponding test namespace</a> and run tests there.</li>
</ul>
<p>That will give you just the feedback you need: a green status report in the status bar if everything passes. And a new buffer with a <strong>failure and error report</strong> if it's not passing. You can do some cool stuff in that buffer, like jumping to the test definition, rerunning individual tests, and seeing diffs of actual vs. expected output. Look <a href="https://github.com/clojure-emacs/cider#cider-test-report-mode">here</a> for a quick reference to the available key bindings.</p>
<p>But mostly I'm editing code, compiling it (with <code>C-c C-k</code>), and running the tests (<code>C-c ,</code>) to make sure they pass now. Unlike with running <code>lein test</code> at the command line, this command <strong>only runs the tests for that specific namespace</strong>. This is usually what you want while you're editing code in the namespace. After you're done, you'll want to rerun all of the tests in a fresh JVM at the command line.</p>
<h3 id="conclusions">Conclusions</h3>
<p>Getting a productive workflow set up is really important. It's hard on our nerves to be waiting through long feedback cycles. <strong>CIDER tightens those loops</strong> down to human scale so we can focus on the work of making the world better.</p>
<p>If you'd like to learn more about testing in Clojure, including how to write tests so that they work seamlessly with Leiningen and CIDER, I have to recommend my <a href="http://purelyfunctional.tv/intro-to-clojure-test">LispCast Intro to clojure.test</a> course. It covers the most <strong>important and fundamental concepts and skills</strong> for testing in Clojure. You should not miss the <em>free</em> <code>clojure.test</code> cheat sheet below.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    <h3 class="subscribe-form-title">
      
Get a Free clojure.test Cheatsheet
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/clojure.test cheatsheet.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of the clojure.test cheatsheet. If you write Clojure or ClojureScript, this cheatsheet contains the most important functions in a handy format. I've spent a lot of time formatting and annotating the most used functions and macros from clojure.test so that they fit onto one page and everything is easy to understand.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][32]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/announcing-lispcast-intro-to-clojure-test">Announcing: LispCast Intro to clojure.test</a></li>
<li><a href="http://www.lispcast.com/clojure-database-test-faster">How I made my Clojure database tests 5x faster</a></li>
<li><a href="http://www.lispcast.com/clojure-test-cheatsheet">clojure.test cheatsheet</a></li>
<li><a href="http://www.lispcast.com/clojure-test-directory">Clojure Test Directory</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://github.com/clojure-emacs/cider">CIDER</a> is an Emacs package for rocking Clojure code.<a href="#fnref1">↩</a></p></li>
</ol>
</div>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/lambda-abstraction">
              Lambda Abstraction
            </a>
          </h2>

          <div class="timestamp">
            May 17, 2015
          </div>

          
<p>Summary: <em>Lambda abstractions are always leaky, but some are leakier than others. Clojure programmers recommend keeping most of your functions pure and containing the leaks as much as possible.</em></p>
<p>Lambda abstraction refers to something we do all of the time. Let's say I have some code:</p>
<pre><code>(+ 1 2)</code></pre>
<p>I'm adding the number 2 to a number, in this case, 1. I could abstract that into a <em>lambda</em>:</p>
<pre><code>(defn add2 [x] (+ x 2))</code></pre>
<p>Now it's a function, which I can apply to 1. <code>(add2 1)</code>. I can apply it to any number I want. The actual thing I am adding 2 to is abstracted away and replaced by the variable <code>x</code>. <strong>Lambda abstractions are just functions.</strong></p>
<p>Functional programming is at its best when lambda abstractions are referentially transparent. That means that given the same arguments, a function will always return the same value. Being referentially transparent makes a <strong>software function more like a mathematical function</strong>. And that lets you reason about your code.</p>
<p>But there's a very real difference between software functions and mathematical functions: <strong>mathematical functions take no time or energy to &quot;compute&quot;</strong>. They are defined abstractly, with no notion of computation. In contrast, software functions always take some time to compute. Sometimes the clearest way to write a function takes enough time that the illusion of mathematical functions is shattered. <strong>The abstraction is leaky.</strong></p>
<p>So software functions are already a leaky abstraction, even if they are referentially transparent. Clojure (like most programming languages) opens the leak even further: <strong>you can put stuff that's not referentially transparent right in your function</strong>. For instance, you can write a &quot;function&quot; that reads from the disk or makes a web request. Making the same request twice can obviously return different values.</p>
<p>What most people programming Clojure recommend is to program <em>mostly</em> with pure functions (that means referentially transparent). You still have to deal with time, but that's way easier than dealing with the chaos of the world outside. That leaves a small bit of your code to deal with mutation, input/output, and the disk. It's still a lambda abstraction (function) but <strong>it's just leakier</strong>. Clojure simply leaves the decision up to you where to draw the line. Clojure tries to make pure functions easy, even when not everything fits into pure functions.</p>
<p>The takeaway of functional programming is the same recommendation: <strong>write <em>most</em> of your code as referentially transparent functions</strong>. The degree to which a language helps you do that is how &quot;functional&quot; the language is.</p>
<p>If you'd like to learn more about Clojure and pure functions, check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's 2.5 hours of high quality video. You probably haven't seen anything <a href="http://www.purelyfunctional.tv/intro-to-clojure#preview">like this</a>! There's animations, exercises, characters, and screencasts. It takes you from no knowledge to a deep experience, all while having fun!</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>





          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/infinite-application">
              Infinite Application
            </a>
          </h2>

          <div class="timestamp">
            May 17, 2015
          </div>

          
<p>Summary: <em>Function application is a key concept in lambda calculus. While it is commonly expressed using parentheses in Clojure, it is also reified into a function which itself can be applied to another function.</em></p>
<p>Function application in Clojure is easily expressed with a couple of parentheses:</p>
<pre><code>(foo 1 2 3)</code></pre>
<p>That's the function <code>foo</code> applied to the arguments <code>1</code>, <code>2</code>, and <code>3</code>. But let's say we have those numbers in a vector somewhere, and we want to call <code>foo</code> on them.</p>
<pre><code>(def some-numbers [1 2 3])</code></pre>
<p>We could manually pull out the arguments from the vector like this:</p>
<pre><code>(foo (some-numbers 0) (some-numbers 1) (some-numbers 2))</code></pre>
<p>Great! That should work. But more commonly you see this:</p>
<pre><code>(apply foo some-numbers)</code></pre>
<p><code>apply</code> means take the function (the first argument) and apply it to the arguments which are in the list (the last argument). <code>apply</code> pulls out the values from the list internally so you don't have to.</p>
<p><code>apply</code> is a function you'll see in many Lisps. It plays a key role in the <a href="http://en.wikipedia.org/wiki/Meta-circular_evaluator">meta-circular evaluator</a> as defined in <em>The Structure and Interpretation of Computer Programs</em> (SICP). In the meta-circular evaluator, <code>eval</code> and <code>apply</code> are defined in terms of each other.</p>
<p>The way <code>eval</code> is defined classically, <code>(foo 1 2 3)</code> gets turned into <code>(apply foo [1 2 3])</code> internally. This means that you can replace <code>(foo 1 2 3)</code> with <code>(apply foo [1 2 3])</code> in the program without changing the meaning.</p>
<p>But! Since <code>apply</code> is a function, <code>(apply foo [1 2 3])</code> is equivalent to <code>(apply apply [foo [1 2 3]])</code>, which is equivalent to <code>(apply apply [apply [foo [1 2 3]]])</code>. And you can expand that out forever. (Please don't!).</p>
<p><code>apply</code> is something I really love about Lisp. It takes <strong>one of the main parts of lambda calculus (function application) and <a href="http://www.lispcast.com/reification">reifies</a> it</strong>. Function application is available as a function, which can be passed around, composed, etc, <strong>just like any other value</strong>. I love it!</p>
<p>If you're in love with this idea, too, you might want to check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's my video course about, you guessed it, Clojure. It takes you from absolute parenthesis-phobe to I-never-knew-it-could-be-this-way lisper by using animations, exercises, and screencasts.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/just-hack-something-together">Just Hack Something Together</a></li>
<li><a href="http://www.lispcast.com/a-personal-lisp-crisis">A Personal Lisp Crisis</a></li>
<li><a href="http://www.lispcast.com/reification">Reification</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/the-world-is-mutable">
              But the World is Mutable
            </a>
          </h2>

          <div class="timestamp">
            May 11, 2015
          </div>

          
<p>Summary: <em>The world may be mutable, but people have been using the notion of immutability to build reliable systems for a long time.</em></p>
<p>Immutability is a hard topic to breach. As a programmer used to modeling the world, you might object to immutable data structures. How do you model a changing world? <strong>Why would you choose to use immutable data structures when everything in the world is changeable?</strong></p>
<p>Let's do a little thought experiment. Let's look at <strong>a nice mutable system</strong>: paper and pencil. You can write, erase, and write again. It's very convenient. It lets you correct mistakes. And when you don't need something anymore, you can easily erase it.</p>
<p>Now answer this: <strong>would you trust a bank that used pencils to record transactions?</strong> It would be easy: whenever you would withdraw money, they would erase the old balance and write the new balance. And if you transferred money from one account to another, they'd erase two balances and write the new ones in. It may sound great, but there's a reason banks don't use pencils: they want to be sure <strong>nothing has changed</strong>. That sounds like immutability.</p>
<div class="figure">
<img src="http://www.lispcast.com/img/ledger.jpg" alt="Bank ledger (photo credit)" /><p class="caption">Bank ledger (<a href="https://www.nottingham.ac.uk/manuscriptsandspecialcollections/researchguidance/accounting/business.aspx">photo credit</a>)</p>
</div>
<p>This is a bank ledger. Each transaction gets its own line. Always done in pen. It's an example of an append-only data structure. You can answer questions about the past like &quot;How much money was in the account at the close of last Tuesday?&quot; by going up lines until you find the last entry for Tuesday. And you can do that because you never modify existing entries. You only add new entries on blank lines.</p>
<div class="figure">
<img src="http://www.lispcast.com/img/medicalrecords.jpg" alt="Medical record system (photo credit)" /><p class="caption">Medical record system (<a href="https://www.flickr.com/photos/digitaldrew/4930438982/">photo credit</a>)</p>
</div>
<p>This is another example of an append-only data structure in the real world: medical records. Each patient gets a file that everything is added to. You never modify old records. That way, everything is recorded, even the wrong diagnoses (mistakes) of the doctor.</p>
<p>It turns out that traditional systems that <strong>need a high degree reliability create immutable records out of mutable paper</strong>. Even though you could in theory scratch out some data and write it again, or white it out, or find some other way to mutate the document, a mark of professionalism in the job is to <strong>discipline yourself to adhere to strict append-only behaviors</strong>.</p>
<p>Wouldn't it be nice if the machine took care of the discipline for us? Even though RAM and disk are mutable like paper and pen, we can impose a discipline inside of our program. We <em>could</em> rely on the programmer to never accidentally overwrite existing data. But that's just shifting the burden. Instead, we can build in immutability into our data structures and make a paper that cannot be overwritten.</p>
<p>That's how immutable data structures work. <strong>All new pieces of information are written to new locations in memory.</strong> Only when it is proven that a location is never going to be used again is it reused.</p>
<p>Reliable paper-based systems use immutable data. There was a time when computer memory was expensive when we had to reuse storage, so we couldn't make immutable systems. But RAM is cheap now! We should be using immutable data, just as <strong>banks have done for hundreds of years</strong>. Ready to join the 13th century?<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup></p>
<p>If you're interested in a language with a very cool set of powerful immutable data structures, probably the most <strong>cutting edge immutable data structures</strong> in any language, you're in luck! You can get <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's a video course with animations, exercises, and screencasts that teaches you Clojure so you'll learn it and remember it.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/object-function-duals-dispatch">Object-Oriented Dispatch is the Dual of Functional Dispatch</a></li>
<li><a href="http://www.lispcast.com/object-oriented-vs-functional-duals">Object-Oriented Programming is the Dual of Functional Programming</a></li>
<li><a href="http://www.lispcast.com/paper-metaphor">The Paper Metaphor</a></li>
<li><a href="http://www.lispcast.com/the-content-of-your-code">The Content of Your Code</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>The Double-entry method of accounting can trace its history back to 13th century Florence.<a href="#fnref1">↩</a></p></li>
</ol>
</div>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/clojure-test-cheatsheet">
              clojure.test cheatsheet
            </a>
          </h2>

          <div class="timestamp">
            May 03, 2015
          </div>

          
<p>Summary: <em>I made a clojure.test cheatsheet that you can get for free.</em></p>
<p>Cheatsheets are a great way to bootstrap new skills. Because at first there is so much to learn, we need all the support we can get. Instead of asking a beginner to scour through docs, hand them a good cheatsheet and they can get something accomplished. They'll remember the details eventually, with practice.</p>
<p>And as part of my campaign to rock the Clojure world with cool stuff, I made a cheatsheet for <code>clojure.test</code>, the built-in and oh-so-popular testing library for Clojure. Just sign up for the email list and it will be yours for free, along with the core.async reference sheet and the one-page Ring Spec.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    <h3 class="subscribe-form-title">
      
Get a Free clojure.test Cheatsheet
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/clojure.test cheatsheet.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of the clojure.test cheatsheet. If you write Clojure or ClojureScript, this cheatsheet contains the most important functions in a handy format. I've spent a lot of time formatting and annotating the most used functions and macros from clojure.test so that they fit onto one page and everything is easy to understand.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][32]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/announcing-lispcast-intro-to-clojure-test">Announcing: LispCast Intro to clojure.test</a></li>
<li><a href="http://www.lispcast.com/clojure-database-test-faster">How I made my Clojure database tests 5x faster</a></li>
<li><a href="http://www.lispcast.com/clojure-test-directory">Clojure Test Directory</a></li>
<li><a href="http://www.lispcast.com/clojure-test-launch">LispCast Intro to clojure.test</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/pre-west-interview-ron-toland">
              Pre-West Interview: Ron Toland
            </a>
          </h2>

          <div class="timestamp">
            April 21, 2015
          </div>

          
<div class="figure">
<img src="http://www.lispcast.com/img/pre-west-prep.png" />
</div>
<p><a href="http://clojurewest.org/speakers#rtoland"><img src="http://www.lispcast.com/img/pre-west/rtoland.jpg"
style="float:right;width:150px"></a></p>
<h3 id="introduction">Introduction</h3>
<p>Ron Toland was gracious enough to agree to an interview. He is <a href="http://clojurewest.org/speakers#rtoland">giving a talk</a> at <a href="http://www.clojurewest.org/">Clojure/West</a> about building large systems in Clojure. The <a href="http://www.lispcast.com/pre-west-ron-toland">background to his talk</a> is available, if you like.</p>
<h3 id="interview-with-ron-toland">Interview with Ron Toland</h3>
<p><strong>LispCast</strong>: How did you get into Clojure?</p>
<p><strong>Ron Toland</strong>: I got into Clojure through Scheme.</p>
<p>There was a senior engineer at my first programming gig that kept raving about Scheme and the book Structure and Interpretation of Computer Programs (SICP). After several months of listening to him, I finally bought a copy and read through it. I was blown away by how very simple building blocks could be used to do very complicated things.</p>
<p>In particular, it struck me that the authors covered the map-reduce paradigm in only chapter 2 of their book; given that at the time I was reading (2009-2010) hadoop was all the rage, and the book was written in the 1980s, I started wondering &quot;what else does lisp have that we're only now re-discovering&quot;?</p>
<p>After doing some digging into currently used Lisps, I came across Clojure. Since I was already familiar with Java, it seemed like a perfectly pragmatic Lisp to me: stealing all the thunder of the JVM, but stacking on top of that the beauty and power of Lisp. It's been my favorite programming language ever since.</p>
<p><strong>LC</strong>: You've been using Clojure at Sonian for 6 years. When you started, Clojure was very new. What made you choose Clojure at such an early point?</p>
<p><strong>RT</strong>: I wasn't at Sonian when the decision was made to use Clojure, but I do know the background.</p>
<p>Basically the first version of everything was written in Ruby, which worked fine until they needed to scale things out and up to handle a larger volume of email.</p>
<p>They knew they needed to rebuild it in a different language, so they looked at several contenders: JRuby, Java, Clojure, Scala, even Erlang. They held a big meeting of all the devs to decide which one to go with, and it came down to Clojure or Erlang. Clojure, because several of the devs were familiar with Common Lisp or Scheme and liked it, and Erlang, because the architecture they were designing around is actually pretty close to the way you'd build it in Erlang.</p>
<p>Clojure won because of the JVM. It turns out that email is terrible, with multiple standards used by different programs at different times over the decades, and so processing it into something searchable is a nightmare. Java has a lot of libraries for processing email that have been built up over the years to handle most of email's craziness. Erlang doesn't (or at least didn't at the time).</p>
<p>Since with Clojure they could use those Java libraries directly, while if they used Erlang they'd have to write their own, they went with Clojure.</p>
<p><strong>LC</strong>: What is the SAFE codebase?</p>
<p><strong>RT</strong>: SAFE is the primary application we use at Sonian for email ingestion. archiving, and indexing into Elasticsearch.</p>
<p><strong>LC</strong>: What is the most important thing to get right early when writing a large Clojure system?</p>
<p><strong>RT</strong>: I wasn't part of the team that originally wrote SAFE, so I can't speak much about what to get right at the start of building a large system in Clojure.</p>
<p>I can say that a lot of large systems don't start out that way; they begin as smaller applications that grow over time, as needs arise. The trick is to keep it from becoming a mess by constantly revisiting how it's put together and looking for better -- usually more abstract, but not always -- ways to express what it needs to do.</p>
<p><strong>LC</strong>: What do you wish could be better in Clojure for large systems?</p>
<p><strong>RT</strong>: I'm not sure there's anything in the language itself I wish was better about Clojure for building large systems. Getting logging configured correctly always seems to be a pain; it'd be nice to have a single logging library that could hide the ugliness of the underlying java libs from us.</p>
<p><strong>LC</strong>: Is there anything else you'd think would be useful for people to know before they watch your talk?</p>
<p><strong>RT</strong>: I think that pretty much covers it. I'd encourage people to attend the Trapper Keeper talk today, so they can compare the two approaches.</p>
<p><strong>LC</strong>: Where can people follow you online?</p>
<p><strong>RT</strong>: I blog at <a href="http://mindbat.com">mindbat.com</a>, and my twitter handle is <a href="http://twitter.com/mindbat">@mindbat</a>.</p>
<p><strong>LC</strong>: If Clojure were a food, what food would it be?</p>
<p><strong>RT</strong>: If Clojure were a food, it'd be coffee. Once you use it long enough you can take it for granted, but when you don't have it you can't seem to get anything done.</p>
<hr />

<div class="article-cg-box">
  <p style="font-size:0.8em">
    
<em> This post is one of a series called <a href="http://www.lispcast.com/keyword/pre-west">Pre-West Prep</a>. </em>
</p>


<h3>
You may like the Clojure Gazette
</h3>
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>

<p style="font-size:0.8em">
<em> <a href="http://clojurewest.org/">Clojure/West</a> is a conference organized and hosted by <a href="http://cognitect.com/">Cognitect</a>. This information is in no way official. It is not sponsored by nor affiliated with Clojure/West or Cognitect. It is simply me (and helpers) curating and organizing public information about the conference. </em>
</p>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/pre-west-2015">Pre-West Prep 2015</a></li>
<li><a href="http://www.lispcast.com/pre-west-alan-dipert-micha-niskin">Pre-West Prep: Alan Dipert and Micha Niskin</a></li>
<li><a href="http://www.lispcast.com/pre-west-anthony-marcar">Pre-West Prep: Anthony Marcar</a></li>
<li><a href="http://www.lispcast.com/pre-west-boris-kourtoukov">Pre-West Prep: Boris Kourtoukov</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/pre-west-interview-nathaniel-smith-ruth-linehan">
              Pre-West Interview: Nathaniel Smith and Ruth Linehan
            </a>
          </h2>

          <div class="timestamp">
            April 21, 2015
          </div>

          
<div class="figure">
<img src="http://www.lispcast.com/img/pre-west-prep.png" />
</div>
<div style="float:right">

<p><a href="http://clojurewest.org/speakers#nsmith"><img src="http://www.lispcast.com/img/pre-west/nsmith.jpg"
style="height:150px"></a> <br> <a href="http://clojurewest.org/speakers#nsmith"><img src="http://www.lispcast.com/img/pre-west/rlinehan.png"
style="height:150px"></a></p>
</div>

<h3 id="introduction">Introduction</h3>
<p>Nathaniel Smith and Ruth Linehan generously agreed to do an interview about their <a href="http://clojurewest.org/speakers#nsmith">talk</a> at <a href="http://www.clojurewest.org/">Clojure/West</a>. They will be talking about Trapperkeeper. The <a href="http://www.lispcast.com/pre-west-nathaniel-smith-ruth-linehan">background to their talk</a> is available, if you like.</p>
<h3 id="interview">Interview</h3>
<p><strong>LispCast</strong>: How did you get into Clojure?</p>
<p><strong>Ruth Linehan</strong>: I started using Clojure about a year and a half ago, when my team at Puppet Labs started working on a new project in it. Previously I had mostly worked in Ruby and Javascript, and while switching to Clojure required a bit of a mind shift, I really enjoy it!</p>
<p><strong>Nathaniel Smith</strong>: I had never used it, but was offered a job at Puppet Labs two years ago to write it full time. I thoroughly enjoyed learning it on the 5 hour flight to my first interview there and have loved writing it ever since (in other words, I got the job :) )</p>
<p><strong>LC</strong>: What does Trapperkeeper offer the Clojure developer?</p>
<p><strong>RL</strong>: Great question! Trapperkeeper is great for complicated Clojure applications. It allows you to easily break up your code into modular pieces (what we call &quot;services&quot;), and it serves as a binder for these pieces of code. Any state a service needs can be stored in a map in the service context, rather than kept globally. It provides a consistent way for expressing the lifecycle of these services - what happens at startup and shutdown - and for managing dependencies between services. It has built in config file parsing, and it initializes a logging system using logback for you, so that you don't have to worry about this. It also has some useful test helpers that allow you to start up a Trapperkeeper application in code and test the whole system.</p>
<p><strong>NS</strong>: A better way to compose the various services (Database, job queue, web server, logging, configuration...) that one has in a large, long running Clojure application. Trapperkeeper leads to more maintanable and reusable code.</p>
<p><strong>LC</strong>: How does breaking everything into small services help build a large application?</p>
<p><strong>NS</strong>: You have well-defined, protocol-enforced APIs for you various services and get to leverage TK's dependency management to ensure clean statups/shutdowns of all of your JVM infrastructure bits.</p>
<p><strong>RL</strong>: Frequently, some of the code that's necessary to build a large application is code you (or someone else) had to write to build a different application. Breaking it down into smaller, more modular services means that you can more easily reuse that code across multiple applications. Furthermore, each service manages the state that it needs, so you don't end up with a huge mess of global state. It also makes testing much easier - you can test a service on its own, rather than having to set up the entire system to test it.</p>
<p><strong>LC</strong>: Are there any similar systems in Clojure or elsewhere?</p>
<p><strong>NS</strong>: A few, but none of them met our needs at Puppet Labs. We think that Immutant and Components and other similar projects are great, but they weren't a good fit for our needs.</p>
<p><strong>RL</strong>: Trapperkeeper was heavily influenced by Stuart Sierra's &quot;Clojure, Reloaded&quot; workflow, and it has a number of similarities with other frameworks motivated by this, such as Jig and Component. Our way of turning on and off services and managing service dependencies borrows a lot from OSGi's service registry.</p>
<p><strong>LC</strong>: Where can people follow you online?</p>
<p><strong>RL</strong>: Nathaniel and I are both on twitter: I'm <a href="https://twitter.com/ruthlinehan">@ruthlinehan</a>, he's <a href="https://twitter.com/nate_smith">@nate_smith</a>. If you want to follow Trapperkeeper, we (&quot;we&quot; meaning many of the folks at Puppet Labs who work on or with Trapperkeeper) hangout on IRC on freednode in #trapperkeeper. We'd love to see folks there!</p>
<p><strong>NS</strong>: I publish poetry and other esoterica at <a href="http://chiptheglasses.com">http://chiptheglasses.com</a>.</p>
<p><strong>LC</strong>: If Clojure were a food, what food would it be?</p>
<p><strong>RL</strong>: Hm... maybe a melon? From the outside it seems hard and impenetrable, but once you get inside it's awesome and delicious! Also, a slice of melon looks like a parenthesis. :)</p>
<p><strong>NS</strong>: Delicious whole wheat bread (ooh, or oat bread) used to make function sandwiches.</p>
<hr />

<div class="article-cg-box">
  <p style="font-size:0.8em">
    
<em> This post is one of a series called <a href="http://www.lispcast.com/keyword/pre-west">Pre-West Prep</a>. </em>
</p>


<h3>
You may like the Clojure Gazette
</h3>
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>

<p style="font-size:0.8em">
<em> <a href="http://clojurewest.org/">Clojure/West</a> is a conference organized and hosted by <a href="http://cognitect.com/">Cognitect</a>. This information is in no way official. It is not sponsored by nor affiliated with Clojure/West or Cognitect. It is simply me (and helpers) curating and organizing public information about the conference. </em>
</p>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/pre-west-2015">Pre-West Prep 2015</a></li>
<li><a href="http://www.lispcast.com/pre-west-alan-dipert-micha-niskin">Pre-West Prep: Alan Dipert and Micha Niskin</a></li>
<li><a href="http://www.lispcast.com/pre-west-anthony-marcar">Pre-West Prep: Anthony Marcar</a></li>
<li><a href="http://www.lispcast.com/pre-west-boris-kourtoukov">Pre-West Prep: Boris Kourtoukov</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/pre-west-interview-leon-barrett">
              Pre-West Interview: Leon Barrett
            </a>
          </h2>

          <div class="timestamp">
            April 19, 2015
          </div>

          
<div class="figure">
<img src="http://www.lispcast.com/img/pre-west-prep.png" />
</div>
<p><a href="http://clojurewest.org/speakers#lbarrett"><img src="http://www.lispcast.com/img/pre-west/lbarrett.jpg"
style="float:right;width:150px"></a></p>
<h3 id="introduction">Introduction</h3>
<p>Leon Barrett was gracious enough to agree to an interview. He is <a href="http://clojurewest.org/speakers#lbarrett">giving a talk</a> at <a href="http://www.clojurewest.org/">Clojure/West</a> about parallel programming in Clojure. The <a href="http://www.lispcast.com/pre-west-leon-barrett">background to his talk</a> is available, if you like.</p>
<h3 id="interview-with-leon-barrett">Interview with Leon Barrett</h3>
<p><strong>LispCast</strong>: How did you get into Clojure?</p>
<p><strong>Leon Barrett</strong>: Actually, I wasn't even aware of Clojure until I started at The Climate Corporation 2.5 years ago. I had used Lisp a number of times in school, so it wasn't too foreign, but I'd never imagined that I'd write Lisp for a living.</p>
<p><strong>LC</strong>: Clojure is great for shared-memory parallelism. Is it good for distributed programming?</p>
<p><strong>LB</strong>: It can be; the same set of abstractions that are helpful locally can be helpful when distributed. For instance, there are some nice Hadoop MapReduce tools (though I happen to dislike Cascalog--it doesn't mesh with my mental model of mapreduce). Of course, you have to do some extra work to support distributed computing, but all in all it's relatively pleasant.</p>
<p><strong>LC</strong>: What are your preferred distributed Clojure abstractions?</p>
<p><strong>LB</strong>: You know, I don't feel qualified to opine on this too much. I mostly end up working on tasks that are fairly embarrassingly parallel, and I spend more of my time worrying about single-machine parallelism (hence my need for Claypoole). The core idea in the better Clojure distribution work I've done was, for both Storm and Hadoop, to just write simple, functional data transformations and then let the distribution framework worry about everything else.</p>
<p><strong>LC</strong>: Where should someone get started with distributed programming in Clojure?</p>
<p><strong>LB</strong>: I think both Parkour and Storm are very nice, though I had some issues using Parkour on Amazon's EMR. Just working with those, it's pretty easy to write distributed tools without worrying about the hard distributed parts (data movement, reliability, etc) yourself.</p>
<p><strong>LC</strong>: What makes Clojure great for parallel programming?</p>
<p><strong>LB</strong>: Clojure is great for parallel programming because of three things: Immutability, good core libraries, and macros.</p>
<p>First, the bane of parallel programming is mutable state; state makes parallel programs much harder to reason about. While it's possible to avoid shared state by writing functional programs with immutable data even in other languages, it's much easier in Clojure because all the standard libraries support it, so Clojure is easier to do parallelism with from the very beginning. Also, Clojure's parallelism features, such as future and deref, are well-designed and easy to use, making it very easy to get started with parallelism. Finally, macros make it possible to write parallel things without so much fuss; for instance, Clojure's futures (built with macros) are easier to use than Java's futures because they don't require any boilerplate. Similarly, the library core.async uses macros to add amazing parallel and asynchronous features as a library, whereas in other languages such features would need to be designed into the core language.</p>
<p><strong>LC</strong>: Can you briefly explain Claypoole? What does it do? Why did you write it?</p>
<p><strong>LB</strong>: I wrote Claypoole because I was dissatisfied with Clojure's built-in pmap for several reasons, including 2 in particular: First, I wanted to control the degree of parallelism, but core pmap's parallelism is determined only by the number of CPUs. Second, I wanted my pmaps to get things done as fast as possible, but core pmap is lazy and may be inefficient when the individual tasks have a high variance in duration.</p>
<p>Claypoole's core feature is a pmap that meets my demands--it's eager, and I can control the degree of parallelism, even across multiple simultaenous pmaps. As a bonus, it turns out that once one has good control over sharing threadpools in pmaps, it's easy to add other such features, so Claypoole also does a number of related, handy things, such as parallel for (pfor), unordered pmaps that return results in the order they're completed (upmap), and so on. I see Claypoole as a tool to provide an advanced degree of control over parallelism.</p>
<p><strong>LC</strong>: Those sound really handy! Do you use reducers in your work? Where have you found them most helpful?</p>
<p><strong>LB</strong>: I don't actually use reducers a lot. I used them while working with Parkour, and they were very cute there. However, in my own work I've tended to prefer Claypoole. Reducers is good because it has much less overhead than chained maps, which is great for functionally combining small tasks. However, I find that I tend map bigger tasks, so I benefit more from fine-grained control of parallelism in Claypoole than I would from the efficiency of reducers.</p>
<p><strong>LC</strong>: Do you have any good background materials for people who want to do a little pre-reading/watching?</p>
<p><strong>LB</strong>: Nope. My talk will start with some basics to make sure that everyone's on the same page, and my initial test audiences seemed to indicate that my intro works well for both beginners and more advanced programmers.</p>
<p><strong>LC</strong>: How can people help with Claypoole?</p>
<p><strong>LB</strong>: I love pull requests, and I appreciate bug reports (obviously, repeatable test cases make my life easier). But mostly, my goal with open-sourcing Claypoole was to have the community do this stuff right once, rather than having lots of people making partial reimplementations that work on just their case. So, just use it! I want people to use Claypoole rather than reimplementing it.</p>
<p><strong>LC</strong>: Where can people follow you online?</p>
<p><strong>LB</strong>: I'm not terribly vocal online. I guess I post to the <a href="http://eng.climate.com/">Climate Corp engineering blog</a> every so often.</p>
<p><strong>LC</strong>: If Clojure were a food, what food would it be?</p>
<p><strong>LB</strong>: One could claim that it'd be Cajun blackened catfish, because it's lean and full of flavor.</p>
<hr />

<div class="article-cg-box">
  <p style="font-size:0.8em">
    
<em> This post is one of a series called <a href="http://www.lispcast.com/keyword/pre-west">Pre-West Prep</a>. </em>
</p>


<h3>
You may like the Clojure Gazette
</h3>
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>

<p style="font-size:0.8em">
<em> <a href="http://clojurewest.org/">Clojure/West</a> is a conference organized and hosted by <a href="http://cognitect.com/">Cognitect</a>. This information is in no way official. It is not sponsored by nor affiliated with Clojure/West or Cognitect. It is simply me (and helpers) curating and organizing public information about the conference. </em>
</p>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/pre-west-2015">Pre-West Prep 2015</a></li>
<li><a href="http://www.lispcast.com/pre-west-alan-dipert-micha-niskin">Pre-West Prep: Alan Dipert and Micha Niskin</a></li>
<li><a href="http://www.lispcast.com/pre-west-anthony-marcar">Pre-West Prep: Anthony Marcar</a></li>
<li><a href="http://www.lispcast.com/pre-west-boris-kourtoukov">Pre-West Prep: Boris Kourtoukov</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


      <div class="notes">

      </div>

    </div>

    <footer class="footer-banner">
      <a class="footer-previous"
         href="page2.html">
        <i class="fa fa-chevron-left footer-arrow"></i>
      </a>
    </footer>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script>

      document.write('<script src="https://oberon.herokuapp.com/cookie/get.js?_=' + (new Date()).getTime() + '"><\/script>');

          if(window.oberon && mixpanel) {
            if(document.cookie.indexOf('oberon-id') < 0) {
              var expires = (new Date((new Date().getTime() + 1000*60*60*24*365*10))).toUTCString();
              mixpanel.alias(window.oberon.id);
              document.cookie = "oberon-id=" + window.oberon.id + ";expires=" + expires + ";path=/";
            }
            mixpanel.identify(window.oberon.id);
          }

      mixpanel.register({URL: window.location.pathname,
                         Title: $("title").text()});

      mixpanel.track("Page Visit");

      mixpanel.track_forms('.gazette-form', 'Submit Clojure Gazette');
      mixpanel.track_forms('.subscribe-form', 'Subscribe');

      mixpanel.track_links('a.homepage-offer-box-link',
                           'Click PurelyFunctional.tv',
                           function(e) {
                             return {ToURL: $(e).prop('href')};
                           });

      mixpanel.track_links('a.js-clojuregazette',
                           'Click Clojure Gazette',
                           function(e) {
                             return {ToURL: $(e).prop('href')};
                           });

      $('input[name=EMAIL]').change(function() {
                                                      var i = $(this);
                                                      window.o_email = i.val();
                                                      });

      $('form').submit(function() {
        if(window.o_email)
          mixpanel.people.set({"$email": window.o_email});
});

    </script>

  </body>
</html>
