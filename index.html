<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

    <title>LispCast</title>
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@ericnormand">
    <meta name="twitter:creator" content="@ericnormand">
    <meta name="twitter:description" content="A blog about the simple joys of functional programming.">
    <meta name="twitter:title" content="LispCast">

    <meta property="og:title" content="LispCast">
    <meta property="og:description" content="A blog about the simple joys of functional programming.">

    <meta name="description" content="A blog about the simple joys of functional programming.">

    <meta name="author" content="Eric Normand">

    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="/css/styles.css" type="text/css">

    <link rel="alternate" type="application/rss+xml"
    title="LispCast" href="/feed" />

    <!-- start Mixpanel --><script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
      for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
                  mixpanel.init("ffad2bd88d2cb690edbbba6cf30b2958");</script><!-- end Mixpanel -->
                  </head>

  <body>
    <header class="banner">
      <h1 class="banner-logo">
        <a href="/">
          <img class="banner-logo-img"
               src="/img/Logo@2x.png"
               alt="LispCast" />
        </a>
      </h1>

      <div class="meta-data">
        <img class="bio-img"
             src="/img/eric_bio.jpg" />
        <a class="twitter-link"
           href="http://twitter.com/ericnormand">
          <i class="fa fa-twitter"></i>
        </a>
        <a class="github-link"
           href="https://github.com/ericnormand">
          <i class="fa fa-github"></i>
        </a>
        <a class="mail-link"
           href="mailto:eric@lispcast.com">
          <i class="fa fa-envelope"></i>
        </a>
        <a class="rss-link"
           href="/feed">
          <i class="fa fa-rss-square"></i>
        </a>
        <a class="rss-link"
           href="/archive.html">
          <i class="fa fa-list"></i>
        </a>
      </div>

    </header>

    <div class="main-container">


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/annotated-map">
            Annotated map
          </a>
        </h2>

        <div class="timestamp">
          July 29, 2015
        </div>

        
<p>Summary: <em><code>map</code> is one of the staples of functional programming. It's totally useful and also surprisingly simple. Let's look at some examples and annotated code.</em></p>
<p>About a week ago I showed some <a href="http://lispcast.com/annotated-clojure-core-reduce">examples of using <code>reduce</code></a>, a very commonly used function. This time, I'm going to give some examples of <code>map</code>, which is probably even more common.</p>
<p><code>map</code> is one of those things that's so useful and so straightforward that it finds its way into every language. Javascript has a <code>map</code> in the newer versions, but people couldn't live without it so it's in a lot of Javascript libraries (for example, in <a href="http://underscorejs.org/#map">Underscore</a>).</p>
<p>Let's imagine you're walking down a list <code>[0 1 2 3 4 5]</code>. Your job is to increment each one. As you pass each each number on your right you pick it up, add one to it, and put it down on your left. Boom, a new list on your left.</p>
<pre id="map1" class="code-card"><code>(map inc [0 1 2 3 4 5])

  =&gt; (1 2 3 4 5 6)</code></pre>
<div class="annotation-down" for="map1" data-at="map i">
add 1
</div>

<div class="annotation-left" for="map1" data-at="5">
to each of these
</div>

<div class="annotation-left" for="map1" data-at="1 2 3">
it returns a new list with the numbers incremented
</div>

<p>Ok, next one. Let's say you're walking down a list . . . of lists. Your job? Write down the sizes of those lists. Let's do it! Walk down the list, pick up each list as you go, and drop the size to your left. You just made a new list!</p>
<pre id="map2" class="code-card"><code>(map count
     [[]
      [1]
      [1 1]
      [1 1 1]
      [1 1 1 1]
      [1 1 1 1 1]])
      
  =&gt; (0 1 2 3 4 5)</code></pre>
<div class="annotation-left" for="map2" data-at="count">
get the size
</div>

<div class="annotation-left" for="map2" data-at="[[">
of each of these
</div>

<div class="annotation-left" for="map2" data-at="0 1 2">
a list of the sizes
</div>

<p>Alright, let's get fun with this one. You walk down a list of maps. Your job? figure out what's under the <code>:a</code> key. Drop the answers on the left. Remember, if the map doesn't have the list, it gives you <code>nil</code>.</p>
<pre id="map3" class="code-card"><code>(map :a
     [{:a 1}
      {:a 2}
      {:a 3}
      {:b 4}])
      
  =&gt; (1 2 3 nil)</code></pre>
<div class="annotation-left" for="map3" data-at=":a">
keywords are functions, too
</div>

<div class="annotation-left" for="map3" data-at="{:a">
look at these little maps, just waiting there!
</div>

<div class="annotation-left" for="map3" data-at="1 2 3">
look, the last one was <code>nil</code>
</div>

<p>Ok, here's a good one. Someone wrote a bunch of sentences, but you want to make them angry. ALL CAPS!! Walk down the list, apply this epic function to each, and make a new list!</p>
<pre id="map4" class="code-card"><code>(map (fn [x] (str (.toUpperCase x) &quot;!!&quot;))
     [&quot;I am angry&quot;
      &quot;don&#39;t yell at me&quot;
      &quot;stop yelling&quot;])
      
  =&gt; (&quot;I AM ANGRY!!&quot;
      &quot;DON&#39;T YELL AT ME!!&quot;
      &quot;STOP YELLING!!&quot;)</code></pre>
<div class="annotation-left" for="map4" data-at="toUpperCase">
our epic function
</div>

<div class="annotation-left" for="map4" data-at="I am angry">
make these angry!!!
</div>

<div class="annotation-left" for="map4" data-at="=">
LOOK AT THEM!!
</div>

<h3 id="conclusions">Conclusions</h3>
<p>Yep, <code>map</code> is useful. It's one of the staples of functional programming. Once you start using it, you'll use it everywhere.</p>
<p>If you liked the code with annotations, the physical metaphors, the focus on the basics, you will love <a href="http://www.purelyfunctional.tv/intro-to-clojure">Lispcast Introduction to Clojure</a>. Visuals, metaphors, exercises, annotated code, and lots of code in a repo. You learn the basics of Clojure down to your fingertips, writing code right away.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/annotated-clojure-core-reduce">Some Annotated clojure.core/reduce Examples</a></li>
<li><a href="http://www.lispcast.com/3-things-java-can-steal-from-clojure">3 Things Java Programmers Can Steal from Clojure</a></li>
<li><a href="http://www.lispcast.com/atom-problem">Atom code explanation</a></li>
<li><a href="http://www.lispcast.com/clojure-database-test-faster">How I made my Clojure database tests 5x faster</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/annotated-clojure-core-reduce">
            Some Annotated clojure.core/reduce Examples
          </a>
        </h2>

        <div class="timestamp">
          July 21, 2015
        </div>

        
<p>Summary: <em>reduce is a very useful function. You can use it for many calculations over a collection. Code annotations are useful, as are physical metaphors.</em></p>
<p><code>reduce</code> is used a lot in Clojure. I've heard a lot of people get scared by <code>reduce</code>, like it's something deep and mysterious. It is deep, but it's not mysterious. It's also very loveable for its <strong>easy mechanistic application</strong>.</p>
<p>I love to watch my toddler doing mechanistic stuff. She picks up a bean and puts it in the cup. She picks up a bean and puts it in the cup. <strong>Over. And over.</strong> And then I think: that's reduce!</p>
<p>Let's look at a first example. Let's say we want to <strong>add up a list of numbers</strong>.</p>
<pre id="reduce1" class="code-card"><code>(reduce +
        0
        [1 2 3 4 5])</code></pre>
<div class="annotation-left" for="reduce1" data-at="+">
let's add
</div>

<div class="annotation-left" for="reduce1" data-at="0">
start with zero
</div>

<div class="annotation-left" for="reduce1" data-at="1 2 3">
add these numbers to it, one at a time
</div>

<p>Imagine holding <code>0</code> in your left hand and walking down the list of numbers <code>1</code>, <code>2</code>, <code>3</code>, <code>4</code>, <code>5</code>. You approach the number <code>1</code>. You grab it with your right hand. You have two numbers in your hands. You add them together (<code>+</code>) and hold the answer in your left hand. Now proceed to the next number. Repeat until you're done with the list. At the end, what number are you holding in your left hand? That's the answer.</p>
<p>We can add stuff to a set.</p>
<pre id="reduce2" class="code-card"><code>(reduce conj
        #{}
        [1 2 3 4 5])</code></pre>
<div class="annotation-left" for="reduce2" data-at="conj">
let's add things to a collection
</div>

<div class="annotation-left" for="reduce2" data-at="#{}">
start with an empty set
</div>

<div class="annotation-left" for="reduce2" data-at="1 2 3">
add these numbers to it, one at a time
</div>

<p>Imagine holding an empty bucket (like the empty set) in your left hand and walking down the list of numbers. When you get to <code>1</code>, you pick it up in your right hand. Now drop it in the bucket (<code>conj</code>). Proceed to the next number and repeat down the list. What is in your left hand at the end? A bucket with the numbers 1-5. That's the value of this expression.</p>
<p>Alright, we can do something more complicated. This time, let's use an anonymous function. We'll calculate the maximum number from a list.</p>
<pre id="reduce3" class="code-card"><code>(reduce (fn [a b]
          (if (&gt; a b)
            a
            b))
        0
        [1 2 3 4 5])</code></pre>
<div class="annotation-left" for="reduce3" data-at="fn">
we can use an anonymous function
</div>

<div class="annotation-left" for="reduce3" data-at=" a b">
return the larger of the two
</div>

<div class="annotation-left" for="reduce3" data-at="0">
start with zero
</div>

<div class="annotation-left" for="reduce3" data-at="1 2 3">
compare these numbers to it, one at a time
</div>

<p>Hold <code>0</code> in your left hand and walk down the list. When you get to <code>1</code>, pick it up. Which is bigger, what's in your left hand or what's in your right hand? Whichever it is, put that in your left hand and proceed to the next number, and so on down the line. The answer is in your left hand.</p>
<p>Hmm. What about averages? We think of averages as the sum of a bunch of numbers divided by the number of numbers. We can keep the sum and the count separate so we can operate on them.</p>
<pre id="reduce4" class="code-card"><code>(reduce (fn [[n d] b]
          [(+ n b)
           (inc d)])
        [0 0]
        [1 2 3 4 5])</code></pre>
<div class="annotation-left" for="reduce4" data-at="fn">
<code>n</code> is the numerator, <code>d</code> is the denominator
</div>

<div class="annotation-left" for="reduce4" data-at="n b">
add each number to the numerator
</div>

<div class="annotation-left" for="reduce4" data-at="inc d">
add 1 to the denominator
</div>

<div class="annotation-left" for="reduce4" data-at="0 0">
start here
</div>

<div class="annotation-left" for="reduce4" data-at="1 2 3">
average these numbers, one at a time
</div>

<p>Hold <code>[0 0]</code> in your left hand. Walk down the list. When you get to <code>1</code>, pick it up in your right hand. Now, add what's in your right hand to the first number in your left hand, and add 1 to the second number in your left hand. Hold the two new numbers in your left hand. Proceed down the line, picking each number up in your right hand, until the end. The answer is in your left hand.</p>
<p>Now, one final time, the general pattern:</p>
<pre id="reduce5" class="code-card"><code>(reduce (fn [left right]
          (dosomething left right))
        starting-value
        collection)</code></pre>
<div class="annotation-down" for="reduce5" data-at="(f">
a function of 2 arguments
</div>

<div class="annotation-left" for="reduce5" data-at="left">
the arguments correspond to your hands
</div>

<div class="annotation-left" for="reduce5" data-at="something">
the return value of this function will be the next value in your left hand
</div>


<div class="annotation-left" for="reduce5" data-at="starting-value">
what you start with in your left hand
</div>

<div class="annotation-left" for="reduce5" data-at="collection">
the items you grab with your right hand
</div>

<h3 id="conclusions">Conclusions</h3>
<p>Well, that was fun. <code>reduce</code> is not hard. <strong>You just need a good way of thinking about it.</strong> Physical metaphors can help a ton. I wish I could have made this visual with a cartoon, but that would take more time and skill than I have. And I think the code annotations really help add context to what would otherwise be very terse code. Context is so important.</p>
<p>If you liked the code annotations and this style of teaching the basics, you will love <a href="http://www.purelyfunctional.tv/intro-to-clojure">Lispcast Introduction to Clojure</a>. It has lots of visuals, lots of metaphors, exercises, and code annotations. It teaches the basics of Clojure and functional programming in a fun way. <a href="http://www.purelyfunctional.tv/intro-to-clojure#preview">Check out a preview</a>.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/annotated-map">Annotated map</a></li>
<li><a href="http://www.lispcast.com/3-things-java-can-steal-from-clojure">3 Things Java Programmers Can Steal from Clojure</a></li>
<li><a href="http://www.lispcast.com/atom-problem">Atom code explanation</a></li>
<li><a href="http://www.lispcast.com/clojure-database-test-faster">How I made my Clojure database tests 5x faster</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/reduce-complexity-with-variants">
            Reduce Complexity with Variants
          </a>
        </h2>

        <div class="timestamp">
          July 08, 2015
        </div>

        
<p>Summary: <em>The structure of our data should match the relevant structures in the real world. And to ensure that our data is structured well, we should reduce the potential for incorrect structure. Variants provide a great solution for it.</em></p>
<h3 id="introduction">Introduction</h3>
<p><a href="https://www.youtube.com/watch?v=ZQkIWWTygio">Jeanine Adkisson's talk at the Conj</a> last year was my favorite talk of the Conj. Her presentation was well-delivered, her slides were just quirky enough, and of course the material was so important. You should go watch the talk before you read on.</p>
<h3 id="the-problem">The problem</h3>
<p>In Clojure we often <strong>represent things as maps with some implicit rules</strong>. For instance, there might be three different ways to represent an image: an array of pixels in memory, a filename for a jpeg file on disk, or a URL of a jpeg on the web. We might have maps that look like this:</p>
<pre><code>{:type :image/in-memory
 :pixels [...]}

{:type :image/on-disk
 :filename &quot;/cats.jpg&quot;}

{:type :image/web
 :url &quot;http://cats.com/cats.jpg&quot;}</code></pre>
<p>This is all well and good. Except it's rife with incidental complexity. We have an <strong>implicit rule</strong> that if the <code>:type</code> is <code>:image/in-memory</code>, then the pixels will be at <code>:pixels</code>, but if the <code>:type</code> is <code>:image/on-disk</code>, we are expecting a string containing a filename at <code>:filename</code>, and so on. <strong>The rule might seem obvious, but it's actually kind of cumbersome.</strong></p>
<p>If it's a rule, are we going to enforce it? Where? How strictly? How often? Enforcement is great, but what do we do if we find an <code>:image/web</code> without a <code>:url</code>? Decisions, decisions. Plus, it's a hashmap! It <em>looks</em> like you can have multiple things. Some lazy programmer is going to reuse those keys. For instance, there could be a <code>save-to-disk</code> function that takes an image and writes it to disk. It returns the original image with the filename where it was saved attached at <code>:filename</code>. Now you've got <code>:filename</code> and <code>:pixels</code>. It's unclear whether that's what we want, but <strong>it's totally allowed by the data structure</strong>.</p>
<p>Actually, if you analyze it, you can quantify the complexity pretty well. We'll make some simplifying assumptions. Let's just say we have the type key and the three &quot;value&quot; keys. The type key can have four possible values (<code>:image/in-memory</code>, <code>:image/on-disk</code>, <code>:image/web</code>, and <code>nil</code> (or missing)) and the values keys have either a valid value or are missing (or <code>nil</code>). The number of states is <code>4 * 2 * 2 * 2 = 32</code>. So instead of three cases, like we want above, we have 32 cases to deal with.</p>
<p>Is there a way to reduce this complexity? Is there a way to nip it in the bud before we've got <strong>code enforcing these assumptions all over the place</strong>? Do we really need to drown in assertions and <code>nil</code> checks?</p>
<h3 id="a-great-solution">A great solution</h3>
<p>Jeanine showed us a well-suited solution. Her solution, as I mentioned before, is called &quot;variants&quot;. We have three variants of image representation. Instead of representing them in a map, we represent them in a vector, like this:</p>
<pre><code>[:image/in-memory [...]]

[:image/on-disk &quot;/cats.jpg&quot;]

[:image/web &quot;http://cats.com/cats.jpg&quot;]</code></pre>
<p>How does this help?</p>
<p>Well, let's do the math. There are now <strong>two positions where data can be</strong> (instead of four in the hashmap representation). If we make the same simplifications we made above, we have <code>4 * 2 = 8</code>. This is cheating slightly because we're only considering vectors of two elements or less. But then again, we cheated above because we never considered adding arbitrary keys to the hashmap.</p>
<p>Okay, so it's 32 vs. 8. But what happens when we add a <em>new</em> kind of image? In the hashmap version, we're adding a new key and a new <code>:type</code>, so the new states become <code>5 * 2 * 2 * 2 * 2 = 80</code>. Woah! And in the vector version? <code>5 * 2 = 10</code>. Wow! Much better. <strong>The variant solution actually grows in complexity more slowly than the hashmap solution.</strong></p>
<p>But we've gained something less quantifiable: the data is now easier to write, easier to read, and most importantly, <strong>easier to get right</strong>. It looks a lot like the tuple pattern we're used to in Clojure. The first value of the tuple is a tag telling you what kind of image it is. As Jeanine pointed out, it's the <strong>same pattern employed by hiccup to represent HTML</strong>. The first element of a hiccup vector tells you what kind of HTML tag it is.</p>
<h3 id="a-plot-twist">A plot twist</h3>
<p>Now, Jeanine's solution works really well for deeply nested structures like ASTs or HTML trees. However, I always get a little scared when I see vectors being overloaded.</p>
<p>It works okay in hiccup because when you're writing hiccup, you are mostly making big chunks of hiccup. You're not passing hiccup around. Hiccup in your code is <strong>dense and will typically only be returned</strong> (as opposed to passed to another function). But notice the problem with having to <a href="http://www.lispcast.com/hiccup-tips#overloading-vectors">use lists within hiccup to represent sequences</a>. Even in hiccup, people get tripped up. But it's still a great solution.</p>
<p>However, once you start shipping these things around as units of data, they get to be a problem. This has happened to me in the past. You start accumulating values, you have a vector of variants, and all of a sudden you're counting how many nesting levels you've got to know how to interpret each level. You've got a <strong>vector of vectors of vectors</strong>. It happens everywhere where vectors are overloaded.</p>
<p>It happens in Pedestal routes. Here's a sample Pedestal route data structure. Notice it starts with three nesting levels. <strong>Each of those vectors has a different meaning.</strong> Perhaps putting keywords in the front would help, but I suspect that's not a good solution here.</p>
<p><a href="https://github.com/pedestal/pedestal/blob/9058f30f16ec5f109e73f46b7cea948804205cfb/samples/hello-world/src/hello_world/service.clj#L25"><img src="http://www.lispcast.com/img/pedestal%20routes.png" alt="Pedestal routes from Hello, World! sample" /></a></p>
<h3 id="a-different-solution">A different solution</h3>
<p>I do have a solution to the case of variants that need to get passed around and collected into sequences. I propose that you <strong>use a hashmap with a single key</strong>, which is the variant's tag. The value for that key is a vector of data.</p>
<pre><code>{:image/in-memory [[...]]} ;; ellipsis represents lots of pixel data

{:image/on-disk [&quot;/dogs.jpg&quot;]}

{:image/web [&quot;http://doggy.com/dogs.jpg&quot;]}</code></pre>
<p>This can still be checked by core.typed and used in core.match. It's natural in Clojure for a hashmap to represent a self-contained value. It's also only slightly harder to type than the vector version, and just as easy to read. I think it's easy, at least, because this is <strong>clearly a different pattern from the original hashmap pattern</strong>. And it's still easy to get right. I also recommend adding a namespace to the tag to show that that they are related.</p>
<h3 id="the-takeaway">The takeaway</h3>
<p><strong>When do you use variants?</strong></p>
<p>Whenever you have different data that have the same operations (for instance, all three kinds of images can be displayed to the screen).</p>
<p><strong>When do you use the vector version of variants?</strong></p>
<p>If you have trees like HTML documents or ASTs after parsing.</p>
<p><strong>When do you use the single key hashmap version of variants?</strong></p>
<p>If you are planning on collecting values into a vector, or the nesting is not obvious.</p>
<h3 id="other-ways-to-reduce-complexity">Other ways to reduce complexity</h3>
<p>Jeanine went over core.typed and core.match for variants.</p>
<p>By using core.typed, you can encode the exact data structures you want, eliminate nils, and enforce enumerations (like the <code>:type</code>s). You can eliminate all of the erroneous cases statically and be left with only the three correct cases (or your code won't compile).</p>
<p>core.match can be used, too, both for convenience (comparing and defining locals in one go), encoding some more complex rules (like extra keys are allowed but ignored), and also collapsing all of the erroneous cases into a single catch-all case. <strong>That's still four cases instead of three, but that's way nicer.</strong> And core.match works for all of the solutions I've presented (including the original hashmap version).</p>
<h3 id="conclusion">Conclusion</h3>
<p>Variants are a great tool that we should keep up front for lots of jobs. Their complexity grows much more slowly than the hashmap-with-<code>:type</code> solution we saw at first. We should all be considerate of how much complexity our choice of data representations is adding to our system. <a href="https://www.youtube.com/watch?v=ZQkIWWTygio">Don't forget the talk.</a> There is also an <a href="http://www.lispcast.com/pre-conj-interview-jeanine-adkisson">interview</a> with Jeanine I did before the Conj.</p>
<div class="article-cg-box">
  <h3>
You may like the Clojure Gazette
</h3>
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/pre-conj-interview-jeanine-adkisson">Pre-Conj Interview: Jeanine Adkisson</a></li>
<li><a href="http://www.lispcast.com/pre-conj-jeanine-adkisson">Pre-conj Prep: Jeanine Adkisson</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/avoid-naming-at-all-costs">
            Avoid Naming at All Costs
          </a>
        </h2>

        <div class="timestamp">
          July 05, 2015
        </div>

        
<p>Summary: <em>If naming is one of the two hardest things in programming, it follows that every other possible solution (except those few involving cache invalidation) should be attempted before naming something. As a corrolary, bad names are a code smell.</em></p>
<p>Phil Karlton (attributed):</p>
<blockquote>
<p>There are only two hard things in Computer Science: cache invalidation and naming things.</p>
</blockquote>
<p>Programs used to be written in binary. That is, the only names we had were those the computer understood directly. Over time, we've improved programming languages so that they are better for people to read and write. A lot of that improvement is building in higher-level concepts, such as functions, garbage-collection, etc. But <strong>the majority of the improvement comes from the ability to name things</strong>.</p>
<p>Naming things helps us organize our ideas about the software<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup>. A program has to deal with many levels of abstraction. We write about how data gets represented in the machine, how that relates to domain concepts, and what the user is intending to do. <strong>Naming things helps us organize those, just like good headings in an outline help us organize ideas about a topic.</strong></p>
<p>And yet it is one of the hardest problems we solve regularly. There are times when I have looked for a good name for hours, only to find none. <strong>A bad name can cost a lot.</strong> Someone coming in later could be confused, wasting precious cognitive resources.</p>
<p>Naming is hard because of a fundamental property of abstraction: <strong>the name does not have to relate at all to what it is naming</strong>. Names are just a string of letters. They're not meaningful to the machine, just to us. Names can lie, and that's a fundamental part of carrying meaning. If you could not lie, you could not convey new truthful information, either. And even truthful names can begin to diverge with the original code with time.</p>
<p>Naming is hard because it's a different kind of thinking from the rest of programming. We are coding along, in a nice engineering flow, and all of a sudden, we need a nice, human-readable name. <strong>We need to find compassion for the reader from within our cold, calculating programmer trance.</strong> This is very difficult.</p>
<p>Naming is hard because names need to be at the right abstraction level. Are you doing a low-level trie operation? Or is it a concept from the problem domain? <strong>Another choice to make.</strong> But it gets worse! Domain experts invent new words all the time. They're called <em>jargon</em>. And they're very useful. Maybe you should <em>invent</em> a name, instead of trying to <em>find</em> a name. Another difficult choice.</p>
<p>When I'm having trouble naming something, there is often <strong>an easy change to the code that makes the name unnecessary</strong>. If we can avoid having to name something (while also keeping the code readable), we've avoided a very costly and error-prone process. Here are a few alternatives I use a lot:</p>
<ul>
<li><p><strong>Inline the code.</strong> Inline expressions don't need names. This works really well with anonymous functions.</p></li>
<li><p><strong>Use threading.</strong> Instead of naming each intermediate value, thread the value through the process without naming it.</p></li>
<li><p><strong>Name something else at a different level of abstraction.</strong> We're constantly switching the level of abstraction we're working at. Try going up or down the levels. It could be that there is something easy to name at an adjacent level that does the same thing.</p></li>
<li><p><strong>Split it in two.</strong> Are you trying to name something that's really two things? If the two parts are easier to name, it's a good sign that you should split.</p></li>
</ul>
<p>You'll notice these all play with the <em>means of combination</em> instead of naming. <strong>Recombine to avoid naming when naming is hard.</strong></p>
<p>Since there are so many alternatives to naming that are easier than naming, it follows that <strong>if there is a bad name in our code, it means there might be a better way to organize</strong> it that we overlooked. That makes it a code smell. A little (re)<a href="http://www.lispcast.com/stop-refactoring-and-start-factoring">factoring</a> can get rid of that name.</p>
<div class="article-cg-box">
  <h3>
You may like the Clojure Gazette
</h3>
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/lambda-abstraction">Lambda Abstraction</a></li>
<li><a href="http://www.lispcast.com/the-content-of-your-code">The Content of Your Code</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Abelson and Sussman in <a href="http://mitpress.mit.edu/sicp/full-text/book/book-Z-H-10.html#%_sec_1.1">SICP 1.1</a>:</p>
<blockquote>
<p>A powerful programming language is more than just a means for instructing a computer to perform tasks. The language also serves as a framework within which we organize our ideas about processes. Thus, when we describe a language, we should pay particular attention to the means that the language provides for combining simple ideas to form more complex ideas. Every powerful language has three mechanisms for accomplishing this:</p>
<p><strong>primitive expressions</strong>, which represent the simplest entities the language is concerned with,</p>
<p><strong>means of combination</strong>, by which compound elements are built from simpler ones, and</p>
<p><strong>means of abstraction</strong>, by which compound elements can be named and manipulated as units.</p>
</blockquote>
<a href="#fnref1">â†©</a></li>
</ol>
</div>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/mastering-client-side-routing-with-secretary-and-goog-history">
            Mastering ClojureScript Routing with Secretary and goog.History
          </a>
        </h2>

        <div class="timestamp">
          June 24, 2015
        </div>

        
<p>Summary: <em>The Google Closure Library provides a nice interface to the HTML5 History API. Coupling it with Secretary is very easy. But not all browsers support HTML5 History. In this post I'll talk about one way to make sure you have client-side routing in all browsers.</em></p>
<h3 id="background">Background</h3>
<p><em>About a year ago I was working for a company of three people. Two coders and one business person. I was developing a consumer product and the other programmer was building a related B2B product. We were as agile as could be: no planning meetings, no prioritized list of features, just a shared vision. I was working in Clojure and ClojureScript and getting paid to do it.</em></p>
<p><em>That job eventually disappeared. But the amount of code I produced and the dark corners of features I explored still surprises me. I discovered (uncovered?) a lot of gems of ClojureScript in that time. This post is about one of them.</em></p>
<p><strong>Update</strong>: Andre Rauh pointed out that I was using a require when I should use an import for <code>goog.history.EventType</code>. I fixed it in the code. Thanks!</p>
<h3 id="browser-history">Browser History</h3>
<p>In a project I did about a year ago, we wanted the speed of a single page application but we wanted the back button to work and we wanted the URL to reflect where the reader was in the app. We turned to the <strong>HTML5 History API</strong>.</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Web/API/History">HTML5 History API</a> is an API for manipulating the browser's history without making a request to the server and loading a new page. The idea is that <strong>your Javascript application can keep all of its state in memory, but still change the URLs and keep the back button working</strong>. You have to code it up yourself, but it gives you fine-grained control over what exactly the back button does.</p>
<p>Luckily (and not surprisingly), the Google Closure Library has a nice way to access the History API. It's in a class called <a href="https://closure-library.googlecode.com/git-history/docs/class_goog_history_Html5History.html"><code>goog.history.Html5History</code></a>. That gives you <strong>events about when the URL changes</strong>. We used that along with <a href="https://github.com/gf3/secretary">Secretary</a> to parse, interpret, and dispatch on the URL.</p>
<h3 id="the-code">The code</h3>
<p>First, we set up our <code>ns</code> declaration.</p>
<pre><code>(ns history.core
  (:require
   [secretary.core :as secretary :refer-macros [defroute]]
   [goog.events])
  (:import
   [goog.history Html5History EventType]))</code></pre>
<p>We need a function that will get the current path fragment to switch on. We'll just use the path and the query string.</p>
<pre><code>(defn get-token []
  (str js/window.location.pathname js/window.location.search))</code></pre>
<p>Now we define how to instatiate the history object.</p>
<pre><code>(defn make-history []
  (doto (Html5History.)
    (.setPathPrefix (str js/window.location.protocol
                         &quot;//&quot;
                         js/window.location.host))
    (.setUseFragment false)))</code></pre>
<p>Let's make a couple of simple routes. I won't go into how to make routes with Secretary in this post.</p>
<pre><code>(defroute home-page &quot;/&quot; []
  (js/console.log &quot;Homepage!&quot;))

(defroute default-route &quot;*&quot; []
  (js/console.log (str &quot;unknown route: &quot; (get-token))))</code></pre>
<p>Now a handler for what to do when the URL changes.</p>
<pre><code>(defn handle-url-change [e]
  ;; log the event object to console for inspection
  (js/console.log e)
  ;; and let&#39;s see the token
  (js/console.log (str &quot;Navigating: &quot; (get-token)))
  ;; we are checking if this event is due to user action,
  ;; such as click a link, a back button, etc.
  ;; as opposed to programmatically setting the URL with the API
  (when-not (.-isNavigation e)
    ;; in this case, we&#39;re setting it
    (js/console.log &quot;Token set programmatically&quot;)
    ;; let&#39;s scroll to the top to simulate a navigation
    (js/window.scrollTo 0 0))
  ;; dispatch on the token
  (secretary/dispatch! (get-token)))</code></pre>
<p>Now we set up our global history object. We use <code>defonce</code> so we can <strong>hot reload the code</strong>.</p>
<pre><code>(defonce history (doto (make-history)
                   (goog.events/listen EventType.NAVIGATE
                                       ;; wrap in a fn to allow live reloading
                                       #(handle-url-change %))
                   (.setEnabled true)))</code></pre>
<p>And we will want a function to programmatically change the URL (and add to the history).</p>
<pre><code>(defn nav! [token]
  (.setToken history token))</code></pre>
<h3 id="om-example-link">Om example link</h3>
<p>Incidentally, my links look like this in Om:</p>
<pre><code>(dom/a
  #js {:href &quot;/some/page&quot;
       :onClick #(do
                   (.preventDefault %)
                   (nav! &quot;/some/page&quot;))}
  &quot;some page&quot;)</code></pre>
<p>That is, I try to follow the principle of graceful fallback. If Javascript fails for some reason, the <code>href</code> is still valid. It will make a request to the server and fetch the page. But if Javascript is working, we override it.</p>
<p>On the server side, I make sure that the same routes exist and that they return valid pages that include this script. When the page loads, the <code>EventType.NAVIGATE</code> event will fire, and so Secretary will route it. This usually means a repaint, but it's very quick and acceptable.</p>
<p>Add the requires:</p>
<pre><code>   [om.core :as om]
   [om.dom :as dom]</code></pre>
<p>And the Om code to render and get it started:</p>
<pre><code>(defonce state (atom {}))

(defn cmp-link [cursor owner]
  (reify
    om/IRender
    (render [_]
      (dom/a
       #js {:href &quot;/some/link&quot;
            :onClick #(do
                        (.preventDefault %)
                        (nav! &quot;/some/link&quot;))}
       &quot;some link&quot;))))

(om/root cmp-link state
         {:target (. js/document (getElementById &quot;app&quot;))})</code></pre>
<p>When you click the link, you should see a message in the console saying it's navigating to <code>/some/link</code>.</p>
<h3 id="a-hitch">A hitch</h3>
<p>I was using this for a while when I got a message about it not working for someone. After a little investigation, it turned out they were using an older version of IE. :( <strong>IE &lt;= 9 does not support HTML5 History.</strong> In fact, according to caniuse.com, <a href="http://caniuse.com/#feat=history">only 88.2% of users have a browser with HTML5 support</a>. That means that 12 out of every 100 visitors can't use what we just wrote.</p>
<p>What a lot of people would do at this point is just to use the hash-based history wrangling that <a href="http://caniuse.com/#search=hash">93% of the internet supports</a>. But I wanted to do better without punishing people who upgrade their browsers.</p>
<p>Here's what I did: the server still serves content at URLs as normal. The routes on the client stay the same. <em>But</em> I used feature detection to <strong>determine if the browser supports HTML5 History</strong>. If it does support it, it runs the code above. If it doesn't, it uses the hash API. Lucky for me, Google Closure has a class called <a href="https://closure-library.googlecode.com/git-history/docs/class_goog_History.html"><code>goog.History</code></a> that is interface-compatible with <code>goog.history.Html5History</code>. So 90% of the work was done.</p>
<p>First, we need to add this import:</p>
<pre><code>  [goog History]</code></pre>
<p><code>goog.history.Html5History</code> required a tiny little patch to work.</p>
<pre><code>;; Replace this method:
;;  https://closure-library.googlecode.com/git-history/docs/local_closure_goog_history_html5history.js.source.html#line237
(aset js/goog.history.Html5History.prototype &quot;getUrl_&quot;
      (fn [token]
        (this-as this
          (if (.-useFragment_ this)
            (str &quot;#&quot; token)
            (str (.-pathPrefix_ this) token)))))</code></pre>
<p>I was very reluctant to do that, but it was the only solution I found to making it work consistently with the query string. Unfortunately, it was done a year ago and I don't remember the exact reason.</p>
<p>Now we need to modify <code>get-token</code> so it works in both cases. In the case HTML5 History is not supported, the token is everything after the <code>#</code> if we're on <code>/</code>.</p>
<pre><code>(defn get-token []
  (if (Html5History.isSupported)
    (str js/window.location.pathname js/window.location.search)
    (if (= js/window.location.pathname &quot;/&quot;)
      (.substring js/window.location.hash 1)
      (str js/window.location.pathname js/window.location.search))))</code></pre>
<p><code>make-history</code> is different, too. If we don't support HTML5 History, we check if we're on <code>/</code>. If not, we redirect to <code>/</code> with the token. If we are, we construct an instance of <code>goog.History</code>.</p>
<pre><code>(defn make-history []
  (if (Html5History.isSupported)
    (doto (Html5History.)
      (.setPathPrefix (str js/window.location.protocol
                           &quot;//&quot;
                           js/window.location.host))
      (.setUseFragment false))
    (if (not= &quot;/&quot; js/window.location.pathname)
      (aset js/window &quot;location&quot; (str &quot;/#&quot; (get-token)))
      (History.))))</code></pre>
<p>Everything else is the same! You can even test out what happens without the HTML5 History API by replacing the <code>(Html5History.isSupported)</code> with <code>false</code> in both places in the code above. You'll see it start to use the <code>#</code> fragment when you click the link!</p>
<h3 id="conclusions">Conclusions</h3>
<p>I figured out all of this stuff incrementally by experimentation. I wanted to share this with you because I think it's valuable. The biggest lesson to take away is that <strong>the Google Closure Library is <em>very</em> complete and well-built</strong>. We should lean on it as much as we can from ClojureScript.</p>
<p>If you're interested in learning some ClojureScript, Om, and how to make Single Page Applications, I have to recommend my LispCast Single Page Applications with ClojureScript and Om course. It's interactive with lots of animations, exercises, screencasts, and code. It's designed to get you <strong>up and running with a smooth dev process all the way through deploying code to production</strong>. It won't teach you <em>everything</em> about ClojureScript and Om, but it will get you over lots of the major hurdles we all encounter.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get free Clojure stuff and news on ClojureScript courses
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/spaom-cover.jpg">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
The LispCast Single Page Applications with ClojureScript and Om course is in development <em>right now</em>! Sign up here to get news as it's being created and learn when it will launch. Also, you'll get to download all of the free stuff for learning and using Clojure.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][64]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/core-async-browser-motivation">core.async in Browsers</a></li>
<li><a href="http://www.lispcast.com/react-another-level-of-indirection">React: Another Level of Indirection</a></li>
<li><a href="http://www.lispcast.com/pre-conj-anna-pawlicka">Pre-conj Prep: Anna Pawlicka</a></li>
<li><a href="http://www.lispcast.com/pre-conj-interview-anna-pawlicka">Pre-Conj Interview: Anna Pawlicka</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/clojure-database-test-faster">
            How I made my Clojure database tests 5x faster
          </a>
        </h2>

        <div class="timestamp">
          June 17, 2015
        </div>

        
<p>Summary: <em>Setting up and tearing down a test database can be slow. Use a rolled back transaction to quickly reset the database to a known state. You can do that in an <code>:each</code> fixture to run each test in isolation.</em></p>
<p>On one of my projects, I wrote a bunch of tests that had to hit the database. There was a <code>:once</code> fixture to create all of the tables anew and an <code>:each</code> fixture to delete everything in the tables before each test. That ensured that <strong>I was always working with a known empty database</strong>. Overall, the tests took about 10 seconds. Woah! That's a long time. But I lived with it.</p>
<pre><code>(defn clear
  &quot;Delete all rows before and after, just for good measure.
  [test]
  (cleardb db) ;; delete all rows from all tables
  (try
    (test)
    (finally
      (cleardb db))))

(defn setupdb [tests]
  (initdb db) ;; create the tables
  (try
    (tests)
    (finally
      (teardown db)))) ;; drop the tables

(use-fixtures :each clear)
(use-fixtures :once setupdb)</code></pre>
<p>Then I remembered a technique someone once mentioned where you <strong>use a transaction that you roll back</strong> instead of starting with a fresh db each time. It's supposed to be a lot faster.</p>
<p>After a little experimentation, I came up with this:</p>
<pre><code>(defn clear [test]
  (sql/with-db-transaction [db db]
    (sql/db-set-rollback-only! db)
    (binding [db db] ;; rebind dynamic var db, used in tests
      (test))))</code></pre>
<p>We open a transaction, immediately set it to rollback (which it will do when the transaction closes). Then we have to rebind our dynamic <code>db</code> var, which holds the current connection. And inside of that we run the test. Inside of the transaction, anything you write to the database will be available to read. When the test ends, <strong>the transaction closes and it rolls back all of the changes</strong>, leaving the database empty again.</p>
<p>The result? Running the tests went <strong>from 10 seconds to 2 seconds</strong>. They still start and end with a clean database, but it's done faster with a transaction.</p>
<p>The one gotcha that I ran into was that the PostgreSQL function <strong><code>now()</code> was always returning the same time within the transaction</strong>. I had made an assumption (that was true before) that different calls would happen at different times. That assumption was no longer true inside the transaction. I had to fix the code to not rely on time.</p>
<p>The other part of this technique, which I did not really have to use, was that <strong>you can set up your database with test data</strong> in the <code>:once</code> fixture. It's costly to set up the test data, but because you're rolling back transactions, once it's set up it's quick to reset it.</p>
<p>If you'd like to <strong>learn more about testing in Clojure</strong>, you might be interested in my <a href="http://www.purelyfunctional.tv/intro-to-clojure-test">LispCast Intro to clojure.test</a>. In it, we cover test namespaces, assertions, running your tests, and of course fixtures. It's an interactive course with exercises, screencasts, animations, and code. You should also check out the free cheatsheet below.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    <h3 class="subscribe-form-title">
      
Get a Free clojure.test Cheatsheet
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/clojure.test cheatsheet.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of the clojure.test cheatsheet. If you write Clojure or ClojureScript, this cheatsheet contains the most important functions in a handy format. I've spent a lot of time formatting and annotating the most used functions and macros from clojure.test so that they fit onto one page and everything is easy to understand.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][32]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/announcing-lispcast-intro-to-clojure-test">Announcing: LispCast Intro to clojure.test</a></li>
<li><a href="http://www.lispcast.com/clojure-test-cheatsheet">clojure.test cheatsheet</a></li>
<li><a href="http://www.lispcast.com/clojure-test-directory">Clojure Test Directory</a></li>
<li><a href="http://www.lispcast.com/clojure-test-launch">LispCast Intro to clojure.test</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/tdd-workflow-in-clojure-with-emacs-and-cider">
            TDD Workflow in Clojure using Emacs with CIDER
          </a>
        </h2>

        <div class="timestamp">
          June 08, 2015
        </div>

        
<p>Summary: <em>TDD is about fast feedback. CIDER tightens the feedback loop with quick commands for running tests and a powerful test reporting system.</em></p>
<h3 id="introduction">Introduction</h3>
<p>I've always been into flow. One of the key aspects of flow is a short feedback loop. Test Driven Development (TDD) is partially based on flow, too. You write a new test, then you write code to satisfy the test, then you refactor. You cycle quickly with very small steps. Great for flow!</p>
<p>Now, I'm not going to be a pedant in this post about what is and what is not TDD. Sometimes I like to adhere to a strict discipline of TDD. And sometimes I like to code fast and loose. But as a working definition, for the purposes of this article, I'll define TDD as writing code and tests incrementally, and running the tests fairly often. <strong>The last thing you want is to have to wait for those tests to run.</strong></p>
<p>Luckily, CIDER<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup> has been optimized to make the whole process smooth, fast, and feedbacky. You can learn about installing CIDER <a href="https://github.com/clojure-emacs/cider/wiki/Installation">here</a>. Or <script type="text/javascript">
<!--
h='&#108;&#x69;&#x73;&#112;&#x63;&#x61;&#x73;&#116;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#x65;&#114;&#x69;&#x63;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+'ask me any time for help'+'<\/'+'a'+'>');
// -->
</script><noscript>&#x61;&#x73;&#x6b;&#32;&#x6d;&#x65;&#32;&#x61;&#110;&#x79;&#32;&#116;&#x69;&#x6d;&#x65;&#32;&#102;&#x6f;&#114;&#32;&#104;&#x65;&#108;&#112;&#32;&#40;&#x65;&#114;&#x69;&#x63;&#32;&#x61;&#116;&#32;&#108;&#x69;&#x73;&#112;&#x63;&#x61;&#x73;&#116;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;&#x29;</noscript> if you run into trouble.</p>
<h3 id="what-you-need-to-know">What you need to know</h3>
<p>First, you'll need CIDER connected to the REPL (usually just <code>C-c M-j</code>).</p>
<p>Besides the basic commands for switching buffers (<code>C-c b</code>), I use just one command a ton while I'm TDD'ing:</p>
<ul>
<li><code>C-c ,</code> (That's Control-c comma.) While you're in a buffer, it will run the tests for that buffer. It could be that you're in production code, in which case it will try to find the <a href="http://www.lispcast.com/clojure-test-directory">corresponding test namespace</a> and run tests there.</li>
</ul>
<p>That will give you just the feedback you need: a green status report in the status bar if everything passes. And a new buffer with a <strong>failure and error report</strong> if it's not passing. You can do some cool stuff in that buffer, like jumping to the test definition, rerunning individual tests, and seeing diffs of actual vs. expected output. Look <a href="https://github.com/clojure-emacs/cider#cider-test-report-mode">here</a> for a quick reference to the available key bindings.</p>
<p>But mostly I'm editing code, compiling it (with <code>C-c C-k</code>), and running the tests (<code>C-c ,</code>) to make sure they pass now. Unlike with running <code>lein test</code> at the command line, this command <strong>only runs the tests for that specific namespace</strong>. This is usually what you want while you're editing code in the namespace. After you're done, you'll want to rerun all of the tests in a fresh JVM at the command line.</p>
<h3 id="conclusions">Conclusions</h3>
<p>Getting a productive workflow set up is really important. It's hard on our nerves to be waiting through long feedback cycles. <strong>CIDER tightens those loops</strong> down to human scale so we can focus on the work of making the world better.</p>
<p>If you'd like to learn more about testing in Clojure, including how to write tests so that they work seamlessly with Leiningen and CIDER, I have to recommend my <a href="http://purelyfunctional.tv/intro-to-clojure-test">LispCast Intro to clojure.test</a> course. It covers the most <strong>important and fundamental concepts and skills</strong> for testing in Clojure. You should not miss the <em>free</em> <code>clojure.test</code> cheat sheet below.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    <h3 class="subscribe-form-title">
      
Get a Free clojure.test Cheatsheet
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/clojure.test cheatsheet.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of the clojure.test cheatsheet. If you write Clojure or ClojureScript, this cheatsheet contains the most important functions in a handy format. I've spent a lot of time formatting and annotating the most used functions and macros from clojure.test so that they fit onto one page and everything is easy to understand.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][32]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/announcing-lispcast-intro-to-clojure-test">Announcing: LispCast Intro to clojure.test</a></li>
<li><a href="http://www.lispcast.com/clojure-database-test-faster">How I made my Clojure database tests 5x faster</a></li>
<li><a href="http://www.lispcast.com/clojure-test-cheatsheet">clojure.test cheatsheet</a></li>
<li><a href="http://www.lispcast.com/clojure-test-directory">Clojure Test Directory</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p><a href="https://github.com/clojure-emacs/cider">CIDER</a> is an Emacs package for rocking Clojure code.<a href="#fnref1">â†©</a></p></li>
</ol>
</div>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/lambda-abstraction">
            Lambda Abstraction
          </a>
        </h2>

        <div class="timestamp">
          May 17, 2015
        </div>

        
<p>Summary: <em>Lambda abstractions are always leaky, but some are leakier than others. Clojure programmers recommend keeping most of your functions pure and containing the leaks as much as possible.</em></p>
<p>Lambda abstraction refers to something we do all of the time. Let's say I have some code:</p>
<pre><code>(+ 1 2)</code></pre>
<p>I'm adding the number 2 to a number, in this case, 1. I could abstract that into a <em>lambda</em>:</p>
<pre><code>(defn add2 [x] (+ x 2))</code></pre>
<p>Now it's a function, which I can apply to 1. <code>(add2 1)</code>. I can apply it to any number I want. The actual thing I am adding 2 to is abstracted away and replaced by the variable <code>x</code>. <strong>Lambda abstractions are just functions.</strong></p>
<p>Functional programming is at its best when lambda abstractions are referentially transparent. That means that given the same arguments, a function will always return the same value. Being referentially transparent makes a <strong>software function more like a mathematical function</strong>. And that lets you reason about your code.</p>
<p>But there's a very real difference between software functions and mathematical functions: <strong>mathematical functions take no time or energy to &quot;compute&quot;</strong>. They are defined abstractly, with no notion of computation. In contrast, software functions always take some time to compute. Sometimes the clearest way to write a function takes enough time that the illusion of mathematical functions is shattered. <strong>The abstraction is leaky.</strong></p>
<p>So software functions are already a leaky abstraction, even if they are referentially transparent. Clojure (like most programming languages) opens the leak even further: <strong>you can put stuff that's not referentially transparent right in your function</strong>. For instance, you can write a &quot;function&quot; that reads from the disk or makes a web request. Making the same request twice can obviously return different values.</p>
<p>What most people programming Clojure recommend is to program <em>mostly</em> with pure functions (that means referentially transparent). You still have to deal with time, but that's way easier than dealing with the chaos of the world outside. That leaves a small bit of your code to deal with mutation, input/output, and the disk. It's still a lambda abstraction (function) but <strong>it's just leakier</strong>. Clojure simply leaves the decision up to you where to draw the line. Clojure tries to make pure functions easy, even when not everything fits into pure functions.</p>
<p>The takeaway of functional programming is the same recommendation: <strong>write <em>most</em> of your code as referentially transparent functions</strong>. The degree to which a language helps you do that is how &quot;functional&quot; the language is.</p>
<p>If you'd like to learn more about Clojure and pure functions, check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's 2.5 hours of high quality video. You probably haven't seen anything <a href="http://www.purelyfunctional.tv/intro-to-clojure#preview">like this</a>! There's animations, exercises, characters, and screencasts. It takes you from no knowledge to a deep experience, all while having fun!</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/avoid-naming-at-all-costs">Avoid Naming at All Costs</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/infinite-application">
            Infinite Application
          </a>
        </h2>

        <div class="timestamp">
          May 17, 2015
        </div>

        
<p>Summary: <em>Function application is a key concept in lambda calculus. While it is commonly expressed using parentheses in Clojure, it is also reified into a function which itself can be applied to another function.</em></p>
<p>Function application in Clojure is easily expressed with a couple of parentheses:</p>
<pre><code>(foo 1 2 3)</code></pre>
<p>That's the function <code>foo</code> applied to the arguments <code>1</code>, <code>2</code>, and <code>3</code>. But let's say we have those numbers in a vector somewhere, and we want to call <code>foo</code> on them.</p>
<pre><code>(def some-numbers [1 2 3])</code></pre>
<p>We could manually pull out the arguments from the vector like this:</p>
<pre><code>(foo (some-numbers 0) (some-numbers 1) (some-numbers 2))</code></pre>
<p>Great! That should work. But more commonly you see this:</p>
<pre><code>(apply foo some-numbers)</code></pre>
<p><code>apply</code> means take the function (the first argument) and apply it to the arguments which are in the list (the last argument). <code>apply</code> pulls out the values from the list internally so you don't have to.</p>
<p><code>apply</code> is a function you'll see in many Lisps. It plays a key role in the <a href="http://en.wikipedia.org/wiki/Meta-circular_evaluator">meta-circular evaluator</a> as defined in <em>The Structure and Interpretation of Computer Programs</em> (SICP). In the meta-circular evaluator, <code>eval</code> and <code>apply</code> are defined in terms of each other.</p>
<p>The way <code>eval</code> is defined classically, <code>(foo 1 2 3)</code> gets turned into <code>(apply foo [1 2 3])</code> internally. This means that you can replace <code>(foo 1 2 3)</code> with <code>(apply foo [1 2 3])</code> in the program without changing the meaning.</p>
<p>But! Since <code>apply</code> is a function, <code>(apply foo [1 2 3])</code> is equivalent to <code>(apply apply [foo [1 2 3]])</code>, which is equivalent to <code>(apply apply [apply [foo [1 2 3]]])</code>. And you can expand that out forever. (Please don't!).</p>
<p><code>apply</code> is something I really love about Lisp. It takes <strong>one of the main parts of lambda calculus (function application) and <a href="http://www.lispcast.com/reification">reifies</a> it</strong>. Function application is available as a function, which can be passed around, composed, etc, <strong>just like any other value</strong>. I love it!</p>
<p>If you're in love with this idea, too, you might want to check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's my video course about, you guessed it, Clojure. It takes you from absolute parenthesis-phobe to I-never-knew-it-could-be-this-way lisper by using animations, exercises, and screencasts.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/just-hack-something-together">Just Hack Something Together</a></li>
<li><a href="http://www.lispcast.com/a-personal-lisp-crisis">A Personal Lisp Crisis</a></li>
<li><a href="http://www.lispcast.com/reification">Reification</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/the-world-is-mutable">
            But the World is Mutable
          </a>
        </h2>

        <div class="timestamp">
          May 11, 2015
        </div>

        
<p>Summary: <em>The world may be mutable, but people have been using the notion of immutability to build reliable systems for a long time.</em></p>
<p>Immutability is a hard topic to breach. As a programmer used to modeling the world, you might object to immutable data structures. How do you model a changing world? <strong>Why would you choose to use immutable data structures when everything in the world is changeable?</strong></p>
<p>Let's do a little thought experiment. Let's look at <strong>a nice mutable system</strong>: paper and pencil. You can write, erase, and write again. It's very convenient. It lets you correct mistakes. And when you don't need something anymore, you can easily erase it.</p>
<p>Now answer this: <strong>would you trust a bank that used pencils to record transactions?</strong> It would be easy: whenever you would withdraw money, they would erase the old balance and write the new balance. And if you transferred money from one account to another, they'd erase two balances and write the new ones in. It may sound great, but there's a reason banks don't use pencils: they want to be sure <strong>nothing has changed</strong>. That sounds like immutability.</p>
<div class="figure">
<img src="http://www.lispcast.com/img/ledger.jpg" alt="Bank ledger (photo credit)" /><p class="caption">Bank ledger (<a href="https://www.nottingham.ac.uk/manuscriptsandspecialcollections/researchguidance/accounting/business.aspx">photo credit</a>)</p>
</div>
<p>This is a bank ledger. Each transaction gets its own line. Always done in pen. It's an example of an append-only data structure. You can answer questions about the past like &quot;How much money was in the account at the close of last Tuesday?&quot; by going up lines until you find the last entry for Tuesday. And you can do that because you never modify existing entries. You only add new entries on blank lines.</p>
<div class="figure">
<img src="http://www.lispcast.com/img/medicalrecords.jpg" alt="Medical record system (photo credit)" /><p class="caption">Medical record system (<a href="https://www.flickr.com/photos/digitaldrew/4930438982/">photo credit</a>)</p>
</div>
<p>This is another example of an append-only data structure in the real world: medical records. Each patient gets a file that everything is added to. You never modify old records. That way, everything is recorded, even the wrong diagnoses (mistakes) of the doctor.</p>
<p>It turns out that traditional systems that <strong>need a high degree reliability create immutable records out of mutable paper</strong>. Even though you could in theory scratch out some data and write it again, or white it out, or find some other way to mutate the document, a mark of professionalism in the job is to <strong>discipline yourself to adhere to strict append-only behaviors</strong>.</p>
<p>Wouldn't it be nice if the machine took care of the discipline for us? Even though RAM and disk are mutable like paper and pen, we can impose a discipline inside of our program. We <em>could</em> rely on the programmer to never accidentally overwrite existing data. But that's just shifting the burden. Instead, we can build in immutability into our data structures and make a paper that cannot be overwritten.</p>
<p>That's how immutable data structures work. <strong>All new pieces of information are written to new locations in memory.</strong> Only when it is proven that a location is never going to be used again is it reused.</p>
<p>Reliable paper-based systems use immutable data. There was a time when computer memory was expensive when we had to reuse storage, so we couldn't make immutable systems. But RAM is cheap now! We should be using immutable data, just as <strong>banks have done for hundreds of years</strong>. Ready to join the 13th century?<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup></p>
<p>If you're interested in a language with a very cool set of powerful immutable data structures, probably the most <strong>cutting edge immutable data structures</strong> in any language, you're in luck! You can get <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's a video course with animations, exercises, and screencasts that teaches you Clojure so you'll learn it and remember it.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/object-function-duals-dispatch">Object-Oriented Dispatch is the Dual of Functional Dispatch</a></li>
<li><a href="http://www.lispcast.com/object-oriented-vs-functional-duals">Object-Oriented Programming is the Dual of Functional Programming</a></li>
<li><a href="http://www.lispcast.com/paper-metaphor">The Paper Metaphor</a></li>
<li><a href="http://www.lispcast.com/the-content-of-your-code">The Content of Your Code</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>The Double-entry method of accounting can trace its history back to 13th century Florence.<a href="#fnref1">â†©</a></p></li>
</ol>
</div>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <div class="notes">

      </div>

    </div>

    <footer class="footer-banner">
      <a class="footer-previous"
         href="page2.html">
        previous
      </a>
    </footer>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.0/lodash.min.js"></script>



    <script>

      document.write('<script src="https://oberon.herokuapp.com/cookie/get.js?_=' + (new Date()).getTime() + '"><\/script>');

          if(window.oberon && mixpanel) {
          if(document.cookie.indexOf('oberon-id') < 0) {
                                                    var expires = (new Date((new Date().getTime() + 1000*60*60*24*365*10))).toUTCString();
                                                    mixpanel.alias(window.oberon.id);
                                                    document.cookie = "oberon-id=" + window.oberon.id + ";expires=" + expires + ";path=/";
                                                    }
                                                    mixpanel.identify(window.oberon.id);
                                                    }

                                                    mixpanel.register({URL: window.location.pathname,
                                                    Title: $("title").text()});

                                                    mixpanel.track("Page Visit");

                                                    mixpanel.track_forms('.gazette-form', 'Submit Clojure Gazette');
                                                    mixpanel.track_forms('.subscribe-form', 'Subscribe');

                                                    mixpanel.track_links('a.homepage-offer-box-link',
                                                    'Click PurelyFunctional.tv',
                                                    function(e) {
                                                    return {ToURL: $(e).prop('href')};
                                                    });

                                                    mixpanel.track_links('a.js-clojuregazette',
                                                    'Click Clojure Gazette',
                                                    function(e) {
                                                    return {ToURL: $(e).prop('href')};
                                                    });

                                                    $('input[name=EMAIL]').change(function() {
                                                    var i = $(this);
                                                    window.o_email = i.val();
                                                    });

                                                    $('form').submit(function() {
                                                    if(window.o_email)
                                                    mixpanel.people.set({"$email": window.o_email});
                                                    });

                                                    </script>
      <script src="/js/mylibs/annotated-code.js" defer></script>
      <script src="/js/libs/codemirror.js" defer></script>
      <script src="/js/mylibs/feedback.js" defer></script>

  </body>
</html>
