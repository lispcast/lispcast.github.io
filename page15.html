<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>LispCast</title>
    <meta name="description" content="A blog about the simple joys of functional programming.">
    <meta name="author" content="Eric Normand">

    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="/css/styles.css" type="text/css">

    <link rel="alternate" type="application/rss+xml" title="LispCast" href="/feed" />

<!-- start Mixpanel --><script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
mixpanel.init("ffad2bd88d2cb690edbbba6cf30b2958");</script><!-- end Mixpanel -->
  </head>

  <body>
    <header class="banner">
      <h1 class="banner-logo">
        <a href="/">
          <img class="banner-logo-img"
               src="/img/Logo@2x.png"
               alt="LispCast" />
        </a>
      </h1>

      <div class="meta-data">
        <img class="bio-img"
             src="/img/eric_bio.jpg" />
        <a class="twitter-link"
           href="http://twitter.com/ericnormand">
          <i class="fa fa-twitter"></i>
        </a>
        <a class="github-link"
           href="https://github.com/ericnormand">
          <i class="fa fa-github"></i>
        </a>
        <a class="mail-link"
           href="mailto:eric@lispcast.com">
          <i class="fa fa-envelope"></i>
        </a>
        <a class="rss-link"
           href="/feed">
          <i class="fa fa-rss-square"></i>
        </a>
        <a class="rss-link"
           href="/archive.html">
          <i class="fa fa-list"></i>
        </a>
      </div>

    </header>

    <div class="main-container">


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/church-vs-curry-types">
              Church vs Curry Types
            </a>
          </h2>

          <div class="timestamp">
            July 15, 2014
          </div>

          
<p>Summary: <em>Static vs dynamic typing debates often flounder because the debators see from two different perspectives without knowing it. Learning to identify the two perspectives can calm the discussion. The tension between the two perspectives has led to Gradual Typing and other technologies.</em></p>
<p>Many discussions about type systems around the internet fail to be interesting because one or both parties are not versed in type theory. There's a less common (yet related) reason, which I have begun to notice more and more: people who are not familiar with the <a href="http://en.wikipedia.org/wiki/Simply_typed_lambda_calculus#Intrinsic_vs._extrinsic_interpretations">difference between Church Types and Curry Types</a>. These are also known, respectively, as Intrinsic Types and Extrinsic types. Because the participants are not aware of the two perspectives, they blame the other one for ignorance, when in fact they just have a different perspective.</p>
<p>Church Types are what Haskell has. Church types are named for Alonzo Church, the inventor of the lambda calculus. In a Church-style system, types are an <em>intrinsic</em> part of the semantics of the language. <strong>The language would be different without the types--it may even be meaningless.</strong> With an intrinsic type system, the meaning of the program is different from the runtime behavior of the program. One way to think of this is that so much of the meaning of the program occurs <em>at compile time</em> that you can begin to think of the program having properties you can reason about even if you never run the program.</p>
<p>The other kind of types are Curry types (aka extrinsic types). They are named for Haskell Curry, the man the Haskell language is named after. Curry-style types is when a system of types is applied that is <strong>not part of the semantics of the language</strong>. This is what Clojure has in <code>core.typed</code>. <strong>The meaning of a Clojure program is not dependent on it passing the type checker</strong>--it can be run without it. The type checker simply alerts you to type errors in your code. Note that you could consider your type checker to be your own head, which, as flawed as it may be, is what most Clojure programmers use. The types could be anywhere outside of the language.</p>
<p>Each perspective is valuable and bears its own fruit. Intrinsic types are great because you are <strong>guaranteed to have a mathematically-sound</strong><sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup> safety net at all times. You always have something you can <em>reason</em> about. Such is not guaranteed for extrinsic type checkers. They may not be able to reason about your code at all.</p>
<p>Extrinsic types are useful because you can apply <strong>multiple type systems to your code</strong><sup><a href="#fn2" class="footnoteRef" id="fnref2">2</a></sup>--or even write something that you don't know how to prove is sound. There are more benefits on both sides, but you get the idea.</p>
<p>We now have a new perspective which is slightly &quot;higher&quot; than either of them. We can now see that both perspectives exist and talk about them as such. <strong>What can we see/say now that we couldn't before?</strong></p>
<p>A famous <a href="http://existentialtype.wordpress.com/2011/03/19/dynamic-languages-are-static-languages/">article by Robert Harper</a> exemplifies the Church perspective very well. It argues that untyped programs are a subset of typed programs. They are programs that have a single type and all values are of that one type. So instead of being liberating, dynamic languages restrict you to one type. Notice the <strong>assumption that languages have a type system by default</strong> which is typical of the Church-style perspective. We can now say &quot;This reasoning is correct given that perspective.&quot;</p>
<p>On the other side, you'll often see a dynamic typist say the exact opposite: that well-typed programs are a subset of dynamically typed programs. In other words, well-typed programs are just dynamic programs with fewer errors. Curry-style to the core: <strong>static type errors are something that is added onto the semantics of the language</strong>. We can now see that they are right, from their perspective.</p>
<p>Here's a diagram:</p>
<div class="figure">
<img src="http://www.lispcast.com/img/ChurchvsCurry.png" alt="Church vs Curry Types Language Subset Diagrams" /><p class="caption">Church vs Curry Types Language Subset Diagrams</p>
</div>
<p>Notice how they're isomorphic? That means something, I just don't know what :)</p>
<p>My ambitious hope is that this perspective will quiet a lot of the fighting as people recognize that they are just <strong>perpetuating a rift in the field of mathematics</strong> that happened a long time ago. The perspectives are irreconcilable now, but that could change. A paper called <a href="https://www.cs.cmu.edu/~fp/papers/andrews08.pdf">Church and Curry: Combining Intrinsic and Extrinsic Typing</a> builds a language with both kinds of types. And <a href="http://www.cs.colorado.edu/~siek/pubs/pubs/2006/siek06:_gradual.pdf">Gradual Typing</a> and <a href="http://homepages.inf.ed.ac.uk/wadler/topics/blame.html">Blame Calculus</a> are investigating the intersection of static and dynamic typing. Let's stop fighting, make some cool tools and use them well.</p>
<div class="article-cg-box">
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/Hindley-Milner-in-Clojure">Hindley-Milner in Clojure</a></li>
<li><a href="http://www.lispcast.com/on-type-unity">On Type Unity</a></li>
<li><a href="http://www.lispcast.com/pre-west-nathan-sorenson">Pre-West Prep: Nathan Sorenson</a></li>
<li><a href="http://www.lispcast.com/ambrose-interview-typed-clojure">Ambrose Bonnaire-Sergeant interviewed about Typed Clojure</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>As sound as the type system in the language.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>See <a href="http://goto.ucsd.edu/~rjhala/liquid/haskell/blog/about/">Liquid Haskell</a> for an example of applying an extrinsic type system on Haskell.<a href="#fnref2">↩</a></p></li>
</ol>
</div>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/json-serialization-api-clojure">
              JSON Serialization for APIs in Clojure
            </a>
          </h2>

          <div class="timestamp">
            July 10, 2014
          </div>

          
<p>Summary: <em>Clojure is well-suited for processing JSON, but there are some decisions you have to make to suit your application. The major decisions are actually easy, though they took me a while to figure out.</em></p>
<p>I tend to use JSON instead of <a href="https://github.com/edn-format/edn"><code>edn</code></a> for an API serialization format, if only because JSON is more readily readable from other languages. I could do both, but it's good to <strong>eat your own dogfood and test those JSON code paths</strong>.<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup></p>
<p><code>edn</code> is better, but JSON is generally pretty good. However, JSON's expressibility is decidedly a subset of the Clojure data structures, so there is <strong>considerable loss of information</strong> when going from Clojure to JSON. That information is not recovered in a round-trip, at least not automatically. There are lots of decisions that have to go into how to, at least partially, recover this.</p>
<p>One bit of information that is lost is the type of keys to a map. JSON only allows strings as keys. Clojure allows anything. But most of the time, <strong>I find myself using <em>keywords</em> for keys</strong>. I say most, but really, it's the vast majority. Maps are bundles of named values pretty much all the time.<sup><a href="#fn2" class="footnoteRef" id="fnref2">2</a></sup> So the optimal decision, after trying lots of combinations, is to convert keywords to strings (the default in JSON libraries I've seen) when emitting JSON; and to convert map keys (always strings in JSON) to keywords (also known as <code>keywordize-keys</code>) when parsing JSON. That covers nearly all cases, and pinpointed special cases can cover the rest.</p>
<p>But that's not the end of the keyword/string story. What about namespaces? Surprisingly, the two major JSON libraries, <code>clojure.data.json</code> and <code>cheshire</code> handle things differently. <strong>How do you parse a JSON key that has a slash in it, indicating a namespace?</strong> If we're keywordizing (as I suggest above), they both give namespaced keywords (<code>keyword</code> will parse around the <code>/</code>). But when emitting JSON, they act differently. <code>clojure.data.json</code> will emit the <code>name</code> of the keyword (and ignore the <code>namespace</code>) while <code>cheshire</code> emits a string with <code>&quot;namespace/name&quot;</code>.</p>
<p>I like to keep the namespace, or, put another way, I like to drop as little information as possible. So I prefer the namespace approach. I'm not sure how to get <code>clojure.data.json</code> to do that. <strong>I just use <code>cheshire</code></strong>.<sup><a href="#fn3" class="footnoteRef" id="fnref3">3</a></sup> The other gotcha for namespaces is that ClojureScript's <code>clj-&gt;js</code> and <code>js-&gt;clj</code> are similarly asymetrical.<sup><a href="#fn4" class="footnoteRef" id="fnref4">4</a></sup></p>
<p>Keywords in other places besides the keys of maps will just get turned into strings, but they don't get converted back to keywords. That sucks, but it's minor. You'll just have to <strong>convert them back some other way</strong>. At work, we use <a href="https://github.com/prismatic/schema">Prismatic Schema</a>'s coercions. They do the trick nicely, in a declarative way.</p>
<p>So, back to other JSON issues. The other issue is other data types. Dates, URI's, and UUID's are in our data as well. Dates, well, it's up to you how to encode them. I've always been a fan of the Unix timestamp. It's not exactly human readable, but it's universally parseable. There's also <strong>the ISO datetime format, which is probably a better bet</strong>--it's human readable and agreed upon among API designers. You could emit that as a string and coerce back to a Date object later.</p>
<p>URI's and UUID's are by definition strings, so that's easy. How do you set up <code>cheshire</code> to handle the encoders? It's pretty simple, really.</p>
<pre><code>(cheshire.generate/add-encoder java.net.URI cheshire.generate/encode-str)</code></pre>
<p>That means add the encoder for the <code>java.net.URI</code> type to be encoded as a JSON string. <code>str</code> will be called on the value. You can figure out the other types you need. There are <strong>some JSON emission settings built-in, including Date (the ISO string format) and UUID</strong>. Weirdly URI is not in there, so you have to add it.</p>
<p>What's next? Oh, pretty-printing. Yeah, I pretty-print my JSON to go over the wire. It's nice for debugging. I mean, who wants to <code>curl</code> one long, 1000-character line of JSON? <strong>Put some whitespace</strong>, please! How to do that?</p>
<pre><code>(cheshire.core/generate-string mp {:pretty true})</code></pre>
<p>That's right, it's basically built in, but you have to specify it. But, oh man, <strong>that's long</strong>. I don't want to type that, especially because my lazy fingers are going to not do it one time, then I'm going to look at the JSON in my browser and see a one-line JSON mess. So, what do I do? I put all my JSON stuff for each project in <code>json.clj</code>. It's got all my <code>add-encoder</code> stuff, and it's got two extra functions, just for laziness<sup><a href="#fn5" class="footnoteRef" id="fnref5">5</a></sup>:</p>
<pre><code>(defn parse [s]
  (cheshire.core/parse-string s true))

(defn gen [o]
  (cheshire.core/generate-string o {:pretty true}))</code></pre>
<p>Or of course whatever options you want to pass those functions. This one is my choice--you make your choice. But <strong>these two functions are all I use most of the time</strong>. Parsing strings and generating strings. Woohoo! Much shorter and less to keep in my little head.</p>
<p>Well, that just about wraps up my JSON API story. There's the slight detail of <strong>outputting JSON from <code>liberator</code></strong>, which is its own blog post. And there's a bit of <strong>generative testing I do to really challenge my assumptions</strong> about how I set up the round-tripping. But that, too, is another blog post for another day. Oh, and what about <strong>all that JSON middleware</strong>? Again, another post.</p>
<p>If you like peanut butter and you like jelly, you will probably like peanut butter and jelly sandwiches. If you like web and you like Clojure, you will most definitely like <a href="http://www.purelyfunctional.tv/web-dev-in-clojure">Web Development in Clojure</a>, which is a <strong>gentle, soothing, visually rich video course ushering in the fundamentals of Clojure web development</strong> through your eyes and ears and down through your fingertips and into your very own Heroku-hosted web server. At least <a href="http://www.purelyfunctional.tv/web-dev-in-clojure#preview">watch the preview</a>!</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get a Free Ring Spec to hang on your wall
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/ring_spec_1_3.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of a Ring Spec to hang on your wall. If you are programming in Ring (covered in the videos), you'll find it very useful as a reference. You'll also hear about exclusive previews and discounts of other video courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][4]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/cascading-separation-abstraction">Separation, Abstraction, and Cascading in CSS</a></li>
<li><a href="http://www.lispcast.com/clojure-web-security">Clojure Web Security</a></li>
<li><a href="http://www.lispcast.com/hiccup-tips">Hiccup Tips</a></li>
<li><a href="http://www.lispcast.com/parts-of-ring">The Parts of Ring</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>It may be hubristic to think anyone else will use my API.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>There are exceptions, but these typically are not communicated to the outside. Those that are need special-casing. C'est la vie!<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p><code>:key-fn</code> in <code>clojure.data.json</code> only works for keys, not all keywords. Emitting a keyword in any other place emits the <code>str</code> of it, which includes the <code>:</code> in the string. Ick.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p><code>clj-&gt;js</code> uses <code>name</code> for keywords and <code>str</code> for symbols, so keywords lose their namespace when emitting JSON, but retain their namespace when parsing key strings as keywords.<a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>also known as ease, peace of mind, DRY, and cleanliness<a href="#fnref5">↩</a></p></li>
</ol>
</div>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/what-is-functional-programming">
              What is Functional Programming?
            </a>
          </h2>

          <div class="timestamp">
            July 01, 2014
          </div>

          
<p>Summary: <em>I prefer to define Functional Programming as making a distinction between pure and impure code. With this definition, you can program functionally in any language. What differentiates the functional languages is how much help they give you to make the distinction.</em></p>
<p>There are a lot of conflicting definitions of Functional Programming out there. <strong>I'd like to share mine, which serves me well.</strong> It explains why Haskell is more functional than Scheme, and also how you can program functionally in a non-functional language like Java.</p>
<p><strong>Functional programming means programming with a distinction between pure code and impure code.</strong> Pure code has no side effects. It's referentially transparent. It means the same thing every time you run it. Impure code contains side effects, so running it twice is different from running it once.</p>
<p><strong>The distinction between pure code and impure code uniquely identifies functional programming and distinguishes it from other paradigms such as procedural and Object Oriented.</strong> Procedural is about modeling your solution as sequential steps. Object Oriented is about modeling your solution as communicating objects. Functional programming is about modeling your solution as pure functions.</p>
<p>Now, this definition is very practical. Notice that it's not about choice of language. <strong>You can write functional code in any language</strong>, just as you can code up an object system in C and say you're doing OO. The question is how much the language <em>helps</em> you write functional code or OO code.</p>
<p>On one extreme, you've got Haskell. There is no doubt that Haskell is a functional language. How does it help you write functional code? It has no mutable values and side-effects are confined to a single type: <code>IO</code>. <strong>The language forces you to make the distinction between pure and impure.</strong></p>
<p>On the other extreme, you've got machine code or assembly. At the lowest level, the language pushes you to avoid the distinction. <strong>All operations are about changing at least one location in memory.</strong> It could be a register or the top of the stack or something. But you are forced to change something. However, with a lot of super-human discipline, you could keep the distinction in your head. You might create a little heap and keep the discipline &quot;a procedure can only write to memory it allocates directly&quot;. And this way, you make a bit of room for some functional programming. <strong>But that language is not giving you any help.</strong></p>
<p>So why functional programming? Well, it turns out that knowing that running code twice will produce the same result makes it <strong>very easy to reason about</strong> it. And reasoning about code is basically our job as software engineers. What's more, the kind of reasoning you can do with functional programs can reach all the way up to the highest forms of reasoning, like math. That's where Haskell really shines. All of the category theory stuff (monads, functors, applicatives, etc) is an expression of that--mathematical concepts that are applicable in Haskell code.</p>
<p>That's it. That's my definition. The definition is <strong>inclusive yet gets at the essence</strong>. Functional Programming is a perspective that makes code easier to understand and maintain as it's being used in a system complex beyond your possible comprehension. And at its most sublime and abstract levels, Functional Programming approaches mathematical reasoning.</p>
<p>If you'd like to get started with Functional Programming in Clojure, you can do worse than using the <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a> video course.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>


<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/object-function-duals-dispatch">Object-Oriented Dispatch is the Dual of Functional Dispatch</a></li>
<li><a href="http://www.lispcast.com/object-oriented-vs-functional-duals">Object-Oriented Programming is the Dual of Functional Programming</a></li>
<li><a href="http://www.lispcast.com/paper-metaphor">The Paper Metaphor</a></li>
<li><a href="http://www.lispcast.com/the-content-of-your-code">The Content of Your Code</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/core-async-code-style">
              core.async Code Style
            </a>
          </h2>

          <div class="timestamp">
            June 10, 2014
          </div>

          
<p>Summary: <em>If your functions return <code>core.async</code> channels instead of taking callbacks, you encourage them to be called within <code>go</code> blocks. Unchecked, this encouragement could proliferate your use of <code>go</code> blocks unnecessarily. There are some coding conventions that can minimize this problem.</em></p>
<p>I've been using (and enjoying!) <code>core.async</code> for about a year now (mostly in ClojureScript). It has been a huge help for <strong>easily building concurrency patterns</strong> that would be incredibly difficult to engineer (and maintain and change) without it.</p>
<p>Over that year, I've developed <strong>some practices for writing code with <code>core.async</code></strong>. I'm putting them here as an <a href="http://discuss.purelyfunctional.tv/t/core-async-code-styles/46">invitation for discussion</a>.</p>
<h3 id="use-callback-style-if-possible">Use callback style, if possible</h3>
<p>A style develops when using <code>core.async</code> where you convert what would in regular ClojureScript be a callback style with <em>return-a-channel</em> style. The channel will contain the result of the call when it is ready.</p>
<p>Using this style to keep you out of &quot;callback hell&quot; is overkill. &quot;Callback hell&quot; is not caused by a single callback. It is caused by the <strong>eternal damnation of coordinating multiple callbacks</strong> when they could be called in any order at any time. <strong>Callbacks invert control.</strong></p>
<p><code>core.async</code> quenches the hellfire because coordinating channels within a <code>go</code> block is easy. The <code>go</code> block decides which values to read in which order. <strong>Control is restored to the code in a procedural style.</strong></p>
<p>But return-a-channel style is not exactly free of sin. If you return a channel too much, <strong>the code that calls those functions will likely end up in a <code>go</code> block</strong>.</p>
<p><code>go</code> blocks will proliferate. <code>go</code> blocks incur extra cost, especially in ClojureScript where they happen asynchronously, meaning at the next iteration of the event loop, <strong>which is indeterminately far away</strong>.</p>
<p>Furthermore, <code>go</code> blocks might begin nesting (a function whose body is a <code>go</code> block is called by another function whose body is a <code>go</code> block, etc), which is correct semantically but <strong>probably won't give you the performance you're looking for</strong>. It's best to avoid it.</p>
<p>&quot;How?&quot; you say? The most important rule is to only use <code>core.async</code> in a particular function when necessary. If you can get by with just a callback, don't use <code>core.async</code>. <strong>Just use a callback.</strong> For instance, let's say you have an <code>ajax</code> function that takes a callback and you're trying to make a small API wrapper for convenience. You could make it return a channel like this:</p>
<pre><code>(defn search-google [query]
  (let [c (chan)]
    (ajax (str &quot;http://google.com/?q=&quot; query) #(put! c %))
    c))</code></pre>
<p>The interesting thing to note is that <code>core.async</code> is not being used very well above. Yes, you get rid of a callback, but <strong>there isn't much coordination happening</strong>, so it's not needed. It's best to keep it straightforward, like this:</p>
<pre><code>(defn search-google [query cb]
   (ajax (str &quot;http://gooogle.com/?q=&quot; query) cb))</code></pre>
<p>You're <strong>just doing one bit of work here</strong> (basically constructing a URL), which is a good sign. But how do you &quot;lift&quot; this into <code>core.async</code>?</p>
<h3 id="section"><code>&lt;&lt;&lt;</code></h3>
<p>There's a common pattern in Javascript (not ubiquitous, but very common) to put the callback at the end of the parameter list. Since the callback is last, <strong>you can easily write something to add it automatically</strong>.</p>
<pre><code>(defn &lt;&lt;&lt; [f &amp; args]
  (let [c (chan)]
    (apply f (concat args [(fn [x]
                             (if (or (nil? x)
                                     (undefined? x))
                                   (close! c)
                                   (put! c x)))]))
    c))</code></pre>
<p>This little function is very handy. It automatically <strong>adds a callback to a parameter list</strong>. You call it like this:</p>
<pre><code>(go
  (js/console.log (&lt;! (&lt;&lt;&lt; search-google &quot;unicorn droppings&quot;))))</code></pre>
<p>This function lifts <code>search-google</code>, a regular asynchronous function written with callback style, into <code>core.async</code> return-a-channel style. With this function, <strong>if I always put the callback at the end, I can use my functions from within regular ClojureScript code and also from <code>core.async</code> code</strong>. I can also use any function (and there are many) that happen to have the callback last. This convention has two parts: <strong>always put the callback last and use <code>&lt;&lt;&lt;</code> when you need it</strong>. With this function, I can reserve <code>core.async</code> for coordination (what it's good at), not merely simple asynchrony.</p>
<h3 id="convention"><code>&lt;convention</code></h3>
<p>There are times when writing a function using <code>go</code> blocks and returning channels <em>is</em> the best way. In those cases, I've adopted a naming convention. I <strong>put a <code>&lt;</code> prefix in front of functions that return channels</strong>. I tried it at the end of the name, but I like how it looks at the beginning.</p>
<pre><code>(go
  (js/console.log (&lt;! (&lt;do-something 1 2 3))))</code></pre>
<p>The left-arrow of <code>&lt;do-something</code> fits right into the <code>&lt;!</code>. It also visually matches <code>(&lt;&lt;&lt; do-something 1 2 3)</code>, so it <strong>makes correct code look correct and <a href="http://www.joelonsoftware.com/articles/Wrong.html">wrong code look wrong</a></strong>. The naming convention extends to named values as well:</p>
<pre><code>(def &lt;values (chan))

(go
  (while true
    (js/console.log (inc (&lt;! &lt;values)))))</code></pre>
<h3 id="conclusion">Conclusion</h3>
<p>These conventions are a great compromise between ease of using <code>core.async</code> (<code>&lt;&lt;&lt;</code>) and universality (callbacks being universal in JS). The naming convention (<code>&lt;</code> prefix) visually marks code that should be used with <code>core.async</code>. These practices have taken me a long way. I'd love to discuss them with you <a href="http://discuss.purelyfunctional.tv/t/core-async-code-styles/46">here</a>.</p>
<p>If you know Clojure and you are interested in learning <code>core.async</code> in a fun, interactive style, check out the <a href="http://purelyfunctional.tv/core-async">LispCast Clojure core.async videos</a>.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get a Free core.async Reference Sheet
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/core_async_reference_thumb.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of the core.async reference sheet. If you are interested in core.async, this reference sheet contains lots of the important functions in a handy format. You'll also get a few emails introducing you to core.async.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][8]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/core-async-browser-motivation">core.async in Browsers</a></li>
<li><a href="http://www.lispcast.com/core-async-conveyor-belts-true-history">Conveyor Belts: Nature's core.async Channels</a></li>
<li><a href="http://www.lispcast.com/elm-frp-clojure-core-async">Elm FRP in Clojure core.async</a></li>
<li><a href="http://www.lispcast.com/is-core-async-against-clojure-philosophy">Is core.async Against the Clojure Philosophy?</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/clojure-regex">
              Regexes in Clojure
            </a>
          </h2>

          <div class="timestamp">
            June 03, 2014
          </div>

          
<p>Summary: <em>With a few functions from the standard library, Clojure lets you do most of what you want with regular expressions with no muss.</em></p>
<p><strong>Clojure is designed to be hosted.</strong> Instead of defining a standard Regular Expression semantics that works on all platforms, Clojure defers to the host's semantics. On the JVM, you're using Java regexes. In ClojureScript, it's Javascript regexes. That's the first thing to know.</p>
<p>Other than the semantics of the regexes themselves, <strong>the API is standardized across all platforms in the core library</strong>. And the syntax is convenient because you don't need to double escape your special characters.</p>
<h3 id="literal-representation">Literal representation</h3>
<p>Regexes can be constructed in Clojure using a <strong>literal syntax</strong>. Strings with a hash in front are interpreted as regexes.</p>
<pre><code>#&quot;regex&quot;</code></pre>
<p>On the JVM, the above line will create an instance of <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html"><code>java.util.regex.Pattern</code></a>. In ClojureScript, it will create a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp"><code>RegExp</code></a>. Remember, the two regular expression languages are <strong>similar but different</strong>.</p>
<h3 id="matching-with-groups">Matching (with groups)</h3>
<p>There is a nice <strong>function that matches the whole string</strong>. It is called <a href="http://richhickey.github.io/clojure/clojure.core-api.html#clojure.core/re-matches"><code>re-matches</code></a>. The return is a little complex. If the whole string does not match, it returns <code>nil</code>, which is nice because <code>nil</code> is falsey.</p>
<pre><code>=&gt; (re-matches #&quot;abc&quot; &quot;zzzabcxxx&quot;)
   nil</code></pre>
<p>If the string does match, and there are no groups (parens) in the regex, then it returns the matched string.</p>
<pre><code>=&gt; (re-matches #&quot;abc&quot; &quot;abc&quot;)
   &quot;abc&quot;</code></pre>
<p>If it matches but there are groups, then it returns a vector. The first element in the vector is the entire match. The remaining elements are the group matches.</p>
<pre><code>=&gt; (re-matches #&quot;abc(.*)&quot; &quot;abcxyz&quot;)
   [&quot;abcxyz&quot; &quot;xyz&quot;]</code></pre>
<p>The three different return types can get tricky, but in general I do have groups, so it's either a vector or <code>nil</code>, which is easy to handle. You can even <strong>destructure it before you test it</strong>.</p>
<pre><code>(let [[_ fn ln] (re-matches #&quot;(\w+)\s(\w+)&quot; full-name)]
  (if fn ;; successful match
    (println fn ln)
    (println &quot;Unparsable name&quot;)))</code></pre>
<h3 id="matching-substrings">Matching substrings</h3>
<p><code>re-matches</code> matches the whole string. But often, we want to find a match within a string. <strong><a href="http://richhickey.github.io/clojure/clojure.core-api.html#clojure.core/re-find"><code>re-find</code></a> returns the first match within the string.</strong> The return values are similar to <code>re-matches</code>.</p>
<h4 id="no-match-returns-nil">No match returns <code>nil</code></h4>
<pre><code>=&gt; (re-find #&quot;sss&quot; &quot;Loch Ness&quot;)
nil</code></pre>
<h4 id="match-without-groups-returns-matched-string">Match without groups returns matched string</h4>
<pre><code>=&gt; (re-find #&quot;s+&quot; &quot;dress&quot;)
&quot;ss&quot;</code></pre>
<h4 id="match-with-groups-returns-a-vector">Match with groups returns a vector</h4>
<pre><code>=&gt; (re-find #&quot;s+(.*)(s+)&quot; &quot;success&quot;)
   [&quot;success&quot; &quot;ucces&quot; &quot;s&quot;]</code></pre>
<h3 id="finding-all-substrings-that-match">Finding all substrings that match</h3>
<p>The last function from <code>clojure.core</code> I use a lot is <a href="http://richhickey.github.io/clojure/clojure.core-api.html#clojure.core/re-seq"><code>re-seq</code></a>, which returns a <strong>lazy seq of all of the matches</strong>, not just the first. The elements of the seq are whatever type <code>re-find</code> would have returned.</p>
<pre><code>=&gt; (re-seq #&quot;s+&quot; &quot;mississippi&quot;)
   (&quot;ss&quot; &quot;ss&quot;)</code></pre>
<h3 id="replacing-regex-matches-within-a-string">Replacing regex matches within a string</h3>
<p>Well, matching strings is cool, but often you'd like to <strong>replace a substring that matches with some other string</strong>. <a href="https://clojure.github.io/clojure/clojure.string-api.html#clojure.string/replace"><code>clojure.string/replace</code></a> will replace all substring matches with a new string. Let's take a look:</p>
<pre><code>=&gt; (clojure.string/replace &quot;mississippi&quot; #&quot;i..&quot; &quot;obb&quot;)
   &quot;mobbobbobbi&quot;</code></pre>
<p>This function is actually <strong>quite versatile</strong>. You can <strong>refer directly to the groups</strong> in the replacement string:</p>
<pre><code>=&gt; (clojure.string/replace &quot;mississippi&quot; #&quot;(i)&quot; &quot;$1$1&quot;)
   &quot;miissiissiippii&quot;</code></pre>
<p>You can also replace with the <strong>value of a function</strong> applied to the match:</p>
<pre><code>=&gt; (clojure.string/replace &quot;mississippi&quot; #&quot;(.)i(.)&quot;
     (fn [[_ b a]]
       (str (clojure.string/upper-case b)
            &quot;--&quot;
            (clojure.string/upper-case a))))
   &quot;M--SS--SS--Ppi&quot;</code></pre>
<p>You can <strong>replace just the first occurence</strong> with <code>clojure.string/replace-first</code>.</p>
<h3 id="splitting-a-string-on-a-regex">Splitting a string on a regex</h3>
<p>Let's say you want to <strong>split a string on some character pattern</strong>, like one or more whitespace. You can use <a href="https://clojure.github.io/clojure/clojure.string-api.html#clojure.string/split"><code>clojure.string/split</code></a>:</p>
<pre><code>=&gt; (clojure.string/split &quot;This is a string    that I am splitting.&quot; #&quot;\s+&quot;)
   [&quot;This&quot; &quot;is&quot; &quot;a&quot; &quot;string&quot; &quot;that&quot; &quot;I&quot; &quot;am&quot; &quot;splitting.&quot;]</code></pre>
<p>Nice!</p>
<h3 id="other-functions">Other functions</h3>
<p>Those are all of the functions I use routinely. There are some more, which are useful when you need them.</p>
<h4 id="re-patternre-pattern"><a href="http://richhickey.github.io/clojure/clojure.core-api.html#clojure.core/re-pattern"><code>re-pattern</code></a></h4>
<p>Construct a regex from a <code>String</code>.</p>
<h4 id="re-matcherre-matcher"><a href="http://richhickey.github.io/clojure/clojure.core-api.html#clojure.core/re-matcher"><code>re-matcher</code></a></h4>
<p>This one is not available in ClojureScript. On the JVM, it creates a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Matcher.html"><code>java.util.regex.Matcher</code></a>, which is used for iterating over subsequent matches. This is not so useful since <code>re-seq</code> exists.</p>
<p>If you find yourself with a <code>Matcher</code>, you can call <code>re-find</code> on it to get the next match (instead of the first). You can also call <a href="http://richhickey.github.io/clojure/clojure.core-api.html#clojure.core/re-groups"><code>re-groups</code></a> from the most recent match. Unless you need a <code>Matcher</code> for some Java API, just stick to <code>re-seq</code>.</p>
<h3 id="conclusion">Conclusion</h3>
<p>Well, that's regexes as I use them. They're super useful and easy to use in Clojure once you get the hang of them.</p>
<p>If you're interested in learning the fundamentals of Clojure, may I suggest my own <a href="http://purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a> video series. It guides you through a deep experience of the language. You'll learn REPL skills, how to set up a project, and how to develop a DSL, all in a fun, interactive way.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/3-things-java-can-steal-from-clojure">3 Things Java Programmers Can Steal from Clojure</a></li>
<li><a href="http://www.lispcast.com/atom-problem">Atom code explanation</a></li>
<li><a href="http://www.lispcast.com/clojure-database-test-faster">How I made my Clojure database tests 5x faster</a></li>
<li><a href="http://www.lispcast.com/clojure-gazette-looking-forward-2015">Clojure Gazette Looking Forward</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/lists-in-clojure">
              Warty Lists in Clojure
            </a>
          </h2>

          <div class="timestamp">
            May 27, 2014
          </div>

          
<p>Summary: <em>Lists are kind of warty in Clojure. Care should be taken, especially by those coming from other Lisps.</em></p>
<p>One of the things that still trips me up in Clojure is the actual types of lists. I used to program in Common Lisp, where things are a bit easier to understand: something is either a list or an atom. Lists are built out of conses and end with <code>nil</code>. Everything else is an atom.</p>
<p>Coming from Common Lisp, one might expect this to work:</p>
<pre><code>=&gt; (listp (cons 1 nil))</code></pre>
<p>In CL, it will be true. In Clojure, it is also true. (Try it out yourself!) Launch a REPL. Go to <a href="http://tryclj.com/">Try Clojure</a>.</p>
<pre><code>=&gt; (list? (cons 1 nil))</code></pre>
<p>What about this:</p>
<pre><code>=&gt; (list? (cons 1 (cons 1 nil)))</code></pre>
<p>We're consing onto a list, should be a list, no?</p>
<p>In Common Lisp, yes. In Clojure?</p>
<p>NO!</p>
<p>That's not a list. Go ahead, try it at your Clojure REPL.</p>
<p>What gives? How is that possible? Are we living in a Kafkaesque ECMAScript World?</p>
<div class="figure">
<img src="http://lispcast.com/pictures/kafkaesque.png" />
</div>
<p>Well . . . probably.</p>
<p>What's going on? Put on your Indiana Jones fedora. We're going on an adventure deep into the heart of the Clojure JVM implementation.</p>
<div class="figure">
<img src="http://lispcast.com/pictures/raiders3.jpg" />
</div>
<p>First, how is <code>list?</code> defined?</p>
<p><a href="https://github.com/richhickey/clojure/blob/a1eff35124b923ef8539a35e7a292813ba54a0e0/src/clj/clojure/core.clj#L4961">In clojure.core</a>:</p>
<pre><code>(defn list?
  &quot;Returns true if x implements IPersistentList&quot;
  {:added &quot;1.0&quot;}
  [x] (instance? clojure.lang.IPersistentList x))</code></pre>
<p>Great, <code>list?</code> is just an instance check. <strong>What classes implement <code>clojure.lang.IPersistentList</code>?</strong> According to the javadoc on the Clojure sources, there are two: <code>PersistentQueue</code> and <code>PersistentList</code>. There's also a static inner class in <code>PersistentList</code> called <code>EmptyList</code>.</p>
<p>Let's see those at the REPL:</p>
<pre><code>=&gt; (type ())
  clojure.lang.PersistentList$EmptyList
=&gt; (list? ())
  true

=&gt; (type (list 1 2 3))
  clojure.lang.PersistentList
=&gt; (list? (list 1 2 3))
  true

=&gt; (type clojure.lang.PersistentQueue/EMPTY)
  clojure.lang.PersistentQueue
=&gt; (list? clojure.lang.PersistentQueue/EMPTY)
  true</code></pre>
<p>These all return true when given to <code>list?</code>. What about <code>(cons 1 nil)</code>?</p>
<pre><code>=&gt; (type (cons 1 nil))
  clojure.lang.PersistentList
=&gt; (list? (cons 1 nil))
  true</code></pre>
<p>Great. <strong>Consing onto nil gives you a list</strong>. Let's cons onto a list:</p>
<pre><code>=&gt; (type (cons 0 (list 1 2 3)))
  clojure.lang.Cons
=&gt; (list? (cons 0 (list 1 2 3)))
  false</code></pre>
<div class="figure">
<img src="http://lispcast.com/pictures/raiders4.jpg" />
</div>
<p>Oh, no! Why does consing onto <code>nil</code> create a list, but <strong>consing onto a list create a cons</strong>? Poisonous dart averted! Back to the source code!</p>
<p><a href="https://github.com/richhickey/clojure/blob/a1eff35124b923ef8539a35e7a292813ba54a0e0/src/clj/clojure/core.clj#L22">In clojure.core</a>:</p>
<pre><code>(def
 ^{:arglists &#39;([x seq])
    :doc &quot;Returns a new seq where x is the first element and seq is
    the rest.&quot;
   :added &quot;1.0&quot;}

 cons (fn* cons [x seq] (. clojure.lang.RT (cons x seq))))</code></pre>
<p>So it calls <code>clojure.lang.RT/cons</code>. We can <a href="https://github.com/clojure/clojure/blob/1.5.x/src/jvm/clojure/lang/RT.java#L565">look that up</a>:</p>
<pre><code>static public ISeq cons(Object x, Object coll){
    //ISeq y = seq(coll);
    if(coll == null)
        return new PersistentList(x);
    else if(coll instanceof ISeq)
        return new Cons(x, (ISeq) coll);
    else
        return new Cons(x, seq(coll));
}</code></pre>
<p>Wow! The code is clear: if the second argument is <code>null</code> (<code>nil</code>), <strong>it makes a <code>PersistentList</code></strong>. Otherwise, it constructs a <code>clojure.lang.Cons</code>, which is not a list! We're at the root of our wart, but there's nothing we can really do about it except keep exploring.</p>
<p>If I have a list (according to <code>list?</code>) and I want to add an element to the front to make a new list, how do I do that?</p>
<div class="figure">
<img src="http://lispcast.com/pictures/raiders%205.jpg" />
</div>
<p>Well, the answer is a little disappointing:</p>
<pre><code>=&gt; (def ls (list 1 2 3))
=&gt; (def ls2 (conj ls 0))
=&gt; (list? ls2)
  true</code></pre>
<p><code>conj</code> will maintain the type, <code>cons</code> will not. What happens if I <code>conj</code> onto a <code>Cons</code>?</p>
<pre><code>=&gt; (def c (cons 1 (cons 2 nil)))
=&gt; (conj c 0)
  (0 1 2)
=&gt; (type (conj c 0))
  clojure.lang.Cons</code></pre>
<p>So, there you have it. It's a bit of a wart having all of these slightly different types and predicates like <code>list?</code> that slice them up in odd ways. Sometimes it's like running away from a giant paper-mache ball.</p>
<div class="figure">
<img src="http://lispcast.com/pictures/raiders6.jpg" />
</div>
<p>In Clojure's defense, I will say that <strong>I rarely use <code>list?</code></strong>, if at all. It's <strong>not a very useful function</strong> in <code>clojure.core</code>. I'm usually working at a much higher level than that, thinking in terms of sequences (an abstraction), not their concrete implementations. And in the end, you never get out of danger.</p>
<iframe width="560" height="315" src="//www.youtube.com/embed/lQg7QKDButo" frameborder="0" allowfullscreen></iframe>

<p>There you have it. If you'd like to learn more Clojure, I have a nice video series:</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/3-things-java-can-steal-from-clojure">3 Things Java Programmers Can Steal from Clojure</a></li>
<li><a href="http://www.lispcast.com/atom-problem">Atom code explanation</a></li>
<li><a href="http://www.lispcast.com/clojure-database-test-faster">How I made my Clojure database tests 5x faster</a></li>
<li><a href="http://www.lispcast.com/clojure-gazette-looking-forward-2015">Clojure Gazette Looking Forward</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/css-and-the-lambda-calculus">
              CSS and the Lambda Calculus
            </a>
          </h2>

          <div class="timestamp">
            May 09, 2014
          </div>

          
<p>Summary: <em>Using LESS, we can almost achieve the expressive power of the Lambda Calculus as applied to styling. The expressive power is enough to create reusable styles applied to reusable HTML components.</em></p>
<p>Let's continue our exploration and analysis of <a href="http://www.lispcast.com/css-abstraction-combination">CSS</a> and <a href="http://www.lispcast.com/less-abstraction-combination">LESS</a>. This <a href="http://www.lispcast.com/keywords/functional-css/">series is about Functional CSS</a>. Our aim is to <strong>determine a good way to use HTML and CSS so that <a href="http://www.lispcast.com/separation-of-presentation-and-content">we can reuse both</a></strong>. We can't talk about &quot;Functional&quot; without talking about the Lambda Calculus.</p>
<p>The Lambda Calculus includes three things: <em>variables</em>, <em>abstractions</em>, and <em>applications</em>. Let's look at some Javascript.</p>
<pre><code>(function(x) { return x + x; })(10);</code></pre>
<p>In the above code, <code>x</code> is a variable, the function definition is a lambda abstraction, and calling the function (with the parens at the end) is called application. Luckily, <strong>Javascript gives us an additional kind of abstraction where we can name an expression</strong> to be reused:</p>
<pre><code>var f = function(x) { return x + x; };
f(10);</code></pre>
<p>We can name the function <code>f</code>, then apply it by referring to the name. What's more, we can <strong>compose them pretty well</strong>.</p>
<pre><code>var g = function(x) { return x * x; };
var h = function(x, y) { return g(x) + g(y); };
h(10, 20);</code></pre>
<p>We're composing function <code>g</code> by <em>applying</em> it inside of the definition of <code>h</code>. You're probably saying &quot;duh!&quot;--and rightly so. It's so common to do.</p>
<p>Which is why it's hard to understand why CSS does not include all of these parts. Let's at least <em>try</em> to <strong>decompose CSS into some parts</strong>.</p>
<pre><code>.some-class { width: 10px; height: 20px; }</code></pre>
<p>Here, we're <em>applying</em> the rule which contains two properties (<code>width</code> and <code>height</code>) to all of the elements that have the class <code>.some-class</code>. <code>.some-class</code> is the <em>argument</em> to the rule's application. In fake Javascript, it would look something like this<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup>:</p>
<!-- -->

<pre><code>function(element) {
  element.width  = 10;
  element.height = 20;
}(document.getElementsByClassName(&#39;some-class&#39;));</code></pre>
<p>That is, we are <em>immediately</em> applying the abstraction to the argument. CSS has no way, as Javascript does, of <em>naming</em> the abstraction for use later. We definitely <em>want</em> that. What's more, <strong>there's no way to compose two rules together</strong>. In Javascript, we could refer to <code>g</code> within <code>h</code>. But in CSS, there's no way to do that.</p>
<p>LESS does have this ability. Since LESS is a superset of CSS, we can start with the above CSS code. Let's repeat it:</p>
<pre><code>.some-class { width: 10px; height: 20px; }</code></pre>
<p>Now we <em>abstract</em> it by naming it and then <em>apply</em> the name:</p>
<pre><code>.small-box() { width: 10px; height: 20px; }
.some-class { .small-box(); }</code></pre>
<p>That's somewhat better. We've got a reusable component (<code>.small-box</code>) and we've also added <strong>a bit more meaning to our code because we have a meaningful name</strong>. What's more, LESS lets you compose:</p>
<pre><code>.small-box() { width: 10px; height: 20px; }
.my-button() { .small-box(); border: 1px solid black; }

.some-class { .my-button(); }</code></pre>
<p>Here we've made an abstraction called <code>.my-button</code> by using <code>.small-box</code> inside. That's composition. And that's on par with our Javascript examples above.</p>
<p>There's one more thing that we might want that even Javascript doesn't have. Javascript has first-class functions. That's really nice. But there are many things in Javascript that are not first-class. For instance, the arithmetic operators (<code>+</code>, <code>*</code>, <code>-</code>, <code>/</code>) cannot be passed to a function or assigned to variables. <strong>They are treated differently by the language.</strong> They are a bit like properties in CSS: all you can do with them is refer to them directly in an expression.</p>
<p>But what if Javascript did have first-class arithmetic functions? We can certainly fake them out.</p>
<pre><code>var plus  = function(a, b) { return a + b; };
var times = function(a, b) { return a * b; };
var minus = function(a, b) { return a - b; };
var over  = function(a, b) { return a / b; };</code></pre>
<p>Now we have functions that act just like the operators--and they're first-class. It's also way more consistent: every operator is a function.</p>
<p>We can do something similar in LESS. Imagine we took every property and did what I do to these:</p>
<pre><code>.width(@w)  { width:  @w; }
.height(@h) { height: @h; }
. . .</code></pre>
<p>Now we have the consistency that everything is at least referrable as a mixin. This is pretty good.</p>
<p>We can now define our styles--and name them--in this subset of LESS. <strong>Styles may reference other styles.</strong> And rules with selectors may reference styles. You could import pure styles from an external library, then refer to them in your rules, where you apply them to selectors. <strong>The HTML does not have to change, and neither do the styles.</strong></p>
<p><strong>Rules--where styles and selectors are tied together--will change the most.</strong> As common sets of styles are used together often, you might think about factoring them out into a new style, which would be added to your organization's standard style library. Also, as HTML components solidify, you could begin to firm up the class names and their structure, reusing them in a more permanent way. Yet, even though these two assets (the standard styles and the standard class names / HTML structures) are permanent, you can still change how they are styled by changing the rules. <strong>Both assets retain their value over time.</strong></p>
<h3 id="a-fly-in-the-ointment">A fly in the ointment</h3>
<p>Even though we have tremendous power over that given by CSS, <strong>we are not at the level of first-class styles</strong>. The following will NOT work in LESS, though we would expect it to.</p>
<pre><code>/* refer to variable like a mixin */
.apply(@style, @arg) { @style(@arg); }

.width(@w) { width: @w; }

/* pass in .width mixin */
#xyz { .apply(.width, 10px); }</code></pre>
<p>The problem is that <strong>you cannot use a mixin named with a variable</strong>. The same limitation exists in SCSS (SASS). The following is invalid.</p>
<pre><code>@mixin apply($s, $a) { @include $s($a); }</code></pre>
<p>Why can't a mixin be assigned to a variable? Mixins appear to be in a different namespace from variables, and only mixin syntax can appear in the mixin position. Though I don't think <code>apply</code> itself would be very useful, it would indicate a <strong>recursive abstraction power that could be used well</strong>.</p>
<p>Not being able to write <code>apply</code> hints that the developers of these two languages are thinking at the syntax level. They have added some great features, but <strong>they have not truly modeled the problem semantically</strong>. Instead, it feels like a mix of special-cased syntax rules and string interpolation. <a href="http://lesscss.org/features/#detached-rulesets-feature">You can assign a ruleset to a variable, but not a mixin?</a></p>
<h3 id="conclusion">Conclusion</h3>
<p>LESS (and SASS, etc) have some very powerful features that are miles above CSS in terms of abstraction and composition. I hate using plain CSS after using LESS--LESS is just so much more expressive. You can do some impressive and useful things with them, and I continue to use them. I want to write about <strong>how I use a subset of LESS and a strict discipline in HTML to make styling easier and more maintainable</strong>. In addition, I'd like to <strong>explore what a better-designed style language might look like</strong>.</p>
<div class="article-cg-box">
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>



<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Please ignore the fact that CSS does operate on sets of elements, not simple elements.<a href="#fnref1">↩</a></p></li>
</ol>
</div>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/separation-of-presentation-and-content">
              Separation of Presentation and Content
            </a>
          </h2>

          <div class="timestamp">
            April 17, 2014
          </div>

          
<p>Summary: <em>One reason to separate style from content is to reuse HTML or CSS. Ultimately, we would like a solution where we can reuse both.</em></p>
<h3 id="reusable-content">Reusable Content</h3>
<p>There is an economic reason to separate presentation from content. Publishers have thousands of pages of HTML on their site, yet they want to enhance the style of their pages over time. It would <strong>cost a lot of money to change every single page to match their new style</strong>. So they invest a little more time writing each page so that the HTML markup does not refer to styles but to the semantics of the content (referred to as <em>semantic HTML</em>). Then they hire a designer to write CSS to make their existing content look new. The HTML is permanent and reusable, and the CSS is temporary and not-reusable. <strong>The separation is only one way: the HTML doesn't know the CSS, but the CSS does know the HTML.</strong></p>
<p><strong>Examples:</strong> <a href="http://www.csszengarden.com/">CSS Zen Garden</a>, newspaper websites, blogs</p>
<p><strong>Characteristics:</strong> Semantic markup, CSS tailored to classes/structure of HTML</p>
<h3 id="reusable-styles">Reusable Styles</h3>
<p>Yet another economic reason is a relatively newer phenomenon. It has become very easy to create a new web site/application. Writing (or generating) lots of HTML is cheap, and it changes often during iterative development. What is <strong>relatively expensive is to <em>design</em> each of those pages each time the pages change</strong>. CSS is not good at adapting to page structure changes. So people have built CSS frameworks where the CSS is (relatively) permanent and the HTML is temporary. In these cases, <strong>the HTML knows the CSS, but the CSS doesn't know the HTML</strong>. The separation is again one way--this time the other way.</p>
<p><strong>Examples:</strong> <a href="https://github.com/stubbornella/oocss/tree/master/oocss">Open Source CSS</a>, <a href="http://getbootstrap.com/">Bootstrap</a>, <a href="http://foundation.zurb.com/">Foundation</a>, <a href="http://purecss.io/">Pure</a></p>
<p><strong>Characteristics:</strong> HTML tailored to classes/structure of CSS, Reusable CSS</p>
<h3 id="reusable-content-and-styles">Reusable Content and Styles</h3>
<p>What if a newspaper site, with millions of existing HTML pages, could cheaply take advantage of the reusable styles of frameworks like Bootstrap? That is the Holy Grail of separation of concerns. What would be required to do that?</p>
<p><strong>What we really want is a two-way separation.</strong> We want HTML written in total isolation and CSS written in total isolation. We want permanent HTML and permanent CSS. How can the style and content, each developed separately, finally be brought together? The answer is simple: <strong>a third document to relate the two</strong>.</p>
<p>We have already seen that <a href="http://www.lispcast.com/css-abstraction-combination">CSS is not good at <em>abstraction</em></a>. CSS cannot name a style to use it later. However, <a href="http://www.lispcast.com/less-abstraction-combination">LESS does have powerful forms of abstraction</a>. LESS has the ability to <strong>define reusable styles and apply them to HTML</strong> that did not have those styles in mind. If you put the <em>definition of reusable styles</em> in one document and the <em>application of those styles</em> in another document, you achieve true separation. And it is already happening a little bit. <strong>You can do it in your own code.</strong></p>
<p>It is a bit like a software library. We put the reusable bits in the library, and their specific use in the app.</p>
<p><strong>Examples:</strong> <a href="http://compass-style.org/">Compass</a>, <a href="http://semantic.gs/">Semantic Grid System</a></p>
<p><strong>Characteristics:</strong> Semantic markup, Reuseable Styles, Tie-in document to relate Style to Content</p>
<h3 id="conclusion">Conclusion</h3>
<p>CSS preprocessors, which began as convenience tools, are actually <strong>powerful enough to solve fundamental problems with HTML and CSS</strong>. While it is still early, LESS and other CSS preprocessors, if harnessed correctly, could dramatically transform how we build and design web sites. Typography, grids and layout, and other design concerns can be used as plugable libraries. And other languages that are specifically designed to do that may emerge. <strong>What would a systematic, analytical approach to such an approach look like?</strong></p>
<div class="article-cg-box">
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/cascading-separation-abstraction">Separation, Abstraction, and Cascading in CSS</a></li>
<li><a href="http://www.lispcast.com/css-abstraction-combination">CSS has Weak Forms of Abstraction and Combination</a></li>
<li><a href="http://www.lispcast.com/less-abstraction-combination">LESS has Better Forms of Abstraction than CSS</a></li>
<li><a href="http://www.lispcast.com/pre-west-interview-priyatam-mudivarti">Pre-West Interview: Priyatam Mudivarti</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/clojure-web-security">
              Clojure Web Security
            </a>
          </h2>

          <div class="timestamp">
            April 05, 2014
          </div>

          
<p>Summary: <em>Use the OWASP Top Ten Project to minimize security vulnerabilities in your Clojure web application.</em></p>
<p>Aaron Bedra gave a very damning talk about <a href="https://www.youtube.com/watch?v=CBL59w7fXw4">the security of Clojure web applications</a>. He went so far as to say that Clojure web apps are some of the worst he has seen. You should <a href="https://www.youtube.com/watch?v=CBL59w7fXw4">watch the talk</a>. He has some good recommendations.</p>
<p>One of the jobs of web frameworks is to handle security concerns inherent in the web itself. Because most Clojure programmers build their own web stack, they often <strong>fail to look at the security implications of their application</strong>. They do not protect their site from even the easiest and most common forms of vulnerabilities. These vulnerabilities are problems with the way the web works, not with the particular server technology, yet it has become the server's responsibility to mitigate the vulnerabilities. Luckily, <strong>the vulnerabilities are well-studied and there are known fixes</strong>.</p>
<p>The <a href="https://www.owasp.org/index.php/Main_Page">Open Web Application Security Project (OWASP)</a> does a very good job of documenting common web vulnerabilities and providing good fixes for them. They have a project called the <a href="https://www.owasp.org/index.php/Category:OWASP_Top_Ten_Project#tab=OWASP_Top_10_for_2013">Top Ten Project</a> which every web developer should refer to regularly and use to improve the security of their app. You should also run through the <a href="https://code.google.com/p/owasp-asvs/wiki/ASVS">Application Security Verification Standard</a> checklists to audit your code. <strong>But the Top Ten should get you to understand the basics.</strong></p>
<p>Warning: <em>I am not a security expert. You should do your own research. The code I present here is my own interpretation of the OWASP recommendations. It has not been audited by experts. Do your own research!</em></p>
<p>Also, security is an ongoing concern. <strong>If you have any comments, suggestions, or questions, please bring them up!</strong></p>
<p>Here is the Top Ten 2013 with a small breakdown and a Clojure solution, if applicable.</p>
<h3 id="a1.-injectiona1"><a href="https://www.owasp.org/index.php/Top_10_2013-A1-Injection">A1. Injection</a></h3>
<p>If a server accepts input from the outside and then <strong>parses and interprets that input as a scripting or query language, it is open to attack</strong>. The most common form is SQL Injection, where an input form is posted to the server, the value of that form is concatenated into a string to make a SQL statement, and then the SQL statement is sent to the database to be executed. What happens if a malicious user types in <code>&quot;'; DELETE FROM USERS;&quot;</code>?</p>
<p>My preferred solution to SQL Injection in Clojure is to <strong>always use parameterized SQL statements</strong>. <code>clojure.java.jdbc</code>, supports these directly. <strong>The parameters will be escaped, making injection impossible.</strong></p>
<p>Another problem is if you want to read in some Clojure data from the client, and you call <code>clojure.core/read-string</code> on it. <strong><code>read-string</code> will execute arbitrary Java constructors.</strong> For instance:</p>
<pre><code>#java.io.FileWriter[&quot;myfile.txt&quot;]</code></pre>
<p>This will create the file <code>myfile.txt</code> or overwrite if it already exists. Also, there is a form (called read-eval form) to execute code at read-time:</p>
<pre><code>#=(println &quot;Hello, vulnerability!&quot;)</code></pre>
<p><strong>Read in that string, and it will print. Any code could be in there.</strong></p>
<p>The solution is to <strong>never use <code>clojure.core/read-string</code></strong>. Use <code>clojure.edn/read-string</code>, which is a well-documented format. It does not run arbitrary constructors. It has no read-eval forms.</p>
<p>Summary: <em>Always use parameterized SQL and use <code>clojure.edn/read-string</code> instead of <code>clojure.core/read-string</code> on edn input.</em></p>
<h3 id="a2-broken-authentication-and-session-managementa2"><a href="https://www.owasp.org/index.php/Top_10_2013-A2-Broken_Authentication_and_Session_Management">A2 Broken Authentication and Session Management</a></h3>
<h4 id="authentication">Authentication</h4>
<p>This is a big topic and I can't address it all here. Clojure has the <a href="https://github.com/cemerick/friend">Friend library</a>, which is the closest thing we have to a de facto standard. My suggestion is simply to <strong>read the entire Friend README</strong> and evaluate whether you should use it. This is serious stuff. Read it.</p>
<h4 id="session-management">Session Management</h4>
<p><strong>Ring provides a session system which is fairly good.</strong> It meets many of the <a href="https://code.google.com/p/owasp-asvs/wiki/Verification_V3">OWASP Application Security Verification Standard V3</a> requirements. But it does not handle all of them automatically. <strong>You still need code audits.</strong> For instance, if you are logging requests, OWASP recommends against logging the session key. You must ensure that the session key is added after the request is logged.</p>
<p>The ASVS also recommends expiring your sessions after inactivity and also after a fixed period, regardless of activity. Ring sessions do not do this automatically (the builtin mechanism has no notion of expiration) and the <strong>default implementations of session stores will store and accept sessions indefinitely</strong>. A simple middleware will do the trick of expiring them in both cases:</p>
<pre><code>(defn wrap-expire-sessions [hdlr &amp; [{:keys [inactive-timeout
                                            hard-timeout]
                                     :or {:inactive-timeout (* 1000 60 15)
                                          :hard-timeout (* 1000 60 60 2)}}]]
  (fn [req]
    (let [now (System/currentTimeMillis)
          session (:session req)
          session-key (:session/key req)]
      (if session-key ;; there is a session
        (let [{:keys [last-activity session-created]} session]
          (if (and last-activity
                   (&lt; (- now last-activity) inactive-timeout)
                   session-created
                   (&lt; (- now session-created) hard-timeout))
            (let [resp (hdlr req)]
              (if (:session resp)
                (-&gt; resp
                    (assoc-in [:session :last-activity] now)
                    (assoc-in [:session :session-created] session-created))
                resp))
            ;; expired session
            ;; block request and delete session
            {:body &quot;Your session has expired.&quot;
             :status 401
             :headers {}
             :session nil}))
        ;; no session, just call the handler
        ;; assume friend or other system will handle it
        (hdlr req)))))</code></pre>
<p>Set the <a href="https://www.owasp.org/index.php/Session_Management_Cheat_Sheet#HttpOnly_Attribute">HttpOnly attribute</a> on the session cookie. Very important for preventing stealing of session ids from XSS attacks.</p>
<p><em>Do not</em> set the <a href="https://www.owasp.org/index.php/Session_Management_Cheat_Sheet#Domain_and_Path_Attributes">Domain attribute</a>, and <em>do</em> set the Path if you want something more restrictive than <code>/</code> (the Ring session default).</p>
<p><em>Do not</em> set the <a href="https://www.owasp.org/index.php/Session_Management_Cheat_Sheet#Expire_and_Max-Age_Attributes">Expire and Max-Age</a> attributes. Setting them makes the browser store the session id on disk, which simply expands the number of ways an attacker can get ahold of it.</p>
<p><a href="https://www.owasp.org/index.php/Session_Management_Cheat_Sheet#Session_ID_Name_Fingerprinting">Change the session cookie name to something utterly generic</a>, like &quot;id&quot;. You don't want to leak more information than necessary about how your sessions work.</p>
<p>Use HTTPS if you can and set the <a href="https://www.owasp.org/index.php/Session_Management_Cheat_Sheet#Secure_Attribute">Secure</a> attribute of the cookie.</p>
<p>Do not use in-cookie sessions. In-memory are good but they can't scale past one machine. <a href="https://github.com/ptaoussanis/carmine"><code>carmine</code></a> has a redis-based session implementation.</p>
<p>Summary: <em>Here's how I use Ring sessions (with <code>carmine</code>) based on these OWASP recommendations.</em></p>
<pre><code>(session/wrap-session
   (wrap-expire-sessions
    handler
    {:inactive-timeout 500
     :hard-timeout 3000})
   {:cookie-name &quot;id&quot;
    :store (taoensso.carmine.ring/carmine-store redis-db
             {:expiration-secs (* 60 60 15)
             :key-prefix &quot;&quot;}) ;; leak nothing!
    :cookie-attrs {:secure true :httponly true}})</code></pre>
<h3 id="a3-cross-site-scripting-xssa3"><a href="https://www.owasp.org/index.php/Top_10_2013-A3-Cross-Site_Scripting_(XSS)">A3 Cross-Site Scripting (XSS)</a></h3>
<p>Whenever text from one user is shown to another user, there is the potential for injecting code (HTML, JS, or CSS) that is run in the victim's browser. Imagine if Facebook allowed any HTML in the post submission form. A malicious user could add a <code>&lt;script&gt;</code> tag with some keystroke logging code. <strong>Anybody who viewed that post in their feed would also get the key logger installed.</strong> That would be bad.</p>
<p>XSS is common because of how easy it is to make an app that stores user input (from a form post) in a database, then constructs the page out of stuff from the database. If you're not extremely careful, <strong>you could create a place where people can exploit each other</strong>.</p>
<p>The solution is to <strong>only use scrubbed or escaped values to build HTML pages</strong>. Because HTML pages can include different languages (HTML, CSS, JS), text needs to be scrubbed differently in each context. OWASP has a <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet">set of rules to follow which will guarantee XSS prevention</a>.</p>
<p><code>hiccup.util/escape-html</code> (also aliased as <code>hiccup.core/h</code>) will escape all dangerous HTML characters into HTML entities. JS and CSS still need to be handled, and rules for HTML attributes need to be followed.</p>
<p>If you want to allow some HTML elements, you will need to do a complex scrub. Luckily, <strong>Google has a <a href="https://code.google.com/p/owasp-java-html-sanitizer/wiki/GettingStarted">nice Java library that sanitizes HTML</a></strong>. Use it.</p>
<p>Summary: <em>Validate and scrub input from the user and scrub/escape text on output.</em></p>
<h3 id="a4-insecure-direct-object-referencesa4"><a href="https://www.owasp.org/index.php/Top_10_2013-A4-Insecure_Direct_Object_References">A4 Insecure Direct Object References</a></h3>
<p>This one is a biggie: <strong>each handler has to do authentication</strong>. Does the particular logged in user have access to the resources requested? There's no way to automate this with a middleware. But having <em>some</em> system is better than doing it ad hoc each time. Remember: an attacker can construct any URL, including URLs with a database key in it. Don't assume that just because a request contains a key, the user must have the rights to it.</p>
<p>Summary: <em>Always check the authority of the requesting session before performing an action.</em></p>
<h3 id="a5-security-misconfigurationa5"><a href="https://www.owasp.org/index.php/Top_10_2013-A5-Security_Misconfiguration">A5 Security Misconfiguration</a></h3>
<p>This is about keeping your software up to date and making sure the settings of all software makes sense.</p>
<h3 id="a6-sensitive-data-exposurea6"><a href="https://www.owasp.org/index.php/Top_10_2013-A6-Sensitive_Data_Exposure">A6 Sensitive Data Exposure</a></h3>
<p>Having data is risky. Don't let it leak out.</p>
<h3 id="a7-missing-function-level-access-controla7"><a href="https://www.owasp.org/index.php/Top_10_2013-A7-Missing_Function_Level_Access_Control">A7 Missing Function Level Access Control</a></h3>
<p>Use an authorization system (<a href="https://github.com/cemerick/friend">Friend</a>) and audit the roles used for access control.</p>
<h3 id="a8-cross-site-request-forgery-csrfa8"><a href="https://www.owasp.org/index.php/Top_10_2013-A8-Cross-Site_Request_Forgery_(CSRF)">A8 Cross-Site Request Forgery (CSRF)</a></h3>
<p>Let's imagine you have a bank account at Bank of Merica. You just checked your balance and didn't log out. Then you go to some public forum, where someone has posted a cool file. There's a big download button. You click it, and the next thing you know, you're on your bank page and all of your money has been transfered out of your account.</p>
<p>What happened?</p>
<p>The download button said &quot;Download&quot; but <strong>it was really a form submit button</strong>. The form had hidden fields &quot;to-account&quot;, and &quot;amount&quot;. The action of the form was &quot;http://www.bankofmerica.com/transfer-money&quot;. By clicking that button, <strong>the form was posted to the bank, and because you were just logged in, oops, it transfered all your money away</strong>.</p>
<p>The solution is that you only want to <strong>accept form posts that come directly from your site</strong>, which you control. You don't want some random person to convince people to click on other sites to be able to transfer people's money like that.</p>
<p>There are several possible solutions. One approach is to add a secret to the session and also insert that secret into every form. That is the approach taken by the <a href="https://github.com/weavejester/ring-anti-forgery">ring-anti-forgery</a> library.</p>
<p>The solution that I like is to do a <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#Double_Submit_Cookies">double-submit</a>. This means you submit a secret token in the cookie (sent with each web request) and in a hidden field in the form. The server confirms that the cookie and the hidden field match. But the hidden field in the form is added by a small Javascript script which reads it from the cookie. <strong>Browsers don't allow Javascript to read cookies from other sites, so you guarantee that they form was posted from your site.</strong></p>
<p>There are three parts to the solution.</p>
<ol style="list-style-type: decimal">
<li>Install a secret token as a cookie.</li>
<li>Install a script to add the hidden field to all forms.</li>
<li>Check that the field matches the cookie on POSTs.</li>
</ol>
<p>Here is some code to do 1 and 3.</p>
<pre><code>(defn is-form-post? [req]
  (and (= :post (:request-method req))
       (let [ct (get-in req [:headers &quot;content-type&quot;])]
         (or (= &quot;application/x-www-form-urlencoded&quot; ct)
             (= &quot;multipart/form-data&quot; ct)))))

(defn csrf-tokens-match? [req]
  (let [cookie-token (get-in req [:cookies &quot;csrf&quot;])
        post-token   (get-in req [:form-params &quot;csrf&quot;])]
    (= cookie-token post-token)))

(defn wrap-csrf-cookie [hdlr]
  (fn [req]
    (let [cookie (get-in req [:cookies &quot;csrf&quot;]
                         (str (java.util.UUID/randomUUID)))]
      (assoc-in (hdlr req) [:cookies &quot;csrf&quot;] cookie))))

(defn wrap-check-csrf [hdlr]
  (fn [req]
    (if (is-form-post? req)
      (if (csrf-tokens-match? req)
        ;; we&#39;re safe
        (hdlr req)
        ;; possible attack
        {:body &quot;CSRF tokens don&#39;t match.&quot;
         :status 400
         :headers {}})
      ;; we don&#39;t check other requests
      (hdlr req))))</code></pre>
<p>The Javascript should be something like this:</p>
<pre><code>(def csrf-script &quot;(function() {
  var cookies = document.cookie;
  var matches = cookies.match(/csrf=([^;]*);/);
  var token   = matches[1];
  $(&#39;form&#39;).each(function(i, form) {
    if(form.attr(&#39;method&#39;).toLowerCase() === &#39;post&#39;) {
      var hidden = $(&#39;&lt;input /&gt;&#39;);
      hidden.attr(&#39;type&#39;, &#39;hidden&#39;);
      hidden.attr(&#39;name&#39;, &#39;csrf&#39;);
      hidden.attr(&#39;value&#39;, token);
      form.append(hidden);
    }
  })
}());&quot;)</code></pre>
<p>You should add it to all HTML pages. Note that this example script requires jQuery. Put it right before the <code>&lt;/body&gt;</code>.</p>
<pre><code>[:script csrf-script]</code></pre>
<p>The nice thing about this solution is that it is <strong>strict by default</strong>. If you don't include the script, form posts won't work (assuming <code>wrap-check-csrf</code> is in your middleware stack).</p>
<p>Summary: <em>CSRF attacks take advantage of properties of the browser (instead of properties of your server), so their defense can largely be automated.</em></p>
<h3 id="a9-using-components-with-known-vulnerabilitiesa9"><a href="https://www.owasp.org/index.php/Top_10_2013-A9-Using_Components_with_Known_Vulnerabilities">A9 Using Components with Known Vulnerabilities</a></h3>
<p>Software with known vulnerabilities is easily attacked using scripts. You should ensure that all of your software is up-to-date.</p>
<h3 id="a10-unvalidated-redirects-and-forwardsa10"><a href="https://www.owasp.org/index.php/Top_10_2013-A10-Unvalidated_Redirects_and_Forwards">A10 Unvalidated Redirects and Forwards</a></h3>
<p>One common pattern for login workflow is to have a query parameter that contains the url to redirect to. Since it's a user parameter, <strong>it's open to the world and could be a doorway for attackers</strong>.</p>
<p>For example, let's say someone sends an email to someone asking them to log in to their bank account. In it, there's this link:</p>
<pre><code>http://www.bankofmerica.com/login?redirect=http://attackersite.com</code></pre>
<p>What happens when they click? They see the legitimate site of their bank, which they trust. But it redirects them to the attacker's site, which has been designed to look like the bank site. <strong>The user might miss this change of domains and unwittingly reveal private information.</strong></p>
<p>What can you do?</p>
<p>OWASP recommends never performing redirects, which is impractical. The next best thing is to never base the redirect on a user parameter. This would work, but puts a lot of trust in the developers and security auditors to check that the policy is enforced. <strong>My preferred solution allows redirects that conform to a whitelist of patterns.</strong></p>
<pre><code>(def redirect-whitelist
  [#&quot;https://www.bankofmerica.com/&quot; ;; homepage
   #&quot;https://www.bankofmerica.com/account&quot; ;; account page
   ...
  ])

(defn wrap-authorized-redirects [hdlr]
  (fn [req]
    (let [resp (hdlr req)
          loc (get-in resp [:headers &quot;Location&quot;])]
      (if loc
        (if (some #(re-matches % loc) redirect-whitelist)
          ;; redirect on our whitelist, it&#39;s ok!
          resp
          ;; possible attack
          (do
            ;; log it
            (warning &quot;Possible redirect attack: &quot; loc)
            ;; change redirect back to home page
            (assoc-in resp [:headers &quot;Location&quot;] &quot;https://www.bankofmerica.com/&quot;)))
        resp))))</code></pre>
<p>Summary: <em>Redirect attacks can largely be avoided by checking the redirect URL against a whitelist.</em></p>
<h3 id="conclusion">Conclusion</h3>
<p>Web security is hard. It takes education and vigilance to keep our servers secure. Luckily, the main security flaws of the web are well-understood and well-documented. However, this is only half of the work. These need to be translated into Clojure either as libraries and simply as &quot;best practices&quot;. Further, these libraries and practices need to be discussed and kept top-of-mind.</p>
<p>If programming the web in Clojure interests you, you might be interested in my <a href="http://www.purelyfunctional.tv/web-dev-in-clojure">Web Development in Clojure</a> video series. It covers all of the basics of web development, building a foundation to understand the entire Clojure web stack.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get a Free Ring Spec to hang on your wall
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/ring_spec_1_3.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of a Ring Spec to hang on your wall. If you are programming in Ring (covered in the videos), you'll find it very useful as a reference. You'll also hear about exclusive previews and discounts of other video courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][4]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/cascading-separation-abstraction">Separation, Abstraction, and Cascading in CSS</a></li>
<li><a href="http://www.lispcast.com/hiccup-tips">Hiccup Tips</a></li>
<li><a href="http://www.lispcast.com/json-serialization-api-clojure">JSON Serialization for APIs in Clojure</a></li>
<li><a href="http://www.lispcast.com/parts-of-ring">The Parts of Ring</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/ring-spec-hang-on-wall">
              A Ring Spec to Hang on the Wall
            </a>
          </h2>

          <div class="timestamp">
            March 28, 2014
          </div>

          
<p>Summary: <em>The Ring SPEC is the core of the Clojure web ecosystem. The standard is small and <a href="http://www.purelyfunctional.tv/web-dev-in-clojure#subscribe">a reference</a> is handy.</em></p>
<p>If you program the web in Clojure, you probably use Ring. Even if you don't, your server is likely <a href="http://http-kit.org/">Ring compatible</a>.</p>
<p>Ring has a small SPEC. It's centered around defining the keys one can expect in the request and response maps. And the exact names for keywords are easy to forget.</p>
<p>I don't want to forget. I use Ring often enough that I want a quick reference. A while ago, I printed out a quick summary of the keys for the request and response maps and hung it on the wall behind my monitor. I refer to it frequently.</p>
<p>If you program the web in Clojure, you might appreciate this printout. If you're learning, it could be an invaluable reference. <a href="http://www.purelyfunctional.tv/web-dev-in-clojure#subscribe">Please download the PDF.</a></p>
<p>And if you like it, you might also like my <a href="http://www.purelyfunctional.tv/web-dev-in-clojure">Web Development in Clojure video series</a>.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get a Free Ring Spec to hang on your wall
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/ring_spec_1_3.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of a Ring Spec to hang on your wall. If you are programming in Ring (covered in the videos), you'll find it very useful as a reference. You'll also hear about exclusive previews and discounts of other video courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][4]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/cascading-separation-abstraction">Separation, Abstraction, and Cascading in CSS</a></li>
<li><a href="http://www.lispcast.com/clojure-web-security">Clojure Web Security</a></li>
<li><a href="http://www.lispcast.com/hiccup-tips">Hiccup Tips</a></li>
<li><a href="http://www.lispcast.com/json-serialization-api-clojure">JSON Serialization for APIs in Clojure</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


      <div class="notes">

      </div>

    </div>

    <footer class="footer-banner">
      <a class="footer-previous"
         href="page16.html">
        <i class="fa fa-chevron-left footer-arrow"></i>
      </a>
      <a class="footer-next"
         href="page14.html">
        <i class="fa fa-chevron-right footer-arrow"></i>
      </a>
    </footer>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script>

      document.write('<script src="https://oberon.herokuapp.com/cookie/get.js?_=' + (new Date()).getTime() + '"><\/script>');

          if(window.oberon && mixpanel) {
            if(document.cookie.indexOf('oberon-id') < 0) {
              var expires = (new Date((new Date().getTime() + 1000*60*60*24*365*10))).toUTCString();
              mixpanel.alias(window.oberon.id);
              document.cookie = "oberon-id=" + window.oberon.id + ";expires=" + expires + ";path=/";
            }
            mixpanel.identify(window.oberon.id);
          }

      mixpanel.register({URL: window.location.pathname,
                         Title: $("title").text()});

      mixpanel.track("Page Visit");

      mixpanel.track_forms('.gazette-form', 'Submit Clojure Gazette');
      mixpanel.track_forms('.subscribe-form', 'Subscribe');

      mixpanel.track_links('a.homepage-offer-box-link',
                           'Click PurelyFunctional.tv',
                           function(e) {
                             return {ToURL: $(e).prop('href')};
                           });

      mixpanel.track_links('a.js-clojuregazette',
                           'Click Clojure Gazette',
                           function(e) {
                             return {ToURL: $(e).prop('href')};
                           });

      $('input[name=EMAIL]').change(function() {
                                                      var i = $(this);
                                                      window.o_email = i.val();
                                                      });

      $('form').submit(function() {
        if(window.o_email)
          mixpanel.people.set({"$email": window.o_email});
});

    </script>

  </body>
</html>
