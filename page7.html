<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>LispCast</title>
    <meta name="description" content="A blog about the simple joys of functional programming.">
    <meta name="author" content="Eric Normand">

    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="/css/styles.css" type="text/css">

    <link rel="alternate" type="application/rss+xml" title="LispCast" href="/feed" />

<!-- start Mixpanel --><script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
mixpanel.init("ffad2bd88d2cb690edbbba6cf30b2958");</script><!-- end Mixpanel -->
  </head>

  <body>
    <header class="banner">
      <h1 class="banner-logo">
        <a href="/">
          <img class="banner-logo-img"
               src="/img/Logo@2x.png"
               alt="LispCast" />
        </a>
      </h1>

      <div class="meta-data">
        <img class="bio-img"
             src="/img/eric_bio.jpg" />
        <a class="twitter-link"
           href="http://twitter.com/ericnormand">
          <i class="fa fa-twitter"></i>
        </a>
        <a class="github-link"
           href="https://github.com/ericnormand">
          <i class="fa fa-github"></i>
        </a>
        <a class="mail-link"
           href="mailto:eric@lispcast.com">
          <i class="fa fa-envelope"></i>
        </a>
        <a class="rss-link"
           href="/feed">
          <i class="fa fa-rss-square"></i>
        </a>
        <a class="rss-link"
           href="/archive.html">
          <i class="fa fa-list"></i>
        </a>
      </div>

    </header>

    <div class="main-container">


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/exponential-backoff">
              Exponential Backoff
            </a>
          </h2>

          <div class="timestamp">
            March 13, 2015
          </div>

          
<p>Summary: <em>A common failure in distributed systems is a server with a rate limit or with no limit but begins failing due to load. A standard solution is to retry after waiting a small time, increasing that time after each failure. We create a macro to handle this waiting and retrying.</em></p>
<p>A few days ago I wrote about <a href="http://www.lispcast.com/try-three-times">a high-level way of handing intermittent errors</a>, particularly in a distributed system. The way was simplistic: when you get an error, try again, up to a few errors. A slightly more nuanced approach is to <em>back off</em> before you try again. <strong>Each time there's an error, you wait longer, until some maximum time is reached.</strong></p>
<h2 id="the-problem">The problem</h2>
<p>Let's say you're hitting a service with a rate limit. That rate limit could be enforced or implicit<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup>. You've got lots of computers hitting it, and it's impossible to coordinate. No matter how hard you try to keep under that rate limit (and you <em>should try</em>), <strong>you will eventually break the limit</strong>. Retrying immediately when the server is too busy will actually make the problem worse. You will give it yet another request to deny. At the same time, it might be hard to distinguish &quot;I'm too busy <em>right now</em>&quot; from &quot;I'm never going to recover&quot;.</p>
<h2 id="the-solution">The solution</h2>
<p>I don't know what it's really called. I call it <em>Exponential Backoff</em>. It's also easy to turn into a separate routine:</p>
<pre><code>(defn exponential-backoff [time rate max f]
  (if (&gt;= time max) ;; we&#39;re over budget, just call f
    (f)
    (try
      (f)
      (catch Throwable t
        (Thread/sleep time)
        (exponential-backoff f (* time rate) rate max)))))</code></pre>
<p>This one has <strong>the same structure as <a href="http://www.lispcast.com/try-three-times"><code>try-n-times</code></a></strong> but will sleep before recursing. When it recurses, the time is multiplied by the rate. And when the last wait is more than the max, it will try one more time. Failures from that last try will propagate.</p>
<h3 id="how-to-use-it">How to use it</h3>
<p>Same as with <code>try-n-times</code>:</p>
<pre><code>(exponential-backoff 1000 2 10000
  #(http/get &quot;http://rate-limited.com/resource&quot;
             {:socket-timeout 1000
              :conn-timeout   1000}))</code></pre>
<p>This will retry after waiting 1 second (1000 ms) the first time, then double it (the <code>2</code>) each time. When it waits 10 seconds, it won't retry any more.</p>
<h3 id="slightly-more-useful">Slightly more useful</h3>
<p>Ok, so I don't use this exactly. What I use is slightly more complicated. I've found that <strong>I often can tell if it's a rate limiting problem if I look at the exception</strong>. So, let's pass it a predicate to check.</p>
<pre><code>(defn exponential-backoff [time rate max p? f]
  (if (&gt;= time max) ;; we&#39;re over budget, just call f
    (f)
    (try
      (f)
      (catch Throwable t
        (if (p? t)
          (do
            (Thread/sleep time)
            (exponential-backoff f (* time rate) rate max))
          (throw t))))))</code></pre>
<p>This one only recurses if the predicate returns true on the exception. Let's service mentions &quot;queue capacity&quot; in the body of the HTTP response when it's too busy:</p>
<pre><code>(exponential-backoff 1000 2 10000
  (fn [t] ;; the predicate
    (and (instance? clojure.lang.ExceptionInfo t)
         (re-find #&quot;queue capacity&quot; (:error (ex-data t)))))
  #(http/get &quot;http://rate-limited.com/resource&quot;
             {:socket-timeout 1000
              :conn-timeout   1000}))</code></pre>
<p><strong>You can be more selective about your backoff.</strong></p>
<h3 id="a-macro">A Macro</h3>
<p>Well, here's an example macro. It's got a bunch of defaults.</p>
<pre><code>(defmacro try-backoff [[time rate max p?] &amp; body]
  `(exponential-backoff (or ~time 1000) ;; defaults!
                        (or ~rate 2)
                        (or ~max 10000)
                        (or ~p? (constantly true))
                        (fn [] ~@body)))</code></pre>
<p>Here's how you use it:</p>
<pre><code>(try-backoff []
  (println &quot;trying!&quot;)
  (do-some-stuff))</code></pre>
<p>Also, add it to your Clojure Emacs config for better formatting, because this one wants the args on the first line:</p>
<pre><code>(put-clojure-indent &#39;try-backoff 1)</code></pre>
<p>This tells Emacs to make the second argument (<code>(println &quot;trying!&quot;)</code>) one indentation in, instead of directly under the first (<code>[]</code>).</p>
<h3 id="warning">Warning</h3>
<p>All of the <a href="http://www.lispcast.com/try-three-times#warning"><code>try3</code> warnings</a> apply. The stuff you're doing inside needs to be idempotent!</p>
<h3 id="conclusion">Conclusion</h3>
<p>This pattern is another cool, reusable component to help build reliability into a distributed system. Small, intermittent failures are pervasive. <strong>And a common form of error is a server being too busy.</strong> Being able to handle this type of error <strong>quickly and systematically</strong> is going to make your life easier.</p>
<p>Though Clojure does not have specific solutions to distributed systems problems, <strong>coding them up is short and straightforward</strong>. If you're interested in learning Clojure, I suggest you check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's a video course that uses animation, storytelling, and exercises to install Clojure into your brain.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>




<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/lisp-with-macros-language-stack">Lisp with Macros is Two Languages</a></li>
<li><a href="http://www.lispcast.com/try-three-times">Try Three Times</a></li>
<li><a href="http://www.lispcast.com/when-to-use-a-macro">When To Use a Macro in Clojure</a></li>
<li><a href="http://www.lispcast.com/pre-conj-david-pick">Pre-conj Prep: David Pick</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>meaning the server can only handle so many jobs at once, and the behavior is undefined at that point<a href="#fnref1">â†©</a></p></li>
</ol>
</div>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/solarized-cheat-sheet">
              Solarized Cheat Sheet
            </a>
          </h2>

          <div class="timestamp">
            March 11, 2015
          </div>

          
<p>Summary: <em>Solarized is an awesome color scheme that I use all the time. I was tired of looking up the hex codes, so I made my own cheat sheet. You can download it.</em></p>
<p>I like <a href="http://ethanschoonover.com/solarized">Solarized</a>. I use it in Emacs, in code when I highlight, and even in my presentations. I'm not good at choosing colors. Ethan Schoonover has made a really great color scheme that's great for what I do.</p>
<p>Despite having used it for years, I still have trouble naming the colors. I also don't think I'll ever remember the hex codes for HTML/CSS. Also, some apps still don't let you select colors using the system color dialog. The most accurate way to enter them in is hex RGB. So today I got fed up and made this cheat sheet.</p>
<p>Enjoy! Click the image below to get the PDF.</p>
<center>
<a href="http://www.lispcast.com/files/Solarized%20Cheat%20Sheet.pdf"><img src="http://www.lispcast.com/img/Solarized%20Cheat%20Sheet.png" alt="Solarized Cheat Sheet" /></a>
</center>



          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/object-function-duals-dispatch">
              Object-Oriented Dispatch is the Dual of Functional Dispatch
            </a>
          </h2>

          <div class="timestamp">
            March 11, 2015
          </div>

          
<p>Summary: <em>Object-oriented dispatch is contrasted with functional dispatch, but they are shown to be two one-dimensional views of the same two-dimensional data. Clojure does not provide the two-dimensional representation, but does interesting things to transcend the one-dimensional views.</em></p>
<p>About a month ago, I wrote a post about how <a href="http://www.lispcast.com/object-oriented-vs-functional-duals">OO-style is the dual of functional-style</a>. OO focuses on the data first, while functional focuses on the code. It is cool that <strong>the correspondence between the two is fairly clear and mechanical</strong>. It means that they're equivalent in a way. The distinction is mostly important when choosing how to represent a problem. A language should provide ways to express both (as Clojure does), and a way to translate between the two (which Clojure does not).</p>
<p>But it goes further than data vs code. In OO, the object is the unit of data (which manifests as the principle of encapsulation). <strong>But the object is also the unit of <em>dispatch</em>.</strong> Objects know their class, and classes know the implementations of their methods. <em>Class first, behavior second.</em> In a functional style of programming, <strong>the function is the unit of dispatch</strong>. A function knows how to react to all possible classes of arguments. <em>Behavior first, class second.</em></p>
<p>Example:</p>
<pre><code>(defn foo [x]
  (cond
    (string? x)
    ...
    (integer? x)
    ...
    (vector? x)
    ...</code></pre>
<p>So again, we have a kind of duality. The classic way to explain this is to show it in a table.</p>
<center>

<table>
<thead>
<tr class="header">
<th align="left">method/class</th>
<th align="left"><code>String</code></th>
<th align="left"><code>Integer</code></th>
<th align="left"><code>Vector</code></th>
<th align="left">...</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>toString</code></td>
<td align="left">.</td>
<td align="left">.</td>
<td align="left">.</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code>length</code></td>
<td align="left">.</td>
<td align="left">x</td>
<td align="left">.</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left"><code>+</code></td>
<td align="left">x</td>
<td align="left">.</td>
<td align="left">x</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><code>*</code></td>
<td align="left">x</td>
<td align="left">.</td>
<td align="left">x</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">...</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
</center>

<p>A dot represents an implementation, whereas an x represents an undefined operation.</p>
<p>In OO style, <strong>the class represents a single column</strong>. In functional style, <strong>the function represents a single row</strong>. Logically, however, the information is a two-dimensional table. That brings up a question: <strong>why don't languages store the information in this form internally?</strong> It is easy to project a column view or a row view from a table. And the x's in the table seem to be really useful for static checks.</p>
<p>Clojure does not represent its functions this way. But it does allow you to <strong>express your code in <em>either</em> a column view or a row view</strong>. The row view is the standard functional approach shown above. The column view is using <code>deftype</code>.</p>
<p>Example:</p>
<pre><code>(deftype Person
  Object ;; indicating I&#39;m overriding methods from Object
  (toString [p]
    ...)
  java.util.Comparable
  (compareTo [p]
    ...)
  ...)</code></pre>
<p>Clojure goes a step further: instead of having to write out the entire column (all methods given a class) in one place, you can essentially <strong>index directly into the table given a method/class pair</strong>, and define the implementation directly. This only works with protocol methods (not methods on classes/interfaces due to limitations in the JVM).</p>
<p>Example:</p>
<pre><code>(extend-type Object
  MyProtocol
  (mymethod [x o]
    ...))</code></pre>
<p>OO-style and functional-style are duals in terms of dispatch. It's very related to the data-first or code-first duality I wrote about before. Clojure again <strong>straddles both sides of the duality</strong> and lets you write code in both styles, as well as transcend the column/row distinction entirely when using protocols.</p>
<p><strong>How does your language deal with dispatch?</strong> Can you express the problem in the best way? If you're interested in this kind of topic, you would probably enjoy the <a href="http://www.clojuregazette.com/">Clojure Gazette</a>. It's a weekly newsletter filled with content to inspire Clojure programmers. It's completely free and it's easy to unsubscribe.</p>
<p>Thanks to <a href="http://www.marcusblankenship.com/">Marcus Blankenship</a> for the inspiration for this article.</p>
<div class="article-cg-box">
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/object-oriented-vs-functional-duals">Object-Oriented Programming is the Dual of Functional Programming</a></li>
<li><a href="http://www.lispcast.com/paper-metaphor">The Paper Metaphor</a></li>
<li><a href="http://www.lispcast.com/the-content-of-your-code">The Content of Your Code</a></li>
<li><a href="http://www.lispcast.com/what-is-functional-programming">What is Functional Programming?</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/task-analysis">
              Use Task Analysis to Break a Skill Into Steps
            </a>
          </h2>

          <div class="timestamp">
            March 07, 2015
          </div>

          
<p>Summary: <em>Many technical books skip very important skills you need to complete a task. To avoid skipping those skills, use task analysis to break a skill into steps.</em></p>
<center>
<img src="http://www.lispcast.com/img/owl.jpg" />
</center>

<p>This image reminds me of <strong>so many programming language books</strong>. The first chapter introduces the syntax, the second chapter is about writing a blog. What about all the stuff in the middle? I work hard in the LispCast courses to avoid skipping these steps.</p>
<p>The problem is clear: most technical skills are actually <strong>made up of hundreds if not thousands of smaller skills</strong>. I mean, tons of small decisions, perceptual skills, motor skills, etc. It's amazing really what people can chunk into a single idea. There are illustrators who think of the process as two steps. Likewise, many programmers are really good and think of complex code in two steps.</p>
<p>Our job as teachers is as clear as the problem: <strong>break down a skill into all of the smaller skills</strong>, then teach each of the smaller skills and how they lead to the big skill. It's so easy to state, and yet most people don't do this, even when they're writing for a beginner audience.</p>
<p>Why do so many programming language books spend so much time on syntax but fail at the intermediate stuff? It's because <strong>syntax is easy and usually already broken down for you</strong>. Once that's covered, it's hard to know the next step to teach if you haven't done the work of discovery. But they also focus on trivial stuff, like how to type literal integers. Hello? Really? If you bang on the number keys you can make integers.</p>
<p>So, how do you do it? How do real teachers do it? It's actually kind of boring. The kind of boring process that you might look at and say &quot;oh, well, obviously&quot;. The process is simply to <strong>do it yourself and keep notes about every little thing you did</strong>. Ask yourself really specific questions like &quot;Why did I start with two circles? Why do they overlap?&quot;</p>
<p>How do I make use of it in LispCast? <strong>I always start with the code I want my learners to be able to write.</strong> I write it all out first. Then I start breaking it down. Every construct (<code>if</code> statement, library function, etc.) is obviously something to teach. Then there are the value-add things, like <em>why</em> I chose one way over another. What questions do I ask myself to make the decisions? All of these things can and should be steps.</p>
<p>Now, the next step is matching the steps to the learners. Maybe they already know something, so I can just mention it or if it's well known, just do it without mentioning it. Some things might still be difficult, so <strong>I might need to break them down further</strong>.</p>
<p>At the same time, it could be better to avoid a certain concept. Like if you'd normally do it with a <code>cond</code> but they already know <code>if</code>, perhaps you should <strong>stick to what they know</strong> so you don't have to add several minutes to explain something that's not relevant to your topic. I try to go deep, so it's important to <strong>minimize the breadth</strong> of the material in order to finish on time. All of these little skills go into a curriculum, which I'll talk about in a future post.</p>
<p>I don't think this process is hard or original. I learned it from a book about teaching. I do think that most people who write technical books might be subject-matter experts, but <strong>they don't have any training in teaching</strong>. Teaching is a huge advantage. Even a simple process like this could really differentiate you from the other technical authors out there. And breaking down a task tells you what you need to teach (no more writer's block).</p>
<p>If you like the idea of teaching technical material, please sign up for my <em>Technical Teaching</em> mailing list, where I'll occasionally share skills for making material that helps people learn.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="//lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=98acb725b1"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    <div class="subscribe-form-text">
      <h3 class="subscribe-form-title">
        
Technical Teaching
</h3>
      <p class="subscribe-form-description">
        
I want to help people teach better. Sign up for this list and I'll occasionally send out some useful tips and skills that I've learned over the years.
</p>
      <div class="mc-field-group">
        
<label for="mce-FNAME">Name</label><br> <input id="mce-FNAME"
               class="fname-field"
               type="text"
               value=""
               placeholder="Name">
</div>
      <div>
        
<br> <label for="mce-EMAIL">Email</label><br> <input id="mce-EMAIL"
               class="email-field"
               type="email"
               value=""
               placeholder="Email"
               name="EMAIL">
</div>
      <div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_98acb725b1">
</div>
      
<br>
<div>
        
<input class="subscribe-button"
               type="submit"
               value="Go!"
               name="subscribe">
</div>
      
<br>
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/learning-is-about-skills">How to avoid &quot;Makes sense if you already understand it.&quot;</a></li>
<li><a href="http://www.lispcast.com/making-true-false-easy">Making True/False Questions Easy</a></li>
<li><a href="http://www.lispcast.com/pre-west-elena-machkasova">Pre-West Prep: Elena Machkasova</a></li>
<li><a href="http://www.lispcast.com/pre-west-interview-elena-machkasova">Pre-West Interview: Elena Machkasova</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/try-three-times">
              Try Three Times
            </a>
          </h2>

          <div class="timestamp">
            March 05, 2015
          </div>

          
<p>Summary: <em>Distributed systems fail in indistinguishable ways. Often, retrying is a good solution to intermittent errors. We create a retry macro to handle the retries in a generic way.</em></p>
<p>Let's face it: your system is probably a distributed system. All web apps are by definition distributed. They have at least one server, probably a separate database server, and many browser clients. And now microservices are getting popular. Distributed is the current and future normal. While Clojure solves the problems of multiple cores sharing memory at the language level, <strong>distributed systems problems are left to be addressed at the application level</strong>.</p>
<h2 id="the-problem">The problem</h2>
<p>One big problem that comes up all the time in distributed systems is dealing with failure. Failure happens everywhere. The problem in a distributed system is that <strong>you don't know where the failure happened</strong>. For example, let's say you make an HTTP GET request and 20 seconds later, you're still waiting for the response. Is it:</p>
<ul>
<li>A network failure?
<ul>
<li>Did the message not get to the server?</li>
<li>Did the message get there, but the response didn't make it back?</li>
</ul></li>
<li>The server is down?</li>
<li>The server is still working?</li>
<li>The response is still coming?</li>
<li>An intermediate computer (proxy) has filtered the request/response?</li>
</ul>
<p>It is literally impossible to know what the problem is. And that's ok. There's a lot of machinery between one machine and the next. Even if you could diagnose the problem, <strong>are you really going to program each error case?</strong></p>
<h3 id="metaphor">Metaphor</h3>
<p>Let's say you call your friend and they don't pick up. Are they asleep? Is their phone off? Did the call not go through? The phone won't tell you. And you really want to talk to them. So what do you do? <strong>You call back.</strong> You might even call back a couple of times. If they pick up when you call back, great! If not, then you get tired and give up.</p>
<p>That's a common approach in distributed systems as well: retry your distributed message a few times before you give up. It's easy and <strong>fixes a surprising number of problems</strong>. What's more, there's a good solution that's <em>simple</em> in the Hickeyan sense.</p>
<h2 id="the-solution">The solution</h2>
<p><strong>Failure in Clojure typically means an Exception.</strong> So we'll need to catch exceptions and run code multiple times.</p>
<pre><code>(defn try-n-times [f n]
  (if (zero? n)
    (f)
    (try
      (f)
      (catch Throwable _
        (try-n-times f (dec n))))))</code></pre>
<p>You pass it a function and a number of times to retry it. The base case is when <code>n</code> is 0. In that case, it will just try it (not <em>re</em>try). If it's greater than 0, it will wrap the function call in a <code>try/catch</code>, catch everything, and recurse. If after n retries, is still throws an exception, <code>try-n-times</code> will fail and some other code will have to deal with it. <strong>The concern of retrying is separated from what is being retried.</strong></p>
<h3 id="how-do-you-use-it">How do you use it?</h3>
<p>Wrap your distributed calls in this bad boy and you're good to go.</p>
<p>Instead of this:</p>
<pre><code>(http/get &quot;http://somewhat-reliable.com/resource&quot;
          {:socket-timeout 1000
           :conn-timeout   1000})</code></pre>
<p>You do this:</p>
<pre><code>(try-n-times #(http/get &quot;http://somewhat-reliable.com/resource&quot;
                        {:socket-timeout 1000
                         :conn-timeout 1000}) 2)</code></pre>
<p>Remember, <code>n</code> is the number of <em>re</em>tries. So that's 1 <em>try</em> + 2 <em>re</em>tries.</p>
<h3 id="macro-anyone">Macro, anyone?</h3>
<p><strong>Alright, yes, I made a macro for that.</strong> It does come in handy to have a macro that you can put code in instead of passing in a function.</p>
<pre><code>(defmacro try3 [&amp; body]
  `(try-n-times (fn [] ~@body) 2))</code></pre>
<p>This one is used like this:</p>
<pre><code>(try3
  (println &quot;trying!&quot;)
  (do-some-stuff))</code></pre>
<h3 id="warning">Warning</h3>
<p>Now, a little care needs to be taken when you use this. Remember, when you get a failure, it could be a timeout. The server could be processing your request. Or it could have failed halfway through a multi-step process. What that means practically is that <strong>your distributed message has to be idempotent</strong>. HTTP GET <em>is</em> idempotent, so it's ok. POST generally is not, but sometimes it is. Use your judgment! Also, you should make your call timeout, to turn long waits into errors.</p>
<h3 id="conclusion">Conclusion</h3>
<p>This pattern is just one piece of a larger distributed system puzzle. The network and servers are unreliable. They might work the whole time during development, but in the fullness of time, <strong>an always-on distributed system <em>will</em> have some kind of failure eventually</strong>. Sometimes the failures are temporary, and in those cases, a quick retry can fix it right away.</p>
<p>Though Clojure does not have specific solutions to distributed systems problems, coding them up is short and straightforward. If you're interested in learning Clojure, I suggest you check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's a video course that uses animation, storytelling, and exercises to install Clojure into your brain.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/exponential-backoff">Exponential Backoff</a></li>
<li><a href="http://www.lispcast.com/lisp-with-macros-language-stack">Lisp with Macros is Two Languages</a></li>
<li><a href="http://www.lispcast.com/when-to-use-a-macro">When To Use a Macro in Clojure</a></li>
<li><a href="http://www.lispcast.com/pre-conj-david-pick">Pre-conj Prep: David Pick</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/data-first-programming">
              Data-First Programming
            </a>
          </h2>

          <div class="timestamp">
            February 27, 2015
          </div>

          
<p>Summary: <em>If something is important, you should deal with it sooner and more often. That's the approach Clojure takes to data representations. It means serialization of internal data is a non-issue.</em></p>
<p>Netflix has a counterintuitive but brilliant system called <em>Chaos Monkey</em>. Chaos Monkey will randomly kill services. It is trying to simulate, in the microcosm of a business day, the craziness that happens in the production macrocosm. Services die, servers fail, latency spikes, and networks partition. It might not be soon, but eventually it will happen. Better deal with it now, when people are at work to deal with it. Chaos Monkey encourages you to <strong>write your code to work in such a chaos-filled environment so that unexpected failures are a breeze.</strong> The idea is an instance of the more general principle of &quot;if something is important, deal with it sooner and more often&quot;.</p>
<p>There's something related to this idea of surfacing the errors early that I've been thinking about. It's about data. Have you ever written some classes and everything is well and good. And then after a while, you need to serialize that to disk or across a network. Now you have to come up with some format (maybe JSON or XML) to represent your class. Then, whenever the class changes, <strong>you have to remember to change the data format to keep them in sync</strong>. It's kind of painful!</p>
<p>Well, I'll tell you, that rarely happens in Clojure. Because in Clojure, you often <strong>start with data structures</strong>. Meaning, you're already thinking in data, modeling in data, and working in data. <strong>Serialization becomes a non-issue</strong>, because Clojure data structures come built in with <a href="https://github.com/edn-format/edn">readers and writers</a>. Just like causing errors to happen early because they will happen eventually, Clojure programmers code in data <em>in part</em> because you're going to need data (serialization and deserialization) eventually.</p>
<p>If this idea intrigues you, you may want to check out Clojure. Its <strong>data structures are cutting edge</strong>! Check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a> if you would like to get into functional programming using animations, exercises, and screencasts.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/3-things-java-can-steal-from-clojure">3 Things Java Programmers Can Steal from Clojure</a></li>
<li><a href="http://www.lispcast.com/atom-problem">Atom code explanation</a></li>
<li><a href="http://www.lispcast.com/clojure-gazette-looking-forward-2015">Clojure Gazette Looking Forward</a></li>
<li><a href="http://www.lispcast.com/clojure-is-imperative">Clojure is Imperative</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/paper-metaphor">
              The Paper Metaphor
            </a>
          </h2>

          <div class="timestamp">
            February 27, 2015
          </div>

          
<p>Summary: <em>Functional programs follow a simple rule: never write on the same paper twice. Imperative programs are free to define their own rules. Both have interesting consequences.</em></p>
<p>I just read <a href="https://emily.st/2015/02/26/functional-programming-for-everyone-else/">Functional Programming for Everyone Else</a> by Emily St. It's a good read about the fundamental differences between Turing Machines and Lambda Calculus. Near the end, she mentioned this:</p>
<blockquote>
<p>I think of functional programs as ones which do their jobs without stopping to take notes along the way.</p>
</blockquote>
<p>That got me thinking of the metaphor of taking notes. It's an interesting metaphor, because as she mentions in the article, modern computers are based more on Turing Machines, with their tapes (notes), rather than Lambda Calculus. <strong>Lambda Calculus being abstract instead of mechanical (what instead of how), it doesn't show its work.</strong></p>
<p>In the spirit of more perspectives being better than fewer, I'd like to give my metaphor, inspired by idea above. <strong>Functional programs are those that have a very simple rule: never write on the same paper twice.</strong> In Turing Machine terms, it means never write on the same piece of tape twice. This rule is simple enough that you can build it into the compiler and runtime to enforce it. <strong>In programming language theory, we call this immutability.</strong> Once a paper is written on, it is immutable.</p>
<p>Imperative programs, on the other hand, don't have such a rule. They can write on any piece of paper, even write over or erase what's written. <strong>They rely on their own code to enforce rules</strong> for how to organize these pieces of paper so that it still makes sense. They might use locks, which are notoriously hard to get right.</p>
<p>The nice thing about functional programs is you get a nice <strong>record of what's happened</strong>. You can step through all of the intermediate work because it was never overwritten. It's like an <strong>artist keeping their old sketches</strong> that led up to their masterpiece. Imperative programs are like finding out that it was all done on the same canvas, art painted over art, irrevocably lost. There is no xray to uncover it.</p>
<p>The other nice thing about functional programs is <strong>multiple programs can share the same stack of paper</strong>. Since they're following a rule, they will never overwrite someone else's work. But imperative programs need to have <strong>complex coordination rules</strong> to make sure that they aren't writing on the same page at the same time, or overwriting something that someone else will need.</p>
<p>If you'd like to learn Functional Programming, I can recommend <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It will teach you Functional Programming using Clojure, animations, and screencasts, along with many exercises.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>





<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/object-function-duals-dispatch">Object-Oriented Dispatch is the Dual of Functional Dispatch</a></li>
<li><a href="http://www.lispcast.com/object-oriented-vs-functional-duals">Object-Oriented Programming is the Dual of Functional Programming</a></li>
<li><a href="http://www.lispcast.com/the-content-of-your-code">The Content of Your Code</a></li>
<li><a href="http://www.lispcast.com/what-is-functional-programming">What is Functional Programming?</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/intro-clojure-test-peap">
              On sale now: Intro to clojure.test Early Access
            </a>
          </h2>

          <div class="timestamp">
            February 27, 2015
          </div>

          
<p>Summary: <em>LispCast Intro to clojure.test is on sale now for a limited time through the PurelyFunctional.tv Early Access Program.</em></p>
<p><strong>Update:</strong> <em>PEAP is now closed for Intro to clojure.test. Sign up below to find out when the finished product is published.</em></p>
<p>Folks, it's happening. I just opened up the <em>PurelyFunctional.tv Early Access Program</em> for <em>LispCast Into to clojure.test</em>. If you like to be <strong>on the cutting edge</strong> or get <strong>lots of access to the teacher</strong>, now's your chance. Open for 48 hours only!</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    
<img class="subscribe-form-image"
         src="http://www.purelyfunctional.tv/img/ring_spec_1_3.png" />
<div class="subscribe-form-text">
      <h3 class="subscribe-form-title">
        
Get free Clojure stuff and news on LispCast courses
</h3>
      <p class="subscribe-form-description">
        
Subscribe below to receive free Clojure materials, including a Ring Spec to hang on your wall and more as they come out. This is also the list where I announce launches of LispCast courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][2]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/purelyfunctional-tv-early-access-program">PurelyFunctional.tv Early Access Program</a></li>
<li><a href="http://www.lispcast.com/task-analysis">Use Task Analysis to Break a Skill Into Steps</a></li>
<li><a href="http://www.lispcast.com/new-course-format">New Course Format</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/purelyfunctional-tv-early-access-program">
              PurelyFunctional.tv Early Access Program
            </a>
          </h2>

          <div class="timestamp">
            February 25, 2015
          </div>

          
<p>Summary: <em>The PurelyFunctional.tv Early Access Program is a way to make courses in a more iterative and interactive way. I'll be publishing Intro to clojure.test this week under PEAP.</em></p>
<p>Computers and the Internet have allowed people to <strong>produce better products than has ever been done</strong>. Photography is better because of Flickr. Handmade knives are stronger and sharper than ever. Stone arrowhead making is better than ever. People are able to experiment, share their results, and learn the results of others faster than ever before, because <strong>the Internet allows them to communicate faster</strong>.</p>
<p>It's simply a matter of speed and accessibility. I want to bring that speed and accessibility to LispCast courses. I have been working hard on building a <strong>platform for me to develop courses iteratively</strong>. That means I can make them in smaller steps. The other piece is the feedback, where I ask you, my awesome customers, to borrow your brain for a bit. Talk about what works for you and what doesn't. I'll listen, answer questions, discuss them with you, and incorporate what I learn into the course.</p>
<center>
<img src="http://www.lispcast.com/img/PEAP.jpg" />
</center>

<p>Everyone wins. You get to <strong>learn what you need to learn faster</strong>, with <em>your</em> questions answered. And I get to make the course better for everyone. Seems like a good deal.</p>
<p>I'm creating what I'll call the <em>PurelyFunctional.tv Early Access Program</em>. It's simple. As soon as a course has a bit of content and interest, I'll post it up for sale. You get to download the course in a first draft. Let me know what questions you have, where you're having trouble, or things that were too easy. <strong>I'll continuously work those things in</strong>, and let you know when to download the new one.</p>
<p>I'll throw in another small benefit: if you're part of the PEAP, meaning your buy the course before it's finished, I'll <strong>put your name in a <em>Thank you</em> page</strong> in the course and on the course information page. Everyone who goes there will be able to see it.</p>
<p>To kick off the Program, I'm going to be publishing <a href="http://www.purelyfunctional.tv/intro-to-clojure-test">LispCast Intro to clojure.test</a>, in its current state, <em>this week</em>. <strong>Entry into the Program will be available for a limited time.</strong> So sign up below if you'd like to be a part of it. I'll send out an announcement with the instructions.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    
<img class="subscribe-form-image"
         src="http://www.purelyfunctional.tv/img/ring_spec_1_3.png" />
<div class="subscribe-form-text">
      <h3 class="subscribe-form-title">
        
Get free Clojure stuff and news on LispCast courses
</h3>
      <p class="subscribe-form-description">
        
Subscribe below to receive free Clojure materials, including a Ring Spec to hang on your wall and more as they come out. This is also the list where I announce launches of LispCast courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][2]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/intro-clojure-test-peap">On sale now: Intro to clojure.test Early Access</a></li>
<li><a href="http://www.lispcast.com/task-analysis">Use Task Analysis to Break a Skill Into Steps</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


        <article class="article">
          <h2 class="article-title-wrapper">
            <a class="article-title"
               href="/hiccup-tips">
              Hiccup Tips
            </a>
          </h2>

          <div class="timestamp">
            February 24, 2015
          </div>

          
<p>Summary: <em>Hiccup is a Clojure DSL for generating HTML. If you're using it, you might like these tips.</em></p>
<p><a href="https://github.com/weavejester/hiccup">Hiccup</a> is a Clojure Domain Specific Language (DSL) for programmatically generating HTML. <strong>It's one of the three tools I recommend in <a href="http://www.lispcast.com/what-web-framework-should-i-use">my Clojure Web stack</a>.</strong> It's a thin layer over HTML, but oh, how I welcome that layer! The biggest win is that since it's an <em>internal</em> DSL, you can begin abstracting with functions in a way that you will never be able to, even in templating engines.</p>
<p>Hiccup is an example of a great Clojure DSL. It uses literal data structures pretty well, it's as or more readable than what it translates into, and, as a layer of indirection, solves a few sticky problems of HTML. If you don't know it, go check out the <a href="http://www.rkn.io/2014/03/13/clojure-cookbook-hiccup/">Clojure Cookbook recipe for Hiccup</a>. <strong>Hiccup might take some getting used to, but once you do, you'll appreciate it.</strong></p>
<p>This article will assume you are familiar with the syntax and want to up your game.</p>
<h3 id="cross-site-scripting-vulnerability">Cross-site Scripting Vulnerability</h3>
<p>Ok, <a href="http://www.lispcast.com/clojure-web-security#a3-cross-site-scripting-xssa3">this one is a pretty bad problem</a>. Hiccup generates Strings, just plain old Java strings. If you put a String in the body of a Hiccup tag, it will just concatenate it right in there, no questions asked. That's <strong>just asking to be exploited</strong>, because that String is going to be shipped off to the browser and rendered, scripts and all.</p>
<p><strong>Most templating libraries will default to escaping any String you pass them.</strong> The non-default, usually obviously marked alternative is to pass in a String unescaped. Hiccup got this backwards and it just sucks. It means you have to do extra work to be secure, and if you forget just once, your site is vulnerable.</p>
<p><strong>The fix:</strong> This is the work you have to do every time you're getting a String that could be from the &quot;outside&quot; (a form submission, API request, etc.). Normally, you'd do this:</p>
<pre><code>[:div content-of-div]</code></pre>
<p>That will work but it's unsafe. You should do this:</p>
<pre><code>[:div (h content-of-div)]</code></pre>
<p>That little <code>h</code> (<code>hiccup.core/h</code> to be exact) there means escape the String. It sucks, but that's how you do it in Hiccup. One day I want to write a secure fork of Hiccup.</p>
<h3 id="overloading-vectors">Overloading vectors</h3>
<p>One downside to Hiccup and any DSL that overloads the meaning of vectors is that <strong>vectors are no longer useful as sequences within Hiccup</strong>. They now mean &quot;start a new HTML tag&quot;. It's not a huge deal, but I've spent a lot of time debugging my code, only to realize that I was using a vector to represent a sequence. I use literal vectors everywhere else (because they're convenient and readable), but in Hiccup land they're wrong.</p>
<p><strong>The fix:</strong> You can't use a literal vector, but you can call <code>list</code> to create a list. Not as beautiful, but it is correct. Sometimes I will call <code>seq</code> on a return value to ensure that it's never a vector.</p>
<h3 id="multiple-tags">Multiple tags</h3>
<p>I don't know why this still happens, but it's common, so I'll mention it. Sometimes I'll be looking at the HTML output in a browser and I just can't find an element. It's gone. Reload, still not there. When I look through the code, the hiccup to generate the tag is <em>right there</em>! Why won't it render?</p>
<p>Well, long story short, it's because in Clojure, <strong>only the <em>last value</em> of a <code>let</code> or <code>fn</code> is returned</strong>. Doh! My missing element was being rendered then discarded.</p>
<pre><code>(defn list-with-header [header items]
  [:h3 header] ;; this header is missing
  [:ul
    (for [i items]
      [:li i])])</code></pre>
<p><strong>The fix:</strong> Wrap the two (or more) things in a list (not a vector!).</p>
<pre><code>(defn list-with-header [header items]
  (list ;; wrap in a list, not a vector
    [:h3 header] ;; now it&#39;s there
    [:ul
      (for [i items]
        [:li i])]))</code></pre>
<h3 id="hiccup-plays-nice-with-nil">Hiccup plays nice with <code>nil</code></h3>
<p>This one is just a little design touch with some perks, not a problem that it's solving. In Hiccup, the empty list renders nothing. This is extended to <code>nil</code> as well. A common thing in HTML is that you want to render a bunch of children in a parent tag, but <strong>you don't want the parent tag if the list is empty</strong>.</p>
<p>Standard constructs will render the parent tag:</p>
<pre><code>[:ul
  (for [i items]
    [:li i])]</code></pre>
<p>When <code>items</code> is empty, you still get <code>&lt;ul&gt;&lt;/ul&gt;</code>. This is a problem with lots of templating libraries.</p>
<p><strong>The fix:</strong> The fix in Hiccup is due to it playing nice with <code>nil</code>. Wrap the parent in a <code>when</code>:</p>
<pre><code>(when (seq items)
  [:ul
    (for [i items]
      [:li i])])</code></pre>
<p>It's not beautiful, but then again, you could be using HTML with Moustache.</p>
<h3 id="use-defn-for-snippet-abstraction">Use <code>defn</code> for snippet abstraction</h3>
<p><strong>HTML has no way to abstract.</strong> The crap you see is the crap you get. Many templating libraries have some kind of snippet concept, often referring to different files. Well, because Hiccup is just code inside of Clojure, you've got a better designed way of making reusable pieces of Hiccup.</p>
<p>Let's say I'm repeating something a lot:</p>
<pre><code>[:div
  [:ul
    (for [i list1]
      [:li i])]
  [:ul
    (for [i list2]
      [:li i])]
  [:ul
    (for [i list2]
      [:li i])]]</code></pre>
<p>That <code>ul</code> is basically the same three times.</p>
<p><strong>The fix:</strong> Standard functional abstraction. Pull out the repeated bit into a new, named function.</p>
<pre><code>(defn make-list [items]
  [:ul
    (for [i items]
      [:li i])])</code></pre>
<p>Now you can call it from inside of Hiccup:</p>
<pre><code>[:div
  (make-list list1)
  (make-list list2)
  (make-list list3)]</code></pre>
<h3 id="compiling-your-snippets">Compiling your snippets</h3>
<p>You may know this, but Hiccup is a <em>compiling</em> macro. That means it takes your literal vectors, maps, etc, and at <em>compile time</em>, generates code that will generate your HTML. All this means is that <strong>Hiccup is really fast</strong>, about as fast as concatenating strings can be.</p>
<p>But, because the Hiccup compiler doesn't do a full examination of your code, it can't compile everything. It inserts run time fallbacks for stuff it can't handle at compile time which will interpret it at run time. So, for instance, <strong>if you're calling a function that returns some Hiccup, it can't compile that automatically</strong>. It has to wait till the function returns to know what it is. That is, unless . . .</p>
<p>**The fix: ** The way to get Hiccup to compile something is with the <a href="http://weavejester.github.io/hiccup/hiccup.core.html#var-html"><code>hiccup.core/html</code></a> macro. That's the macro that does the compilation and it will do it anywhere. So if you've got code like this:</p>
<pre><code>(defn make-list [items]
  [:ul
    (for [i items]
      [:li i])])

(defn my-three-lists []
  [:div
    (make-list list1)
    (make-list list2)
    (make-list list3)])</code></pre>
<p>You should wrap the Hiccup form in its own compiler, like this:</p>
<pre><code>(defn make-list [items]
  (html
    [:ul
      (for [i items]
        [:li i])]))</code></pre>
<p>For this little example, it probably won't make a noticeable difference. But it can be significant for larger documents.</p>
<p>Just to note: the Hiccup compiler can understand <code>if</code> and <code>for</code> forms, so there's no need to wrap them in the compiler. No hard either.</p>
<h3 id="autoterminating">Autoterminating</h3>
<p>Just a good thing to know about HTML.</p>
<p>Did you know that this is not legal HTML?</p>
<pre><code>&lt;script /&gt;</code></pre>
<p>It's true. A <code>script</code> tag can't be self-closing.</p>
<p>There's all sort of silly rules in HTML like this. And then there's XML mode versus HTML mode. We are lucky: <strong>Hiccup does all of this for you</strong>, so you don't have to wade through the HTML spec(s!) looking for why something won't render in IE7.</p>
<p><strong>The fix:</strong> <code>hiccup.core/html</code> takes a map of options as the first argument (it's optional). If you pass in a <code>:mode</code> option, it will set the correct HTML mode, which unfortunately are incompatible. There are three modes, <code>:xml</code>, <code>:html</code>, and <code>:xhtml</code>. The default is <code>:xhtml</code>.</p>
<h3 id="idclass-dsl">Id/class DSL</h3>
<p>Hiccup is a DSL. And it has its own <strong>sub DSL for HTML ids and classes</strong>. It's similar to CSS selectors.</p>
<p>Let's say you have a <code>div</code> like this:</p>
<pre><code>[:div
  {:id &quot;main-content&quot;
   :class &quot;blue-background green-border&quot;}
  (h &quot;Here&#39;s some content.&quot;)]</code></pre>
<p>Well, Hiccup lets you make that shorter and easier to read.</p>
<p><strong>The fix:</strong> Use the id/class DSL:</p>
<pre><code>[:div#main-content.blue-background.green-border
  (h &quot;Here&#39;s some content&quot;)]</code></pre>
<p>Here's how it works. Every element has an optional id and zero or more classes. After the tag name (<code>div</code> here), you can put the id after a <code>#</code>. Then list your classes starting with a <code>.</code> each. Omit the <code>#</code> if there's no id. Ditto for the <code>.</code> if there's no class. Oh, and the id must come first. That will get converted to the id and class attributes you want. Also, these will conflict with attributes in the map, so <strong>choose one or the other, not both</strong>.</p>
<h3 id="generating-hiccup-from-html">Generating Hiccup from HTML</h3>
<p>Last thing, I promise!! Sometimes you have some HTML that someone gave you and <strong>you want to Hiccupify it so you can just stick it into your code</strong>. Manually doing that is kind of tedious. Luckily, there's a solution our there for you.</p>
<p><strong>The fix:</strong> <a href="https://github.com/weavejester/hiccup/wiki/Converting-html-to-hiccup">This page</a> lists three options for outputting HTML from Hiccup. I have personally used <a href="https://github.com/hozumi/hiccup-bridge">Hiccup-bridge</a>. It does a good job (and it even goes both ways). You call it like this:</p>
<pre><code>lein hicv 2clj hello.html</code></pre>
<p>That will output <code>hicv/hello.clj</code> in hiccup format. Pretty rocking when you need it.</p>
<h3 id="conclusion">Conclusion</h3>
<p>Well, there you go. My Hiccup tips. <strong>Hiccup is pretty nice for templating.</strong> I recommend using it (or my future secure fork) in your web projects. If you'd like to learn more Hiccup and how to build web apps in Clojure, please check out [Lispcast Web Development in Clojure][webdev]. It's a video course teaching just that. All you need to know is Clojure and HTML.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get a Free Ring Spec to hang on your wall
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/ring_spec_1_3.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of a Ring Spec to hang on your wall. If you are programming in Ring (covered in the videos), you'll find it very useful as a reference. You'll also hear about exclusive previews and discounts of other video courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][4]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/cascading-separation-abstraction">Separation, Abstraction, and Cascading in CSS</a></li>
<li><a href="http://www.lispcast.com/clojure-web-security">Clojure Web Security</a></li>
<li><a href="http://www.lispcast.com/json-serialization-api-clojure">JSON Serialization for APIs in Clojure</a></li>
<li><a href="http://www.lispcast.com/parts-of-ring">The Parts of Ring</a></li>
</ul>


          <div class="endmark">
            <a class="endmark-link"
               href="/">
              <img class="endmark-lambda"
                   src="/img/lambda.png" />
            </a>
          </div>

        </article>


      <div class="notes">

      </div>

    </div>

    <footer class="footer-banner">
      <a class="footer-previous"
         href="page8.html">
        <i class="fa fa-chevron-left footer-arrow"></i>
      </a>
      <a class="footer-next"
         href="page6.html">
        <i class="fa fa-chevron-right footer-arrow"></i>
      </a>
    </footer>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <script>

      document.write('<script src="https://oberon.herokuapp.com/cookie/get.js?_=' + (new Date()).getTime() + '"><\/script>');

          if(window.oberon && mixpanel) {
            if(document.cookie.indexOf('oberon-id') < 0) {
              var expires = (new Date((new Date().getTime() + 1000*60*60*24*365*10))).toUTCString();
              mixpanel.alias(window.oberon.id);
              document.cookie = "oberon-id=" + window.oberon.id + ";expires=" + expires + ";path=/";
            }
            mixpanel.identify(window.oberon.id);
          }

      mixpanel.register({URL: window.location.pathname,
                         Title: $("title").text()});

      mixpanel.track("Page Visit");

      mixpanel.track_forms('.gazette-form', 'Submit Clojure Gazette');
      mixpanel.track_forms('.subscribe-form', 'Subscribe');

      mixpanel.track_links('a.homepage-offer-box-link',
                           'Click PurelyFunctional.tv',
                           function(e) {
                             return {ToURL: $(e).prop('href')};
                           });

      mixpanel.track_links('a.js-clojuregazette',
                           'Click Clojure Gazette',
                           function(e) {
                             return {ToURL: $(e).prop('href')};
                           });

      $('input[name=EMAIL]').change(function() {
                                                      var i = $(this);
                                                      window.o_email = i.val();
                                                      });

      $('form').submit(function() {
        if(window.o_email)
          mixpanel.people.set({"$email": window.o_email});
});

    </script>

  </body>
</html>
