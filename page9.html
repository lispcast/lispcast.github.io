<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

    <title>LispCast</title>
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@ericnormand">
    <meta name="twitter:creator" content="@ericnormand">
    <meta name="twitter:description" content="A blog about the simple joys of functional programming.">
    <meta name="twitter:title" content="LispCast">

    <meta property="og:title" content="LispCast">
    <meta property="og:description" content="A blog about the simple joys of functional programming.">

    <meta name="description" content="A blog about the simple joys of functional programming.">

    <meta name="author" content="Eric Normand">

    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!--[if lt IE 9]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="/css/styles.css" type="text/css">

    <link rel="alternate" type="application/rss+xml"
    title="LispCast" href="/feed" />

    <!-- start Mixpanel --><script type="text/javascript">(function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
      for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);
                  mixpanel.init("ffad2bd88d2cb690edbbba6cf30b2958");</script><!-- end Mixpanel -->
                  </head>

  <body>
    <header class="banner">
      <h1 class="banner-logo">
        <a href="/">
          <img class="banner-logo-img"
               src="/img/Logo@2x.png"
               alt="LispCast" />
        </a>
      </h1>

      <div class="meta-data">
        <img class="bio-img"
             src="/img/eric_bio.jpg" />
        <a class="twitter-link"
           href="http://twitter.com/ericnormand">
          <i class="fa fa-twitter"></i>
        </a>
        <a class="github-link"
           href="https://github.com/ericnormand">
          <i class="fa fa-github"></i>
        </a>
        <a class="mail-link"
           href="mailto:eric@lispcast.com">
          <i class="fa fa-envelope"></i>
        </a>
        <a class="rss-link"
           href="/feed">
          <i class="fa fa-rss-square"></i>
        </a>
        <a class="rss-link"
           href="/archive.html">
          <i class="fa fa-list"></i>
        </a>
      </div>

    </header>

    <div class="main-container">


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/try-three-times">
            Try Three Times
          </a>
        </h2>

        <div class="timestamp">
          March 05, 2015
        </div>

        
<p>Summary: <em>Distributed systems fail in indistinguishable ways. Often, retrying is a good solution to intermittent errors. We create a retry macro to handle the retries in a generic way.</em></p>
<p>Let's face it: your system is probably a distributed system. All web apps are by definition distributed. They have at least one server, probably a separate database server, and many browser clients. And now microservices are getting popular. Distributed is the current and future normal. While Clojure solves the problems of multiple cores sharing memory at the language level, <strong>distributed systems problems are left to be addressed at the application level</strong>.</p>
<h2 id="the-problem">The problem</h2>
<p>One big problem that comes up all the time in distributed systems is dealing with failure. Failure happens everywhere. The problem in a distributed system is that <strong>you don't know where the failure happened</strong>. For example, let's say you make an HTTP GET request and 20 seconds later, you're still waiting for the response. Is it:</p>
<ul>
<li>A network failure?
<ul>
<li>Did the message not get to the server?</li>
<li>Did the message get there, but the response didn't make it back?</li>
</ul></li>
<li>The server is down?</li>
<li>The server is still working?</li>
<li>The response is still coming?</li>
<li>An intermediate computer (proxy) has filtered the request/response?</li>
</ul>
<p>It is literally impossible to know what the problem is. And that's ok. There's a lot of machinery between one machine and the next. Even if you could diagnose the problem, <strong>are you really going to program each error case?</strong></p>
<h3 id="metaphor">Metaphor</h3>
<p>Let's say you call your friend and they don't pick up. Are they asleep? Is their phone off? Did the call not go through? The phone won't tell you. And you really want to talk to them. So what do you do? <strong>You call back.</strong> You might even call back a couple of times. If they pick up when you call back, great! If not, then you get tired and give up.</p>
<p>That's a common approach in distributed systems as well: retry your distributed message a few times before you give up. It's easy and <strong>fixes a surprising number of problems</strong>. What's more, there's a good solution that's <em>simple</em> in the Hickeyan sense.</p>
<h2 id="the-solution">The solution</h2>
<p><strong>Failure in Clojure typically means an Exception.</strong> So we'll need to catch exceptions and run code multiple times.</p>
<pre><code>(defn try-n-times [f n]
  (if (zero? n)
    (f)
    (try
      (f)
      (catch Throwable _
        (try-n-times f (dec n))))))</code></pre>
<p>You pass it a function and a number of times to retry it. The base case is when <code>n</code> is 0. In that case, it will just try it (not <em>re</em>try). If it's greater than 0, it will wrap the function call in a <code>try/catch</code>, catch everything, and recurse. If after n retries, is still throws an exception, <code>try-n-times</code> will fail and some other code will have to deal with it. <strong>The concern of retrying is separated from what is being retried.</strong></p>
<h3 id="how-do-you-use-it">How do you use it?</h3>
<p>Wrap your distributed calls in this bad boy and you're good to go.</p>
<p>Instead of this:</p>
<pre><code>(http/get &quot;http://somewhat-reliable.com/resource&quot;
          {:socket-timeout 1000
           :conn-timeout   1000})</code></pre>
<p>You do this:</p>
<pre><code>(try-n-times #(http/get &quot;http://somewhat-reliable.com/resource&quot;
                        {:socket-timeout 1000
                         :conn-timeout 1000}) 2)</code></pre>
<p>Remember, <code>n</code> is the number of <em>re</em>tries. So that's 1 <em>try</em> + 2 <em>re</em>tries.</p>
<h3 id="macro-anyone">Macro, anyone?</h3>
<p><strong>Alright, yes, I made a macro for that.</strong> It does come in handy to have a macro that you can put code in instead of passing in a function.</p>
<pre><code>(defmacro try3 [&amp; body]
  `(try-n-times (fn [] ~@body) 2))</code></pre>
<p>This one is used like this:</p>
<pre><code>(try3
  (println &quot;trying!&quot;)
  (do-some-stuff))</code></pre>
<h3 id="warning">Warning</h3>
<p>Now, a little care needs to be taken when you use this. Remember, when you get a failure, it could be a timeout. The server could be processing your request. Or it could have failed halfway through a multi-step process. What that means practically is that <strong>your distributed message has to be idempotent</strong>. HTTP GET <em>is</em> idempotent, so it's ok. POST generally is not, but sometimes it is. Use your judgment! Also, you should make your call timeout, to turn long waits into errors.</p>
<h3 id="conclusion">Conclusion</h3>
<p>This pattern is just one piece of a larger distributed system puzzle. The network and servers are unreliable. They might work the whole time during development, but in the fullness of time, <strong>an always-on distributed system <em>will</em> have some kind of failure eventually</strong>. Sometimes the failures are temporary, and in those cases, a quick retry can fix it right away.</p>
<p>Though Clojure does not have specific solutions to distributed systems problems, coding them up is short and straightforward. If you're interested in learning Clojure, I suggest you check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It's a video course that uses animation, storytelling, and exercises to install Clojure into your brain.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/exponential-backoff">Exponential Backoff</a></li>
<li><a href="http://www.lispcast.com/lisp-with-macros-language-stack">Lisp with Macros is Two Languages</a></li>
<li><a href="http://www.lispcast.com/when-to-use-a-macro">When To Use a Macro in Clojure</a></li>
<li><a href="http://www.lispcast.com/pre-conj-david-pick">Pre-conj Prep: David Pick</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/data-first-programming">
            Data-First Programming
          </a>
        </h2>

        <div class="timestamp">
          February 27, 2015
        </div>

        
<p>Summary: <em>If something is important, you should deal with it sooner and more often. That's the approach Clojure takes to data representations. It means serialization of internal data is a non-issue.</em></p>
<p>Netflix has a counterintuitive but brilliant system called <em>Chaos Monkey</em>. Chaos Monkey will randomly kill services. It is trying to simulate, in the microcosm of a business day, the craziness that happens in the production macrocosm. Services die, servers fail, latency spikes, and networks partition. It might not be soon, but eventually it will happen. Better deal with it now, when people are at work to deal with it. Chaos Monkey encourages you to <strong>write your code to work in such a chaos-filled environment so that unexpected failures are a breeze.</strong> The idea is an instance of the more general principle of &quot;if something is important, deal with it sooner and more often&quot;.</p>
<p>There's something related to this idea of surfacing the errors early that I've been thinking about. It's about data. Have you ever written some classes and everything is well and good. And then after a while, you need to serialize that to disk or across a network. Now you have to come up with some format (maybe JSON or XML) to represent your class. Then, whenever the class changes, <strong>you have to remember to change the data format to keep them in sync</strong>. It's kind of painful!</p>
<p>Well, I'll tell you, that rarely happens in Clojure. Because in Clojure, you often <strong>start with data structures</strong>. Meaning, you're already thinking in data, modeling in data, and working in data. <strong>Serialization becomes a non-issue</strong>, because Clojure data structures come built in with <a href="https://github.com/edn-format/edn">readers and writers</a>. Just like causing errors to happen early because they will happen eventually, Clojure programmers code in data <em>in part</em> because you're going to need data (serialization and deserialization) eventually.</p>
<p>If this idea intrigues you, you may want to check out Clojure. Its <strong>data structures are cutting edge</strong>! Check out <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a> if you would like to get into functional programming using animations, exercises, and screencasts.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/3-things-java-can-steal-from-clojure">3 Things Java Programmers Can Steal from Clojure</a></li>
<li><a href="http://www.lispcast.com/annotated-clojure-core-reduce">Some Annotated clojure.core/reduce Examples</a></li>
<li><a href="http://www.lispcast.com/annotated-map">Annotated map</a></li>
<li><a href="http://www.lispcast.com/atom-problem">Atom code explanation</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/paper-metaphor">
            The Paper Metaphor
          </a>
        </h2>

        <div class="timestamp">
          February 27, 2015
        </div>

        
<p>Summary: <em>Functional programs follow a simple rule: never write on the same paper twice. Imperative programs are free to define their own rules. Both have interesting consequences.</em></p>
<p>I just read <a href="https://emily.st/2015/02/26/functional-programming-for-everyone-else/">Functional Programming for Everyone Else</a> by Emily St. It's a good read about the fundamental differences between Turing Machines and Lambda Calculus. Near the end, she mentioned this:</p>
<blockquote>
<p>I think of functional programs as ones which do their jobs without stopping to take notes along the way.</p>
</blockquote>
<p>That got me thinking of the metaphor of taking notes. It's an interesting metaphor, because as she mentions in the article, modern computers are based more on Turing Machines, with their tapes (notes), rather than Lambda Calculus. <strong>Lambda Calculus being abstract instead of mechanical (what instead of how), it doesn't show its work.</strong></p>
<p>In the spirit of more perspectives being better than fewer, I'd like to give my metaphor, inspired by idea above. <strong>Functional programs are those that have a very simple rule: never write on the same paper twice.</strong> In Turing Machine terms, it means never write on the same piece of tape twice. This rule is simple enough that you can build it into the compiler and runtime to enforce it. <strong>In programming language theory, we call this immutability.</strong> Once a paper is written on, it is immutable.</p>
<p>Imperative programs, on the other hand, don't have such a rule. They can write on any piece of paper, even write over or erase what's written. <strong>They rely on their own code to enforce rules</strong> for how to organize these pieces of paper so that it still makes sense. They might use locks, which are notoriously hard to get right.</p>
<p>The nice thing about functional programs is you get a nice <strong>record of what's happened</strong>. You can step through all of the intermediate work because it was never overwritten. It's like an <strong>artist keeping their old sketches</strong> that led up to their masterpiece. Imperative programs are like finding out that it was all done on the same canvas, art painted over art, irrevocably lost. There is no xray to uncover it.</p>
<p>The other nice thing about functional programs is <strong>multiple programs can share the same stack of paper</strong>. Since they're following a rule, they will never overwrite someone else's work. But imperative programs need to have <strong>complex coordination rules</strong> to make sure that they aren't writing on the same page at the same time, or overwriting something that someone else will need.</p>
<p>If you'd like to learn Functional Programming, I can recommend <a href="http://www.purelyfunctional.tv/intro-to-clojure">LispCast Introduction to Clojure</a>. It will teach you Functional Programming using Clojure, animations, and screencasts, along with many exercises.</p>
<div class="article-offer-box">
  
<a class="article-offer-box-link" href="http://www.purelyfunctional.tv/intro-to-clojure">
<div class="article-offer-box-text-wrapper">
      <div class="article-offer-box-text">
        <div class="article-offer-box-text-pitch">
          
Learn Functional Programming using Clojure with screencasts, visual aids, and interactive exercises
</div>
        <div class="offer-box-buy-button">
Learn more
</div>
      </div>
    </div>
    
<img class="article-offer-image" src="http://www.purelyfunctional.tv/img/intro-shot.png"> </a>
</div>





<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/object-function-duals-dispatch">Object-Oriented Dispatch is the Dual of Functional Dispatch</a></li>
<li><a href="http://www.lispcast.com/object-oriented-vs-functional-duals">Object-Oriented Programming is the Dual of Functional Programming</a></li>
<li><a href="http://www.lispcast.com/the-content-of-your-code">The Content of Your Code</a></li>
<li><a href="http://www.lispcast.com/the-world-is-mutable">But the World is Mutable</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/intro-clojure-test-peap">
            On sale now: Intro to clojure.test Early Access
          </a>
        </h2>

        <div class="timestamp">
          February 27, 2015
        </div>

        
<p>Summary: <em>LispCast Intro to clojure.test is on sale now for a limited time through the PurelyFunctional.tv Early Access Program.</em></p>
<p><strong>Update:</strong> <em>PEAP is now closed for Intro to clojure.test. Sign up below to find out when the finished product is published.</em></p>
<p>Folks, it's happening. I just opened up the <em>PurelyFunctional.tv Early Access Program</em> for <em>LispCast Into to clojure.test</em>. If you like to be <strong>on the cutting edge</strong> or get <strong>lots of access to the teacher</strong>, now's your chance. Open for 48 hours only!</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    
<img class="subscribe-form-image"
         src="http://www.purelyfunctional.tv/img/ring_spec_1_3.png" />
<div class="subscribe-form-text">
      <h3 class="subscribe-form-title">
        
Get free Clojure stuff and news on LispCast courses
</h3>
      <p class="subscribe-form-description">
        
Subscribe below to receive free Clojure materials, including a Ring Spec to hang on your wall and more as they come out. This is also the list where I announce launches of LispCast courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][2]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/purelyfunctional-tv-early-access-program">PurelyFunctional.tv Early Access Program</a></li>
<li><a href="http://www.lispcast.com/task-analysis">Use Task Analysis to Break a Skill Into Steps</a></li>
<li><a href="http://www.lispcast.com/new-course-format">New Course Format</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/purelyfunctional-tv-early-access-program">
            PurelyFunctional.tv Early Access Program
          </a>
        </h2>

        <div class="timestamp">
          February 25, 2015
        </div>

        
<p>Summary: <em>The PurelyFunctional.tv Early Access Program is a way to make courses in a more iterative and interactive way. I'll be publishing Intro to clojure.test this week under PEAP.</em></p>
<p>Computers and the Internet have allowed people to <strong>produce better products than has ever been done</strong>. Photography is better because of Flickr. Handmade knives are stronger and sharper than ever. Stone arrowhead making is better than ever. People are able to experiment, share their results, and learn the results of others faster than ever before, because <strong>the Internet allows them to communicate faster</strong>.</p>
<p>It's simply a matter of speed and accessibility. I want to bring that speed and accessibility to LispCast courses. I have been working hard on building a <strong>platform for me to develop courses iteratively</strong>. That means I can make them in smaller steps. The other piece is the feedback, where I ask you, my awesome customers, to borrow your brain for a bit. Talk about what works for you and what doesn't. I'll listen, answer questions, discuss them with you, and incorporate what I learn into the course.</p>
<center>
<img src="http://www.lispcast.com/img/PEAP.jpg" />
</center>

<p>Everyone wins. You get to <strong>learn what you need to learn faster</strong>, with <em>your</em> questions answered. And I get to make the course better for everyone. Seems like a good deal.</p>
<p>I'm creating what I'll call the <em>PurelyFunctional.tv Early Access Program</em>. It's simple. As soon as a course has a bit of content and interest, I'll post it up for sale. You get to download the course in a first draft. Let me know what questions you have, where you're having trouble, or things that were too easy. <strong>I'll continuously work those things in</strong>, and let you know when to download the new one.</p>
<p>I'll throw in another small benefit: if you're part of the PEAP, meaning your buy the course before it's finished, I'll <strong>put your name in a <em>Thank you</em> page</strong> in the course and on the course information page. Everyone who goes there will be able to see it.</p>
<p>To kick off the Program, I'm going to be publishing <a href="http://www.purelyfunctional.tv/intro-to-clojure-test">LispCast Intro to clojure.test</a>, in its current state, <em>this week</em>. <strong>Entry into the Program will be available for a limited time.</strong> So sign up below if you'd like to be a part of it. I'll send out an announcement with the instructions.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    
<img class="subscribe-form-image"
         src="http://www.purelyfunctional.tv/img/ring_spec_1_3.png" />
<div class="subscribe-form-text">
      <h3 class="subscribe-form-title">
        
Get free Clojure stuff and news on LispCast courses
</h3>
      <p class="subscribe-form-description">
        
Subscribe below to receive free Clojure materials, including a Ring Spec to hang on your wall and more as they come out. This is also the list where I announce launches of LispCast courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][2]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/intro-clojure-test-peap">On sale now: Intro to clojure.test Early Access</a></li>
<li><a href="http://www.lispcast.com/task-analysis">Use Task Analysis to Break a Skill Into Steps</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/hiccup-tips">
            Hiccup Tips
          </a>
        </h2>

        <div class="timestamp">
          February 24, 2015
        </div>

        
<p>Summary: <em>Hiccup is a Clojure DSL for generating HTML. If you're using it, you might like these tips.</em></p>
<p><a href="https://github.com/weavejester/hiccup">Hiccup</a> is a Clojure Domain Specific Language (DSL) for programmatically generating HTML. <strong>It's one of the three tools I recommend in <a href="http://www.lispcast.com/what-web-framework-should-i-use">my Clojure Web stack</a>.</strong> It's a thin layer over HTML, but oh, how I welcome that layer! The biggest win is that since it's an <em>internal</em> DSL, you can begin abstracting with functions in a way that you will never be able to, even in templating engines.</p>
<p>Hiccup is an example of a great Clojure DSL. It uses literal data structures pretty well, it's as or more readable than what it translates into, and, as a layer of indirection, solves a few sticky problems of HTML. If you don't know it, go check out the <a href="http://www.rkn.io/2014/03/13/clojure-cookbook-hiccup/">Clojure Cookbook recipe for Hiccup</a>. <strong>Hiccup might take some getting used to, but once you do, you'll appreciate it.</strong></p>
<p>This article will assume you are familiar with the syntax and want to up your game.</p>
<h3 id="cross-site-scripting-vulnerability">Cross-site Scripting Vulnerability</h3>
<p>Ok, <a href="http://www.lispcast.com/clojure-web-security#a3-cross-site-scripting-xssa3">this one is a pretty bad problem</a>. Hiccup generates Strings, just plain old Java strings. If you put a String in the body of a Hiccup tag, it will just concatenate it right in there, no questions asked. That's <strong>just asking to be exploited</strong>, because that String is going to be shipped off to the browser and rendered, scripts and all.</p>
<p><strong>Most templating libraries will default to escaping any String you pass them.</strong> The non-default, usually obviously marked alternative is to pass in a String unescaped. Hiccup got this backwards and it just sucks. It means you have to do extra work to be secure, and if you forget just once, your site is vulnerable.</p>
<p><strong>The fix:</strong> This is the work you have to do every time you're getting a String that could be from the &quot;outside&quot; (a form submission, API request, etc.). Normally, you'd do this:</p>
<pre><code>[:div content-of-div]</code></pre>
<p>That will work but it's unsafe. You should do this:</p>
<pre><code>[:div (h content-of-div)]</code></pre>
<p>That little <code>h</code> (<code>hiccup.core/h</code> to be exact) there means escape the String. It sucks, but that's how you do it in Hiccup. One day I want to write a secure fork of Hiccup.</p>
<h3 id="overloading-vectors">Overloading vectors</h3>
<p>One downside to Hiccup and any DSL that overloads the meaning of vectors is that <strong>vectors are no longer useful as sequences within Hiccup</strong>. They now mean &quot;start a new HTML tag&quot;. It's not a huge deal, but I've spent a lot of time debugging my code, only to realize that I was using a vector to represent a sequence. I use literal vectors everywhere else (because they're convenient and readable), but in Hiccup land they're wrong.</p>
<p><strong>The fix:</strong> You can't use a literal vector, but you can call <code>list</code> to create a list. Not as beautiful, but it is correct. Sometimes I will call <code>seq</code> on a return value to ensure that it's never a vector.</p>
<h3 id="multiple-tags">Multiple tags</h3>
<p>I don't know why this still happens, but it's common, so I'll mention it. Sometimes I'll be looking at the HTML output in a browser and I just can't find an element. It's gone. Reload, still not there. When I look through the code, the hiccup to generate the tag is <em>right there</em>! Why won't it render?</p>
<p>Well, long story short, it's because in Clojure, <strong>only the <em>last value</em> of a <code>let</code> or <code>fn</code> is returned</strong>. Doh! My missing element was being rendered then discarded.</p>
<pre><code>(defn list-with-header [header items]
  [:h3 header] ;; this header is missing
  [:ul
    (for [i items]
      [:li i])])</code></pre>
<p><strong>The fix:</strong> Wrap the two (or more) things in a list (not a vector!).</p>
<pre><code>(defn list-with-header [header items]
  (list ;; wrap in a list, not a vector
    [:h3 header] ;; now it&#39;s there
    [:ul
      (for [i items]
        [:li i])]))</code></pre>
<h3 id="hiccup-plays-nice-with-nil">Hiccup plays nice with <code>nil</code></h3>
<p>This one is just a little design touch with some perks, not a problem that it's solving. In Hiccup, the empty list renders nothing. This is extended to <code>nil</code> as well. A common thing in HTML is that you want to render a bunch of children in a parent tag, but <strong>you don't want the parent tag if the list is empty</strong>.</p>
<p>Standard constructs will render the parent tag:</p>
<pre><code>[:ul
  (for [i items]
    [:li i])]</code></pre>
<p>When <code>items</code> is empty, you still get <code>&lt;ul&gt;&lt;/ul&gt;</code>. This is a problem with lots of templating libraries.</p>
<p><strong>The fix:</strong> The fix in Hiccup is due to it playing nice with <code>nil</code>. Wrap the parent in a <code>when</code>:</p>
<pre><code>(when (seq items)
  [:ul
    (for [i items]
      [:li i])])</code></pre>
<p>It's not beautiful, but then again, you could be using HTML with Moustache.</p>
<h3 id="use-defn-for-snippet-abstraction">Use <code>defn</code> for snippet abstraction</h3>
<p><strong>HTML has no way to abstract.</strong> The crap you see is the crap you get. Many templating libraries have some kind of snippet concept, often referring to different files. Well, because Hiccup is just code inside of Clojure, you've got a better designed way of making reusable pieces of Hiccup.</p>
<p>Let's say I'm repeating something a lot:</p>
<pre><code>[:div
  [:ul
    (for [i list1]
      [:li i])]
  [:ul
    (for [i list2]
      [:li i])]
  [:ul
    (for [i list2]
      [:li i])]]</code></pre>
<p>That <code>ul</code> is basically the same three times.</p>
<p><strong>The fix:</strong> Standard functional abstraction. Pull out the repeated bit into a new, named function.</p>
<pre><code>(defn make-list [items]
  [:ul
    (for [i items]
      [:li i])])</code></pre>
<p>Now you can call it from inside of Hiccup:</p>
<pre><code>[:div
  (make-list list1)
  (make-list list2)
  (make-list list3)]</code></pre>
<h3 id="compiling-your-snippets">Compiling your snippets</h3>
<p>You may know this, but Hiccup is a <em>compiling</em> macro. That means it takes your literal vectors, maps, etc, and at <em>compile time</em>, generates code that will generate your HTML. All this means is that <strong>Hiccup is really fast</strong>, about as fast as concatenating strings can be.</p>
<p>But, because the Hiccup compiler doesn't do a full examination of your code, it can't compile everything. It inserts run time fallbacks for stuff it can't handle at compile time which will interpret it at run time. So, for instance, <strong>if you're calling a function that returns some Hiccup, it can't compile that automatically</strong>. It has to wait till the function returns to know what it is. That is, unless . . .</p>
<p><strong>The fix:</strong> The way to get Hiccup to compile something is with the <a href="http://weavejester.github.io/hiccup/hiccup.core.html#var-html"><code>hiccup.core/html</code></a> macro. That's the macro that does the compilation and it will do it anywhere. So if you've got code like this:</p>
<pre><code>(defn make-list [items]
  [:ul
    (for [i items]
      [:li i])])

(defn my-three-lists []
  [:div
    (make-list list1)
    (make-list list2)
    (make-list list3)])</code></pre>
<p>You should wrap the Hiccup form in its own compiler, like this:</p>
<pre><code>(defn make-list [items]
  (html
    [:ul
      (for [i items]
        [:li i])]))</code></pre>
<p>For this little example, it probably won't make a noticeable difference. But it can be significant for larger documents.</p>
<p>Just to note: the Hiccup compiler can understand <code>if</code> and <code>for</code> forms, so there's no need to wrap them in the compiler. No harm, though, if you do.</p>
<h3 id="autoterminating">Autoterminating</h3>
<p>Just a good thing to know about HTML.</p>
<p>Did you know that this is not legal HTML?</p>
<pre><code>&lt;script /&gt;</code></pre>
<p>It's true. A <code>script</code> tag can't be self-closing.</p>
<p>There's all sort of silly rules in HTML like this. And then there's XML mode versus HTML mode. We are lucky: <strong>Hiccup does all of this for you</strong>, so you don't have to wade through the HTML spec(s!) looking for why something won't render in IE7.</p>
<p><strong>The fix:</strong> <code>hiccup.core/html</code> takes a map of options as the first argument (it's optional). If you pass in a <code>:mode</code> option, it will set the correct HTML mode. The various modes unfortunately are incompatible. There are three modes, <code>:xml</code>, <code>:html</code>, and <code>:xhtml</code>. The default is <code>:xhtml</code>.</p>
<h3 id="idclass-dsl">Id/class DSL</h3>
<p>Hiccup is a DSL. And it has its own <strong>sub DSL for HTML ids and classes</strong>. It's similar to CSS selectors.</p>
<p>Let's say you have a <code>div</code> like this:</p>
<pre><code>[:div
  {:id &quot;main-content&quot;
   :class &quot;blue-background green-border&quot;}
  (h &quot;Here&#39;s some content.&quot;)]</code></pre>
<p>Well, Hiccup lets you make that shorter and easier to read.</p>
<p><strong>The fix:</strong> Use the id/class DSL:</p>
<pre><code>[:div#main-content.blue-background.green-border
  (h &quot;Here&#39;s some content&quot;)]</code></pre>
<p>Here's how it works. Every element has an optional id and zero or more classes. After the tag name (<code>div</code> here), you can put the id after a <code>#</code>. Then list your classes starting with a <code>.</code> each. Omit the <code>#</code> if there's no id. Ditto for the <code>.</code> if there's no class. Oh, and the id must come first. That will get converted to the id and class attributes you want. Also, these will conflict with attributes in the map, so <strong>choose one or the other, not both</strong>.</p>
<h3 id="generating-hiccup-from-html">Generating Hiccup from HTML</h3>
<p>Last thing, I promise!! Sometimes you have some HTML that someone gave you and <strong>you want to Hiccupify it so you can just stick it into your code</strong>. Manually doing that is kind of tedious. Luckily, there's a solution our there for you.</p>
<p><strong>The fix:</strong> <a href="https://github.com/weavejester/hiccup/wiki/Converting-html-to-hiccup">This page</a> lists three options for outputting HTML from Hiccup. I have personally used <a href="https://github.com/hozumi/hiccup-bridge">Hiccup-bridge</a>. It does a good job (and it even goes both ways). You call it like this:</p>
<pre><code>lein hicv 2clj hello.html</code></pre>
<p>That will output <code>hicv/hello.clj</code> in hiccup format. Pretty rocking when you need it.</p>
<h3 id="conclusion">Conclusion</h3>
<p>Well, there you go. My Hiccup tips. <strong>Hiccup is pretty nice for templating.</strong> I recommend using it (or my future secure fork) in your web projects. If you'd like to learn more Hiccup and how to build web apps in Clojure, please check out [Lispcast Web Development in Clojure][webdev]. It's a video course teaching just that. All you need to know is Clojure and HTML.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get a Free Ring Spec to hang on your wall
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/ring_spec_1_3.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of a Ring Spec to hang on your wall. If you are programming in Ring (covered in the videos), you'll find it very useful as a reference. You'll also hear about exclusive previews and discounts of other video courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][4]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/cascading-separation-abstraction">Separation, Abstraction, and Cascading in CSS</a></li>
<li><a href="http://www.lispcast.com/clojure-web-security">Clojure Web Security</a></li>
<li><a href="http://www.lispcast.com/json-serialization-api-clojure">JSON Serialization for APIs in Clojure</a></li>
<li><a href="http://www.lispcast.com/parts-of-ring">The Parts of Ring</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/announcing-lispcast-intro-to-clojure-test">
            Announcing: LispCast Intro to clojure.test
          </a>
        </h2>

        <div class="timestamp">
          February 23, 2015
        </div>

        
<p>Summary: <em>The next course will be about clojure.test. Sign up to be notified when it is published.</em></p>
<p>Last week I mentioned my new course format, and I also teased at more announcements. Well, <strong>it's a course on <code>clojure.test</code></strong>, the Clojure testing library that comes built in with Clojure.</p>
<p>I chose <code>clojure.test</code> as my next topic for a number of reasons. The main reason is that I think it's a good idea to <strong>begin with the fundamentals</strong>. I have a long list of topics, and testing was as good as any. It's also a video that <strong>opens doors to other topics</strong>, including testing using <a href="https://github.com/marick/Midje">Midje</a>, <a href="https://github.com/clojure/test.check">test.check</a>, and <a href="http://www.infoq.com/presentations/Simulation-Testing">simulation testing</a>.</p>
<p>The course is called <em>LispCast Intro to clojure.test</em>. <code>clojure.test</code> is not a big library, but it's important to know. This course will teach you how to use the library and conventions around testing that might not be so obvious. For instance, how to name your testing namespace.</p>
<p>The course is built in the new format, and it's shorter than my previous courses. It's common for someone to tell me how much they like my courses. My first question is always &quot;Did you finish them?&quot;. And it disturbs me how many people say &quot;no&quot;. <strong>They like the course but they don't finish.</strong> So <strong>I'm doing smaller courses</strong> that are easier to fit into your day and finish. I expect to make more, smaller courses from now on. And <em>Intro to clojure.test</em> will be the first.</p>
<p>And now that that announcement is done, I must tease you with just <strong>one more announcement coming later this week</strong>. If you don't want to miss it, <strong>sign up for the mailing list below</strong>. You'll be the first one to know when <code>clojure.test</code> is coming out and what that cliffhanger announcement is.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    <h3 class="subscribe-form-title">
      
Get a Free clojure.test Cheatsheet
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/clojure.test cheatsheet.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of the clojure.test cheatsheet. If you write Clojure or ClojureScript, this cheatsheet contains the most important functions in a handy format. I've spent a lot of time formatting and annotating the most used functions and macros from clojure.test so that they fit onto one page and everything is easy to understand.
</p>
      
<input id="mce-EMAIL.email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][32]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/clojure-test-launch">LispCast Intro to clojure.test</a></li>
<li><a href="http://www.lispcast.com/new-course-format">New Course Format</a></li>
<li><a href="http://www.lispcast.com/clojure-database-test-faster">How I made my Clojure database tests 5x faster</a></li>
<li><a href="http://www.lispcast.com/clojure-test-cheatsheet">clojure.test cheatsheet</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/new-course-format">
            New Course Format
          </a>
        </h2>

        <div class="timestamp">
          February 20, 2015
        </div>

        
<p>Summary: <em>LispCast video courses have a new, interactive format. It's easier for me to make courses (read: more, faster) and it's a better experience for learners.</em></p>
<p>I've released <a href="http://www.purelyfunctional.tv/">3 Clojure LispCast video courses</a>. They've been selling okay (many thanks to my beautiful buyers and other supporters!), but I need more videos to bring it to a full time wage. After it took 9 months to do the <code>core.async</code> videos<sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup>, I decided to take a step back and <strong>optimize my process</strong>.</p>
<p>The first thing I wanted to do was to be able to <strong>generate the videos programmatically</strong>. Editing video takes a long time, and I knew that most of what I did during editing was automatable. That would eliminate hours of work per hour of video.</p>
<p>I began coding up some <strong>routines to compose videos functionally</strong> (inspired by the <a href="http://conal.net/papers/">functional animation work by Conal Elliott</a>). It worked really well. I could code up simple animations, concatenate videos, and rerender a preview very quickly. This combined with the Emacs Lisp scripts I have for automatically recording the &quot;typing&quot; portions of the videos, I was ready to code up the video.</p>
<p>But I eventually scrapped the idea. <strong>Nothing wrong with the idea, but I found something better.</strong> <a href="https://twitter.com/rubygeek">Nola Stowe</a> suggested I make the video course viewable in a browser. That means I have HTML and Javascript. Not only does it let me have a bit of interactivity (such as pausing at the right place automatically), it also enhances the experience a lot. Table of contents, links, smaller download, etc. So I got to work on an in-browser course.</p>
<p>I'm working on the next LispCast course, in the new format. It's already way faster to make, and the viewer experience is amazing. It combines video, interactive exercises, animations, and more into one package. I can't wait to show the world. I've got a lot of great things to announce soon, so <strong>sign up below</strong> to get updates as they come out.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
    
<img class="subscribe-form-image"
         src="http://www.purelyfunctional.tv/img/ring_spec_1_3.png" />
<div class="subscribe-form-text">
      <h3 class="subscribe-form-title">
        
Get free Clojure stuff and news on LispCast courses
</h3>
      <p class="subscribe-form-description">
        
Subscribe below to receive free Clojure materials, including a Ring Spec to hang on your wall and more as they come out. This is also the list where I announce launches of LispCast courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][2]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/intro-clojure-test-peap">On sale now: Intro to clojure.test Early Access</a></li>
<li><a href="http://www.lispcast.com/announcing-lispcast-intro-to-clojure-test">Announcing: LispCast Intro to clojure.test</a></li>
<li><a href="http://www.lispcast.com/clojure-test-launch">LispCast Intro to clojure.test</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>It took 9 months calendar time. It's a part time endeavor to begin with, and I had a few false starts and a few breaks. But mostly it's just a labor-intensive process.<a href="#fnref1"></a></p></li>
</ol>
</div>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/parts-of-ring">
            The Parts of Ring
          </a>
        </h2>

        <div class="timestamp">
          February 18, 2015
        </div>

        
<p>Summary: <em>Ring, the Clojure Web library, defines three main concepts that you use to construct web applications.</em></p>
<p>Ring is the center of the Clojure web universe. It's not the only option in town, but the other options refer to Ring to say how they are different. <strong>Understanding Ring will help you learn any other web system in Clojure.</strong></p>
<p>Ring has three main concepts that work together to build a web application.</p>
<ol style="list-style-type: decimal">
<li>Adapters</li>
<li>Handlers</li>
<li>Middleware</li>
</ol>
<h3 id="adapters">Adapters</h3>
<center>
<img src="http://www.lispcast.com/img/adapters.jpg" />
</center>

<p>I like to think of Ring Adapters as plug adapters. When you go to a different continent, you often have to adapt the holes in the electical outlet to fit your cords. Ring Adapters let you convert different web server implementations into a standard Ring Request/Response format. That way, all of your code is standardized to the Ring format. <strong>Your code can travel into any kind of server as long as an adapter exists.</strong></p>
<p>There are Ring Adapters for many existing servers.</p>
<ul>
<li><a href="https://github.com/ring-clojure/ring/tree/master/ring-jetty-adapter">Jetty</a></li>
<li><a href="https://github.com/datskos/ring-netty-adapter">Netty</a></li>
<li><a href="https://github.com/mikejs/ring-mongrel2-adapter">Mongrel 2</a></li>
<li><a href="https://github.com/mmcgrana/ring-httpcore-adapter">Apache HttpCore</a></li>
</ul>
<p>And more.</p>
<h3 id="handlers">Handlers</h3>
<center>
<img src="http://www.lispcast.com/img/handler.png" />
</center>

<p>Handlers do the work of your application. They are like the computer. They are just Clojure functions. HTTP is basically a request/response protocol that maps well to functions, which are just a protocol from argument to return value. <strong>Handlers take a Ring Request and return a Ring Response.</strong> They should do whatever logic is necessary for your application.</p>
<h3 id="middleware">Middleware</h3>
<center>
<img src="http://www.lispcast.com/img/middleware.jpg" />
</center>

<p>Middleware are the voltage converters. Here in North America, wall sockets run at 120 volts, which is different from almost everywhere. In order to run an appliance from elsewhere, you not only need to adapt the socket, you also need to transform the current to a compatible voltage. <strong>Middleware are often used to convert the incoming request in some standard way.</strong> For instance, there is middleware to parse a JSON body into a Clojure map and store it away in the request.</p>
<p>The transformer also &quot;cleans up&quot; the current. Voltage spikes are evened out so they never get to the computer. <strong>Middleware can similarly protect a handler by making sure the browser is logged in.</strong></p>
<p>The analogy kind of breaks down, because middleware can do work (like the computer). Middleware are the hardest part of the Ring idea. They're not hard because the concept is hard. They're hard because <strong>they require design decisions</strong>. If all you had were Adapters and Handlers, you wouldn't have to think about where to put your logic. It would all go in the Handlers.</p>
<p>But there would be a lot of duplicated logic in your handlers. <strong>Authentication, routing, content-type switching, all of these things are done the same way over and over.</strong> It's the perfect problem for a little higher order programming. That's essentially what Middleware is.</p>
<p>Ring Middleware are functions that take a Handler and return a new Handler. Since Handlers are functions, <strong>Middleware are higher-order functions</strong>. The transformer on your computer's power cord takes a machine that requires a certain current and turns it into a machine that takes a different current. Middleware are used to do all sorts of things.</p>
<p>So, for instance, there's a Middleware called <a href="https://github.com/magnars/prone">Prone</a> that captures exceptions in the Handler and displays them in a nice format. Prone is a function that takes a Handler and returns a new Handler that catches exceptions and returns a different Ring Response in that case. Or you have Middleware that handle session cookies. <strong>The Middleware take a Handler and return a new Handler that understands sessions.</strong></p>
<p>My recommendation for what to put in Middleware versus what to put in Handlers is simplest to explain with a graph.</p>
<center>
<img src="http://www.lispcast.com/img/handler-middleware.png" />
</center>

<p>Along the x-axis, we have logic that ranges from HTTP logic (handling header values, query params, etc.) to business logic (which bank account to withdraw from). Along the y-axis, we have how unique the logic is, ranging from highly duplicated to custom. <strong>These are the two axes I use to figure out whether it should be in the Handler or the Middleware.</strong></p>
<p>The clear cases are easy. In the upper right corner (red dot), where it's custom business logic, <strong>it's definitely in the Handler</strong>. In the lower left (blue dot), where it's duplicated HTTP logic, I prefer Middleware. <strong>The hard part is in the middle.</strong> Somewhere between those two, there's a fine line where a <strong>case-by-case decision is required</strong>.</p>
<h3 id="conclusions">Conclusions</h3>
<p>Ring is great because it requires so few concepts to capture so much of HTTP. But it's not everything. Standard Ring does not support WebSockets, for instance. Small adaptations are necessary. In general, I think this is a great abstraction. <strong>And Ring is so central to Clojure on the Web, it's important to know.</strong></p>
<p>If you want to learn more about Ring and how to construct web applications in Clojure, you should check out <a href="http://www.purelyfunctional.tv/web-dev-in-clojure">LispCast Web Development in Clojure</a>. It's a video course designed to guide you through the major libraries used for web development. <strong>You'll learn how to build Clojure web applications from existing and custom parts.</strong> You build Middleware to make your application adapt to browser limitations. And if you sign up below, you'll get a handy Ring Spec reference sheet, which specifies the Request and Response formats.</p>
<div class="subscribe-form-wrapper">
  <form class="subscribe-form"
        action="https://lispcast.us4.list-manage.com/subscribe/post?u=a33b5228d1b5bf2e0c68a83f4&amp;id=d0f96276d9"
        method="POST"
        name="mc-embedded-subscribe-form"
        novalidate="true">
      <h3 class="subscribe-form-title">
        
Get a Free Ring Spec to hang on your wall
</h3>
    
<img class="subscribe-form-image"
         src="http://www.lispcast.com/img/ring_spec_1_3.png">
<div class="subscribe-form-text">
      <p class="subscribe-form-description">
        
Subscribe below to receive a free copy of a Ring Spec to hang on your wall. If you are programming in Ring (covered in the videos), you'll find it very useful as a reference. You'll also hear about exclusive previews and discounts of other video courses.
</p>
      
<input id="mce-EMAIL"
             class="email-field"
             type="email"
             value=""
             placeholder="Email"
             name="EMAIL"> <input type="hidden"
             name="group[18565][4]"
             value="1">
<div style="position: absolute; left: -5000px;">
        
<input type="text"
               name="b_a33b5228d1b5bf2e0c68a83f4_d0f96276d9">
</div>
      
<input class="subscribe-button"
             type="submit"
             value="Get it"
             name="subscribe">
<div class="field-text-text2">
        
No spam. Ever.
</div>
    </div>
  </form>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/cascading-separation-abstraction">Separation, Abstraction, and Cascading in CSS</a></li>
<li><a href="http://www.lispcast.com/clojure-web-security">Clojure Web Security</a></li>
<li><a href="http://www.lispcast.com/hiccup-tips">Hiccup Tips</a></li>
<li><a href="http://www.lispcast.com/json-serialization-api-clojure">JSON Serialization for APIs in Clojure</a></li>
</ul>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <article class="article">
        <h2 class="article-title-wrapper">
          <a class="article-title"
             href="/object-oriented-vs-functional-duals">
            Object-Oriented Programming is the Dual of Functional Programming
          </a>
        </h2>

        <div class="timestamp">
          February 08, 2015
        </div>

        
<p>Summary: <em>Object-Oriented Programming is often shown in contrast to Functional Programming. But they are so exactly opposite that they are duals, and so equivalent in important ways. Which one to use should be left up to the programmer, as is done in Clojure and Javascript.</em></p>
<p>Let's take a quick look at programming from an interesting perspective. Let's say that programs are divided into <em>code</em> and <em>data</em>. <sup><a href="#fn1" class="footnoteRef" id="fnref1">1</a></sup> <strong>These are the two main axes</strong>: structuring code and structuring data.</p>
<p>Now, let's design a language. First decisions: <strong>which axis is primary, which is secondary</strong>?</p>
<center>

<table>
<thead>
<tr class="header">
<th align="left">Style</th>
<th align="left">Data</th>
<th align="left">Code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">OOP</td>
<td align="left">Primary</td>
<td align="left">Secondary</td>
</tr>
<tr class="even">
<td align="left">FP</td>
<td align="left">Secondary</td>
<td align="left">Primary</td>
</tr>
</tbody>
</table>
</center>

<p>In an OOP-style approach, we have <strong>a pointer to an object which is the <em>data</em></strong>. And the data also tells you where the <em>code</em> is to access it (methods in the vtable). An FP-style approach will make <strong>functions (<em>code</em>) primary</strong>, with <em>data</em> referred to by the closures (the captured lexical environment).</p>
<p>I'm positive I'm not the first person to remark on this, but I think it's pretty cool that <strong>they are duals of each other</strong>. <strong>A simple transformation will switch one in the table with the other.</strong></p>
<p>Perhaps the next obvious question is &quot;which one is better?&quot;. Many arguments about OOP vs FP focus on this choice, about which axis should be primary. Because a compiler could easily transform between them, the decision is not quite so important as we might think at first. I think that <strong>a language should make both available and let the programmer choose</strong>. The programmer is then free to choose whichever best models the problem.</p>
<p>For instance, in Clojure, fns are closures, so they are really FP-style -- code meant to be executed which happens to refer to some data. But collections are data which refer to code which knows how to access the data. <strong>Both coexist quite cooperatively.</strong></p>
<p>And <strong>Clojure gives you, the programmer, ways of expressing both styles</strong>. When you want to create some code to be executed, <code>fn</code> lets you define lexical closures. But sometimes you want to make a new data structure which acts like others. For instance, a new type of sequence. <code>deftype</code> lets you define data with interface and protocol implementations. I use both <code>fn</code> and <code>deftype</code> very often.</p>
<p>Interestingly, <strong>Javascript gives you these two options as well.</strong> <code>function</code> defines lexical closures, making code primary. But very often you define an object which contains (or refers to) data and secondary accessor functions. It's one of the nicer things about Javascript, included in <a href="http://www.amazon.com/dp/0596517742">Javascript, the Good Parts</a>.</p>
<p><strong>How does your language prioritize these two axes?</strong> Is there a way to choose which to use to best implement your design? If you're interested in this kind of topic, you would probably enjoy the <a href="http://www.clojuregazette.com/">Clojure Gazette</a>. It's a weekly newsletter filled with content to inspire Clojure programmers. It's completely free and it's easy to unsubscribe.</p>
<div class="article-cg-box">
  <h3>
You may like the Clojure Gazette
</h3>
  <p class="article-cg-box-text">
    
For more inspiration, history, interviews, and trends of interest to Clojure programmers, get the free Clojure Gazette.
</p>

<p><a href="http://www.clojuregazette.com/"
     class="article-cg-box-button js-clojuregazette">Learn More</a></p>

<p>
    
Clojure pulls in ideas from many different languages and paradigms, and also from the broader world, including music and philosophy. The Clojure Gazette shares that vision and weaves a rich tapestry of ideas from the daily flow of library releases to the deep historical roots of computer science.
</p>
</div>



<h3 id="you-might-also-like">You might also like</h3>
<ul>
<li><a href="http://www.lispcast.com/object-function-duals-dispatch">Object-Oriented Dispatch is the Dual of Functional Dispatch</a></li>
<li><a href="http://www.lispcast.com/paper-metaphor">The Paper Metaphor</a></li>
<li><a href="http://www.lispcast.com/the-content-of-your-code">The Content of Your Code</a></li>
<li><a href="http://www.lispcast.com/the-world-is-mutable">But the World is Mutable</a></li>
</ul>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>I don't want to go down the code-is-data rabbit hole. Let's stick to one floor in the tower of languages model.<a href="#fnref1"></a></p></li>
</ol>
</div>


        <div class="endmark">
          <a class="endmark-link"
             href="/">
            <img class="endmark-lambda"
                 src="/img/dot.png" />
          </a>
        </div>

      </article>


      <div class="notes">

      </div>

    </div>

    <footer class="footer-banner">
      <a class="footer-previous"
         href="page10.html">
        previous
      </a>
      <a class="footer-next"
         href="page8.html">
        next
      </a>
    </footer>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.0/lodash.min.js"></script>



    <script>

      document.write('<script src="https://oberon.herokuapp.com/cookie/get.js?_=' + (new Date()).getTime() + '"><\/script>');

          if(window.oberon && mixpanel) {
          if(document.cookie.indexOf('oberon-id') < 0) {
                                                    var expires = (new Date((new Date().getTime() + 1000*60*60*24*365*10))).toUTCString();
                                                    mixpanel.alias(window.oberon.id);
                                                    document.cookie = "oberon-id=" + window.oberon.id + ";expires=" + expires + ";path=/";
                                                    }
                                                    mixpanel.identify(window.oberon.id);
                                                    }

                                                    mixpanel.register({URL: window.location.pathname,
                                                    Title: $("title").text()});

                                                    mixpanel.track("Page Visit");

                                                    mixpanel.track_forms('.gazette-form', 'Submit Clojure Gazette');
                                                    mixpanel.track_forms('.subscribe-form', 'Subscribe');

                                                    mixpanel.track_links('a.homepage-offer-box-link',
                                                    'Click PurelyFunctional.tv',
                                                    function(e) {
                                                    return {ToURL: $(e).prop('href')};
                                                    });

                                                    mixpanel.track_links('a.js-clojuregazette',
                                                    'Click Clojure Gazette',
                                                    function(e) {
                                                    return {ToURL: $(e).prop('href')};
                                                    });

                                                    $('input[name=EMAIL]').change(function() {
                                                    var i = $(this);
                                                    window.o_email = i.val();
                                                    });

                                                    $('form').submit(function() {
                                                    if(window.o_email)
                                                    mixpanel.people.set({"$email": window.o_email});
                                                    });

                                                    </script>
      <script src="/js/mylibs/annotated-code.js"></script>
      <script src="/js/libs/codemirror.js"></script>
      <script src="/js/mylibs/feedback.js"></script>

  </body>
</html>
